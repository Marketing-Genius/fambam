<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam ¬∑ Dinner Planner v2.5.4</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<!-- Universal wallpaper -->
<link rel="stylesheet" href="wallpaper.css">
<script src="wallpaper.js" defer></script>

<!-- Shared app styles -->
<link rel="stylesheet" href="fambam.css">

<script>
/* THEME BOOT (mode + accent + auto logo swap) */
(function () {
  var DARK_SRC='fambam.png', LIGHT_SRC='fambam2.png';
  function findLogo(){
    return document.getElementById('logoImg')
        || document.querySelector('.brand img')
        || document.querySelector('img[alt="Fambam"]')
        || null;
  }
  function applyTheme(t){
    var mode = (t && t.mode==='light')?'light':'dark';
    var accent = (t && t.accent) || '#22d3ee';
    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.style.setProperty('--accent', accent);
    var meta=document.querySelector('meta[name="theme-color"]');
    if(meta) meta.setAttribute('content', mode==='light'?'#f2efe7':'#0f172a');
    var logo=findLogo();
    if(logo){
      var url = new URL(logo.src, location.href);
      var base = url.pathname.replace(/[^/]+$/, '');
      logo.src = (mode==='light') ? (base+LIGHT_SRC) : (base+DARK_SRC);
      var a = logo.closest('a'); if(a && !a.getAttribute('href')) a.href='./index.html';
    }
  }
  function boot(){
    try{ applyTheme(JSON.parse(localStorage.getItem('ui:theme')||'{}')); }
    catch{ applyTheme({mode:'dark',accent:'#22d3ee'}); }
  }
  boot();
  document.addEventListener('DOMContentLoaded', boot);
  addEventListener('storage', e=>{ if(e.key==='ui:theme') try{applyTheme(JSON.parse(e.newValue||'{}'))}catch{}; });
})();
</script>

<style>
:root{
  --panel:#111827; --card:#0b1224; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
  --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
  --ring:#334155; --ring-soft:#1f2937;
  --wallpaper:url(''); --wallpaper-shift:40%;
}
html[data-theme="light"]{
  --panel:#f2efe7; --card:#fffdf7; --muted:#556070; --text:#0f1623;
  --shadow:0 10px 28px rgba(0,0,0,.08);
  --ring:#e3ded4; --ring-soft:#ebe6db;
}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text); background:#404c69; -webkit-tap-highlight-color:transparent; touch-action:manipulation; overflow-x:hidden;
}
/* Wallpaper layers */
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background-image: var(--wallpaper); background-size:cover; background-repeat:no-repeat; background-position:center var(--wallpaper-shift);
}
body::after{
  content:""; position:fixed; inset:0; z-index:-1; background:rgba(64,76,105,.9); pointer-events:none;
}

/* Shell */
.app{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:16px;grid-template-rows:auto auto 1fr auto}
.panel{background:var(--panel);border:1px solid var(--ring);box-shadow:var(--shadow);border-radius:var(--radius);padding:14px}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
.h-left{display:flex;align-items:center;gap:14px;min-width:0}
.brand{display:flex;align-items:center;gap:10px}
.brand img{height:38px;display:block;cursor:pointer}
.title{font-weight:800}
.title .small{font-weight:600;font-size:.88rem;color:var(--muted)}
.menu-wrap{position:relative}
.hamburger{font:inherit;cursor:pointer;background:var(--card);border:1px solid var(--ring);border-radius:12px;color:var(--text);padding:10px 12px}
.menu-dropdown{position:absolute;right:0;top:110%;min-width:220px;z-index:50;background:var(--panel);border:1px solid var(--ring);border-radius:12px;box-shadow:var(--shadow);padding:6px;display:none}
.menu-dropdown.open{display:block}
.menu-item{display:block;width:100%;text-align:left;padding:10px 12px;border:none;background:transparent;color:var(--text);border-radius:10px;cursor:pointer}
.menu-item:hover{background:var(--card)}

/* Week bar */
.weekbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.weekbtn{background:var(--card);border:1px solid var(--ring);color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
.weekbtn.active{outline:2px solid var(--accent); background:#132135}
.navbtn{background:var(--card);border:1px solid var(--ring);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer}
.weekspacer{flex:1}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--card);border:1px solid var(--ring);color:var(--muted)}

/* Layout */
.grid{display:grid;gap:14px;grid-template-columns:1fr 1fr}
@media(max-width:900px){.grid{grid-template-columns:1fr}}

/* Left: editor */
.card{background:var(--panel);border:1px solid var(--ring-soft);border-radius:16px;padding:12px}
.card h3{margin:0 0 8px 0}
.card .topline{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
.row{display:grid;grid-template-columns:92px 1fr 1fr;gap:10px;align-items:center}
@media(max-width:720px){.row{grid-template-columns:88px 1fr}}
.tile-select{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--ring);border-radius:14px;padding:10px 12px;min-height:54px}
.tile-select select{width:100%} /* full width selects */
.row + .row{margin-top:6px}
.row.dessert{grid-template-columns:92px 1fr;margin-top:14px}

/* Right: recipes + groceries */
.rgrid{display:grid; gap:10px; grid-template-columns:1fr; }
.rcard{background:var(--panel);border:1px solid var(--ring-soft);border-radius:16px;padding:12px;display:grid;gap:10px}
.section{background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:10px}
.linkbar{display:flex;flex-wrap:wrap;gap:8px}
.a-btn, .btn{display:inline-flex;align-items:center;gap:6px;background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:8px 10px;color:var(--text);text-decoration:none;cursor:pointer}
.grobox{background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:10px;max-height:220px;overflow:auto;white-space:pre-wrap}

/* Modals (fixed overlay) */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.modal{width:min(900px,100%);max-height:90vh;display:flex;flex-direction:column;background:var(--panel);border:1px solid var(--ring);border-radius:16px;box-shadow:var(--shadow)}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--ring-soft);position:sticky;top:0;background:inherit}
.modal .body{padding:12px 14px;display:grid;gap:12px;overflow:auto;max-height:70vh}
.modal .footer{padding:12px 14px;border-top:1px solid var(--ring-soft);display:flex;justify-content:flex-end;gap:10px}
.list{display:grid;gap:8px}
.item{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:8px}
input[type="text"],textarea,select{background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:8px 10px;color:var(--text);font:inherit}
textarea{min-height:88px;resize:vertical}
.hint{opacity:.8;font-size:.9rem;text-align:center}
.version{opacity:.6;font-size:.8rem;margin-top:6px}

/* Ratings modal */
.kidrow{display:flex;align-items:center;justify-content:space-between;gap:10px;background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:10px}
.starsel{font-size:22px; letter-spacing:2px; cursor:pointer}
.starsel span{opacity:.55}
.starsel span.on{opacity:1}
.face{width:38px;height:38px;border-radius:50%;background:var(--card);display:grid;place-items:center;font-weight:800;border:1px solid var(--ring);overflow:hidden}
.face img{width:100%;height:100%;object-fit:cover}
</style>

<script>
(function headerBoot(){
  function apply(){
    try{
      const on = JSON.parse(localStorage.getItem('ui:headerFloat') || 'false') ? true : false;
      document.body && document.body.classList.toggle('header-float', on);
    }catch(_){}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', apply, {once:true});
  } else { apply(); }
  addEventListener('storage', (e)=>{ if (e.key==='ui:headerFloat') apply(); });
})();
</script>
  
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="panel header app-header">
      <div class="h-left">
        <a href="./index.html" class="brand" title="Home">
          <img id="logoImg" src="fambam.png" alt="Fambam">
        </a>
        <div class="title">
          <div style="font-size:1.6rem">Dinner Planner</div>
          <div class="small">Plan dinners for the week. Templates, groceries & sharing included.</div>
        </div>
      </div>
      <div class="menu-wrap">
        <button id="btnHamburger" class="hamburger" aria-haspopup="true" aria-expanded="false" aria-controls="menuDropdown">‚ò∞</button>
        <div id="menuDropdown" class="menu-dropdown" role="menu" aria-hidden="true">
          <button class="menu-item" data-action="templates">Templates</button>
          <button class="menu-item" data-action="groceries">Groceries</button>
          <button class="menu-item" data-action="shareGro">Share Groceries</button>
          <button class="menu-item" data-action="sharePlan">Share Plan</button>
          <button class="menu-item" data-action="manage">Manage</button>
          <button class="menu-item" data-action="reset">Reset Week</button>
        </div>
      </div>
    </header>

    <!-- Week nav -->
    <section class="panel weekbar" id="weekbar">
      <button id="wPrev" class="navbtn" title="Previous week">‚óÄ</button>
      <div id="weekDays" style="display:flex;gap:8px;flex-wrap:wrap"></div>
      <button id="wToday" class="navbtn">Today</button>
      <button id="wNext" class="navbtn" title="Next week">‚ñ∂</button>
      <div class="weekspacer"></div>
      <div class="badge">Week of <b id="weekLabel">‚Äî</b></div>
    </section>

    <section class="grid">
      <!-- Left: editor -->
      <div class="card">
        <div class="topline">
          <h3 style="margin-bottom:0">Selections</h3>
          <div class="linkbar">
            <button id="btnRatings" class="btn">Ratings</button>
            <button id="btnNotes" class="btn">Notes</button>
          </div>
        </div>

        <div class="row">
          <div class="muted" style="color:var(--muted)">Kids</div>
          <div class="tile-select"><select id="selKidsMain"></select></div>
          <div class="tile-select"><select id="selKidsSide"></select></div>
        </div>

        <div class="row">
          <div class="muted" style="color:var(--muted)">Parents</div>
          <div class="tile-select"><select id="selParMain"></select></div>
          <div class="tile-select"><select id="selParSide"></select></div>
        </div>

        <div class="row dessert">
          <div class="muted" style="color:var(--muted)">Dessert</div>
          <div class="tile-select"><select id="selDessert"></select></div>
        </div>
      </div>

      <!-- Right: Recipes + Groceries -->
      <div class="rgrid">
        <div class="rcard">
          <div style="font-weight:800">Recipes</div>
          <div class="section">
            <div style="font-weight:700" id="kidsRecTitle">Kids recipes</div>
            <div class="linkbar" id="kidsLinks"></div>
          </div>
          <div class="section">
            <div style="font-weight:700" id="parRecTitle">Parents recipes</div>
            <div class="linkbar" id="parLinks"></div>
          </div>
          <div class="small" style="opacity:.75">Opens in your browser (Allrecipes, YouTube).</div>
        </div>
        <div class="rcard">
          <div style="font-weight:800">Groceries</div>
          <div id="groPreview" class="grobox">‚Äî</div>
          <div class="linkbar">
            <button id="openGroModal" class="btn">Open full list</button>
            <button id="groCopyInline" class="btn">Copy</button>
            <button id="groDownloadInline" class="btn">Download .txt</button>
          </div>
        </div>
      </div>
    </section>

    <div class="hint">
      Works offline. Data stays on this device (local only).
      <div class="version">Dinner Planner v2.5.4</div>
    </div>
  </div>

  <!-- Manage Modal -->
  <div class="modal-backdrop" id="manageModal" aria-hidden="true" role="dialog" aria-labelledby="manageTitle">
    <div class="modal">
      <header>
        <div id="manageTitle" style="font-weight:800">Manage Menus</div>
        <button id="manageClose" class="btn">‚úñ</button>
      </header>
      <div class="body">
        <div style="font-weight:700">Food Options (for Main & Side)</div>
        <div id="foodList" class="list"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="newFood" type="text" placeholder="Add food (e.g., üçï Pizza)"/>
          <button id="addFood" class="btn">Add</button>
        </div>

        <div style="font-weight:700">Dessert Options</div>
        <div id="dessertList" class="list"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="newDessert" type="text" placeholder="Add dessert (e.g., üç® Ice Cream)"/>
          <button id="addDessert" class="btn">Add</button>
        </div>

        <div style="font-weight:700">Pantry / Staples (excluded from grocery list)</div>
        <textarea id="pantryBox" placeholder="e.g., salt, pepper, ketchup, olive oil"></textarea>
      </div>
      <div class="footer">
        <button id="manageSave" class="btn">Done</button>
      </div>
    </div>
  </div>

  <!-- Templates Modal -->
  <div class="modal-backdrop" id="tplModal" aria-hidden="true" role="dialog" aria-labelledby="tplTitle">
    <div class="modal">
      <header>
        <div id="tplTitle" style="font-weight:800">Templates</div>
        <button id="tplClose" class="btn">‚úñ</button>
      </header>
      <div class="body">
        <div style="font-weight:700">Built-ins</div>
        <div class="list" id="tplBuiltins"></div>
        <div style="font-weight:700">Your Templates</div>
        <div class="list" id="tplUser"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="tplName" type="text" placeholder="Template name (e.g., Week: Pizza Friday)"/>
          <button id="tplSave" class="btn">Save Current as Template</button>
        </div>
      </div>
      <div class="footer">
        <button id="tplApplyDone" class="btn">Done</button>
      </div>
    </div>
  </div>

  <!-- Groceries Modal -->
  <div class="modal-backdrop" id="groModal" aria-hidden="true" role="dialog" aria-labelledby="groTitle">
    <div class="modal">
      <header>
        <div id="groTitle" style="font-weight:800">Grocery List</div>
        <button id="groClose" class="btn">‚úñ</button>
      </header>
      <div class="body" id="groBody"></div>
      <div class="footer">
        <button id="groCopy" class="btn">Copy</button>
        <button id="groDownload" class="btn">Download .txt</button>
      </div>
    </div>
  </div>

  <!-- Day Notes Modal -->
  <div class="modal-backdrop" id="dayNotesModal" aria-hidden="true" role="dialog" aria-labelledby="dayNotesTitle">
    <div class="modal">
      <header>
        <div id="dayNotesTitle" style="font-weight:800">Food Notes</div>
        <button id="dayNotesClose" class="btn">‚úñ</button>
      </header>
      <div class="body" id="dayNotesBody"></div>
      <div class="footer">
        <button id="dayNotesDone" class="btn">Done</button>
      </div>
    </div>
  </div>

  <!-- Ratings Modal (per-kid) -->
  <div class="modal-backdrop" id="rateModal" aria-hidden="true" role="dialog" aria-labelledby="rateTitle">
    <div class="modal">
      <header>
        <div id="rateTitle" style="font-weight:800">Rate tonight's dinner</div>
        <button id="rateClose" class="btn">‚úñ</button>
      </header>
      <div class="body" id="rateBody"></div>
      <div class="footer">
        <button id="rateSave" class="btn">Save ratings</button>
      </div>
    </div>
  </div>

  <!-- Your Recipes Modal -->
  <div class="modal-backdrop" id="yourRecModal" aria-hidden="true" role="dialog" aria-labelledby="yourRecTitle">
    <div class="modal">
      <header>
        <div id="yourRecTitle" style="font-weight:800">Your Recipes</div>
        <button id="yourRecClose" class="btn">‚úñ</button>
      </header>
      <div class="body">
        <div id="yourRecList" class="list"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="yourRecTitleInput" type="text" placeholder="Title (e.g., Smash Burgers)"/>
          <input id="yourRecUrlInput" type="text" placeholder="https://..."/>
          <button id="yourRecAdd" class="btn">Add Recipe</button>
        </div>
        <div style="opacity:.7">Up to 5 recipes per item. Links open in your browser.</div>
      </div>
      <div class="footer">
        <button id="yourRecDone" class="btn">Done</button>
      </div>
    </div>
  </div>

<!-- Family Store -->
<script src="family.js?v=3.3.6"></script>
<script>
if (!window.Family) {
  console.warn('family.js not loaded ‚Äî using fallback Family shim.');
  (function(){
    const K={pin:'hub:family:pin', parents:'hub:family:parents', kids:'hub:family:kids'};
    const uid=()=>Math.random().toString(36).slice(2,10);
    const load=(k,f)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return v ?? f;}catch{ return f; } };
    const save=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
    window.Family = {
      setPin(pin){ save(K.pin, pin || null); },
      verifyPin(pin){ const real = load(K.pin, null); return real ? String(real)===String(pin) : true; },
      getParents(){ return load(K.parents, []); },
      upsertParent(p){ const a=this.getParents(); const i=a.findIndex(x=>x.id===p.id);
        if(i>=0) a[i]={...a[i],...p}; else a.push({...p,id:p.id||uid()}); save(K.parents,a); },
      removeParent(id){ save(K.parents, this.getParents().filter(p=>p.id!==id)); },
      getKids(){ return load(K.kids, []); },
      getActiveKids(){ return this.getKids().filter(k=>k.enabled!==false); },
      upsertKid(k){ const a=this.getKids(); const i=a.findIndex(x=>x.id===k.id);
        if(i>=0) a[i]={...a[i],...k}; else a.push({...k,id:k.id||uid(),enabled:true}); save(K.kids,a); },
      removeKid(id){ save(K.kids, this.getKids().filter(k=>k.id!==id)); },
      setKidEnabled(id,en){ const a=this.getKids(); const k=a.find(x=>x.id===id); if(k){ k.enabled=!!en; save(K.kids,a); } },
      onChange(){ return ()=>{}; }
    };
  })();
}
</script>

<script>
/* ---------- Helpers ---------- */
const LS={foods:'dp:foods:list',desserts:'dp:desserts:list',week:(m)=>`dp:plan:${m}`,templates:'dp:tpls',pantry:'dp:pantry', notes:'dp:food:notes', myrec:'dp:myrec:'};
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uid=()=>Math.random().toString(36).slice(2,10);
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function cleanLabel(s){ return (s||'').replace(/^[^\w]+/,'').trim().toLowerCase(); }

/* Local week/day helpers (no UTC shift) */
const DAYS=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
function localISO(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function startOfWeekMondayLocal(d=new Date()){const m=new Date(d.getFullYear(),d.getMonth(),d.getDate());const off=(m.getDay()+6)%7;m.setDate(m.getDate()-off);return m;}
function mondayISO(d){return localISO(d||state.weekStart);}
function weekLabelText(mISO){const [Y,M,D]=mISO.split('-').map(n=>+n);const s=new Date(Y,M-1,D);const e=new Date(s);e.setDate(e.getDate()+6);const f=d=>d.toLocaleDateString(undefined,{month:'short',day:'numeric'});return `${f(s)} ‚Äì ${f(e)}`;}
function niceDay(mISO,idx){const dt=new Date(mISO+'T00:00:00');dt.setDate(dt.getDate()+idx);return dt.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});}

/* Model */
function emptyDay(){return {kids:{main:"",side:""},parents:{main:"",side:""},dessert:"",rating:null,ratings:{}}}
function loadWeekPlan(mISO){let p=load(LS.week(mISO),null);if(!p){p={days:{}};DAYS.forEach(d=>p.days[d]=emptyDay());save(LS.week(mISO),p);}return p;}
function saveWeekPlan(mISO,plan){save(LS.week(mISO),plan)}

/* Seed menus first run */
function seedFoodsIfNeeded(){
  let foods=load(LS.foods,null);
  if(!Array.isArray(foods)||foods.length<10){
    foods=["üçï Pizza","üåÆ Tacos","üåØ Burritos","üçù Spaghetti","üçó Chicken Nuggets","ü•™ Sandwiches","üå≠ Hot Dogs","üçî Burgers","ü•ó Salad","ü•ü Potstickers","ü•î Potatoes","üçú Ramen","ü•ô Pita & Hummus","üêü Fish","üç≤ Soup","ü•¶ Veggies","üçü French Fries","üåΩ Corn","ü•î Potatoes","ü•û Pancakes","üßá Waffles","üç≥ Eggs","üçé Apples","üçâ Watermelon","ü´ê Blueberries","üçå Banana","üçà Melon","ü•í Cucumber","ü•ï Carrots"];
    save(LS.foods,foods);
  }
  let desserts=load(LS.desserts,null);
  if(!Array.isArray(desserts)||desserts.length<3){
    desserts=["üç™ Cookies","üç¶ Ice Cream","üç∞ Cake","üçì Berries & Cream","ü•ß Pie","üç´ Candy","üßÅ Cupcake"];
    save(LS.desserts,desserts);
  }
  if(load(LS.pantry,null)==null){ save(LS.pantry,["salt","pepper","ketchup","mustard","olive oil","butter"]); }
}

/* ---------- State ---------- */
let state = {
  weekStart: startOfWeekMondayLocal(new Date()),
  selectedIndex: (new Date().getDay()+6)%7 // 0..6
};

function dayKey(){ return DAYS[state.selectedIndex]; }

/* ---------- Weekbar ---------- */
function renderWeekbar(){
  const mISO = mondayISO();
  $('#weekLabel').textContent = weekLabelText(mISO);
  const daysWrap = $('#weekDays'); daysWrap.innerHTML='';
  for(let i=0;i<7;i++){
    const btn=document.createElement('button'); btn.className='weekbtn';
    btn.textContent = niceDay(mISO, i);
    if(i===state.selectedIndex) btn.classList.add('active');
    btn.onclick=()=>{ state.selectedIndex=i; render(); };
    daysWrap.appendChild(btn);
  }
}
$('#wPrev').onclick = ()=>{ state.weekStart.setDate(state.weekStart.getDate()-7); state.selectedIndex=0; render(); };
$('#wNext').onclick = ()=>{ state.weekStart.setDate(state.weekStart.getDate()+7); state.selectedIndex=0; render(); };
$('#wToday').onclick= ()=>{ state.weekStart = startOfWeekMondayLocal(new Date()); state.selectedIndex=(new Date().getDay()+6)%7; render(); };

/* ---------- Rendering ---------- */
function fillOptions(sel, list, selected){
  sel.innerHTML='';
  const ph = '‚Äî Choose item ‚Äî';
  const arr = [ph, ...list];
  arr.forEach(v=>{
    const o=document.createElement('option');
    o.value = (v===ph?'':v); o.textContent=v;
    if((v===ph && !selected) || o.value===selected) o.selected=true;
    sel.appendChild(o);
  });
}

function render(){
  renderWeekbar();

  const mISO=mondayISO();
  const plan=loadWeekPlan(mISO);
  const foods=load(LS.foods,[]), desserts=load(LS.desserts,[]);
  const day=plan.days[dayKey()] || emptyDay();

  fillOptions($('#selKidsMain'), foods, day.kids.main);
  fillOptions($('#selKidsSide'), foods, day.kids.side);
  fillOptions($('#selParMain'),  foods, day.parents.main);
  fillOptions($('#selParSide'),  foods, day.parents.side);
  fillOptions($('#selDessert'),  desserts, day.dessert);

  buildRecipeLinks('kids', day.kids.main);
  buildRecipeLinks('par',  day.parents.main);

  $('#groPreview').textContent = groceryText();
}

function buildRecipeLinks(kind, label){
  const wrap = kind==='kids' ? $('#kidsLinks') : $('#parLinks');
  const title = kind==='kids' ? $('#kidsRecTitle') : $('#parRecTitle');
  wrap.innerHTML='';
  const q = (label||'').replace(/^[^\w]+/,'').trim();
  title.textContent = (q? `${q} recipes` : (kind==='kids'?'Kids recipes':'Parents recipes'));
  const disabled = !q;

  const links = [
    ['Allrecipes', q?`https://www.allrecipes.com/search?q=${encodeURIComponent(q)}`:'#'],
    ['YouTube', q?`https://www.youtube.com/results?search_query=${encodeURIComponent(q+' recipe')}`:'#'],
    ['Your Recipes', '#your']
  ];
  links.forEach(([lbl,href])=>{
    const a=document.createElement('a');
    a.className='a-btn';
    a.textContent=lbl;
    if(lbl==='Your Recipes'){
      if(disabled){ a.style.opacity='.4'; a.setAttribute('aria-disabled','true'); a.onclick=(e)=>e.preventDefault(); }
      else { a.href='#'; a.onclick=(e)=>{ e.preventDefault(); openYourRecipes(label); }; }
    } else {
      a.href=href; a.target='_blank'; a.rel='noopener';
      if(disabled){ a.setAttribute('aria-disabled','true'); a.style.opacity='.4'; a.onclick=(e)=>e.preventDefault(); }
    }
    wrap.appendChild(a);
  });
}

/* ---------- Save wires ---------- */
function syncAndSave(){
  const mISO=mondayISO();
  const plan=loadWeekPlan(mISO);
  const d=plan.days[dayKey()];
  d.kids.main    = $('#selKidsMain').value;
  d.kids.side    = $('#selKidsSide').value;
  d.parents.main = $('#selParMain').value;
  d.parents.side = $('#selParSide').value;
  d.dessert      = $('#selDessert').value || '';
  saveWeekPlan(mISO, plan);
  render();
}
['selKidsMain','selKidsSide','selParMain','selParSide','selDessert'].forEach(id=>{
  document.getElementById(id).onchange = syncAndSave;
});

/* ---------- Notes (per-day aggregated) ---------- */
function getNotes(){ return load(LS.notes, {}); }
function setNotes(map){ save(LS.notes, map); }
function openDayNotes(){
  const mISO=mondayISO(); const plan=loadWeekPlan(mISO); const x=plan.days[dayKey()];
  const items=[x.kids.main,x.kids.side,x.parents.main,x.parents.side,x.dessert].filter(Boolean);
  const body=$('#dayNotesBody'); body.innerHTML = items.length? '' : '<div style="opacity:.7">No items selected for this day.</div>';
  const n=getNotes();
  items.forEach(label=>{
    const has = !!(n[label] && (n[label].global||'').trim());
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`<div>${escapeHtml(label)} ${has?'<span class="badge" style="margin-left:6px">has notes</span>':''}</div><button class="btn">Edit</button>`;
    row.querySelector('button').onclick=()=>openNotesEditor(label, openDayNotes);
    body.appendChild(row);
  });
  show($('#dayNotesModal'));
}
$('#btnNotes').onclick = openDayNotes;
document.getElementById('dayNotesClose').onclick = ()=> hide(document.getElementById('dayNotesModal'));
document.getElementById('dayNotesDone').onclick  = ()=> hide(document.getElementById('dayNotesModal'));

/* Notes editor (simple prompt) */
let _editingLabel='';
function openNotesEditor(label, onSaved){
  _editingLabel=label;
  const cur = (getNotes()[label]?.global)||'';
  const next = prompt('Notes for: '+label, cur||'');
  if (next===null) return; // cancel
  const map=getNotes();
  const v=(next||'').trim();
  if(!v) delete map[label]; else map[label]={global:v};
  setNotes(map);
  if(onSaved) onSaved();
}

/* ---------- Ratings (per-kid modal) ---------- */
function openRatings(){
  const mISO=mondayISO(); const plan=loadWeekPlan(mISO); const x=plan.days[dayKey()];
  const kids = (window.Family?.getActiveKids?.() || []);
  const body = $('#rateBody'); body.innerHTML='';
  if (!kids.length){
    const warn=document.createElement('div'); warn.textContent='No kids added yet. Add kids in Admin.'; body.appendChild(warn);
  }
  kids.forEach(k=>{
    const row=document.createElement('div'); row.className='kidrow'; row.dataset.id=k.id;
    const existing = x.ratings?.[k.id] || {stars:0, note:''};
    row.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <span class="face">${k.photo?`<img src="${k.photo}" alt="">`:(k.name||'?').trim().charAt(0).toUpperCase()}</span>
        <div style="font-weight:800">${escapeHtml(k.name||'Kid')}</div>
      </div>
      <div class="starsel" data-kid="${k.id}">
        <span data-v="1">‚òÖ</span><span data-v="2">‚òÖ</span><span data-v="3">‚òÖ</span><span data-v="4">‚òÖ</span><span data-v="5">‚òÖ</span>
      </div>
      <input type="text" placeholder="optional note" value="${escapeHtml(existing.note||'')}" data-type="note" data-kid="${k.id}" style="flex:1; padding:8px 10px; border-radius:10px; border:1px solid var(--ring); background:var(--card); color:var(--text);" />
    `;
    body.appendChild(row);
    const starsel = row.querySelector('.starsel');
    const setStars = (n)=>{ starsel.querySelectorAll('span').forEach(s=>s.classList.toggle('on', Number(s.dataset.v)<=n)); starsel.dataset.val=n; };
    setStars(existing.stars||0);
    starsel.querySelectorAll('span').forEach(s=> s.addEventListener('click', ()=> setStars(Number(s.dataset.v)) ));
  });
  show($('#rateModal'));
}
$('#btnRatings').onclick = openRatings;
$('#rateClose').onclick = ()=> hide($('#rateModal'));
$('#rateSave').onclick = ()=>{
  const mISO=mondayISO(); const plan=loadWeekPlan(mISO); const x=plan.days[dayKey()];
  const ratings={};
  $$('.starsel').forEach(sel=>{
    const id = sel.dataset.kid;
    const stars = Number(sel.dataset.val||0);
    const note = ($(`input[data-type="note"][data-kid="${id}"]`)?.value || '').trim();
    if (stars>0 || note) ratings[id] = { stars, note };
  });
  x.ratings = ratings;
  saveWeekPlan(mondayISO(), plan);
  hide($('#rateModal'));
};

/* ---------- Your Recipes ---------- */
let _yourRecFor = ''; // plain, cleaned key anchor
function recKey(label){ return LS.myrec + cleanLabel(label); }
function openYourRecipes(label){
  _yourRecFor = label || '';
  const title = ($('#yourRecTitle')||{}); if(title) title.textContent = 'Your Recipes ‚Äî ' + (label||'Item');
  const list = load(recKey(label), []);
  const wrap = $('#yourRecList'); wrap.innerHTML='';
  if(!list.length){
    const empty=document.createElement('div'); empty.className='item'; empty.innerHTML='<div>No saved recipes yet.</div>';
    wrap.appendChild(empty);
  } else {
    list.slice(0,5).forEach((r,idx)=>{
      const row=document.createElement('div'); row.className='item';
      const safeTitle = escapeHtml(r.title||'Recipe');
      const safeUrl = escapeHtml(r.url||'#');
      row.innerHTML = `<div><a href="${safeUrl}" target="_blank" rel="noopener">${safeTitle}</a></div><button class="btn" data-del>Delete</button>`;
      row.querySelector('[data-del]').onclick = ()=>{
        const arr = load(recKey(label), []);
        arr.splice(idx,1);
        save(recKey(label), arr);
        openYourRecipes(label);
      };
      wrap.appendChild(row);
    });
  }
  show($('#yourRecModal'));
}
$('#yourRecAdd').onclick = ()=>{
  const label = _yourRecFor;
  if(!label) return;
  const title = ($('#yourRecTitleInput').value||'').trim();
  const url = ($('#yourRecUrlInput').value||'').trim();
  if(!title || !url){ alert('Enter a title and a URL.'); return; }
  if(!/^https?:\/\/?/i.test(url)){ alert('URL should start with http:// or https://'); return; }
  const key = recKey(label);
  const arr = load(key, []);
  if(arr.length >= 5){ alert('You can save up to 5 recipes for this item.'); return; }
  arr.push({title, url});
  save(key, arr);
  $('#yourRecTitleInput').value=''; $('#yourRecUrlInput').value='';
  openYourRecipes(label);
};
$('#yourRecClose').onclick = ()=> hide($('#yourRecModal'));
$('#yourRecDone').onclick = ()=> hide($('#yourRecModal'));

/* ---------- Hamburger / Modals ---------- */
function show(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function hide(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }

(function hamburger(){
  const btn=$('#btnHamburger'), dd=$('#menuDropdown');
  const open=()=>{dd.classList.add('open');btn.setAttribute('aria-expanded','true');dd.setAttribute('aria-hidden','false');};
  const close=()=>{dd.classList.remove('open');btn.setAttribute('aria-expanded','false');dd.setAttribute('aria-hidden','true');};
  btn.addEventListener('click',e=>{e.stopPropagation(); dd.classList.contains('open')?close():open();});
  document.addEventListener('click',e=>{ if(!dd.contains(e.target)&&e.target!==btn) close(); });
  dd.addEventListener('click', e=>{
    const a=e.target.closest('.menu-item'); if(!a) return; close();
    const act=a.dataset.action;
    if(act==='templates') openTemplates();
    else if(act==='groceries') openGroceries();
    else if(act==='shareGro') shareText(groceryText());
    else if(act==='sharePlan') shareText(planSummaryText());
    else if(act==='manage') openManage();
    else if(act==='reset'){
      if(confirm('Clear all entries for this week?')){
        const plan={days:{}};DAYS.forEach(d=>plan.days[d]=emptyDay()); save(LS.week(mondayISO()),plan); render();
      }
    }
  });
})();

/* Manage modal builders */
const manageModal=$('#manageModal');
$('#manageClose').onclick=()=>hide(manageModal);
$('#manageSave').onclick=()=>{const list=($('#pantryBox').value||'').split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);save(LS.pantry,list);hide(manageModal);};
function openManage(){buildFoodList();buildDessertList();$('#pantryBox').value=load(LS.pantry,[]).join(', ');show(manageModal);}
function buildFoodList(){
  const wrap=$('#foodList');wrap.innerHTML='';
  const foods=load(LS.foods,[]);
  foods.forEach((f,idx)=>{
    const row=document.createElement('div');row.className='item';
    row.innerHTML=`<input value="${escapeHtml(f)}"/><div style="display:flex;gap:8px"><button class="btn" data-notes>Notes</button><button class="btn" data-rm>Remove</button></div>`;
    wrap.appendChild(row);
    row.querySelector('[data-notes]').onclick=()=>openNotesEditor(f, buildFoodList);
    row.querySelector('input').oninput=e=>{foods[idx]=e.target.value;save(LS.foods,foods);render();};
    row.querySelector('[data-rm]').onclick=()=>{foods.splice(idx,1);save(LS.foods,foods);buildFoodList();render();};
  });
  $('#addFood').onclick=()=>{const v=($('#newFood').value||'').trim();if(!v)return;const list=load(LS.foods,[]);list.push(v);save(LS.foods,list);$('#newFood').value='';buildFoodList();render();};
}
function buildDessertList(){
  const wrap=$('#dessertList');wrap.innerHTML='';
  const ds=load(LS.desserts,[]);
  ds.forEach((d,idx)=>{
    const row=document.createElement('div');row.className='item';
    row.innerHTML=`<input value="${escapeHtml(d)}"/><div style="display:flex;gap:8px"><button class="btn" data-notes>Notes</button><button class="btn" data-rm>Remove</button></div>`;
    wrap.appendChild(row);
    row.querySelector('[data-notes]').onclick=()=>openNotesEditor(d, buildDessertList);
    row.querySelector('input').oninput=e=>{ds[idx]=e.target.value;save(LS.desserts,ds);render();};
    row.querySelector('[data-rm]').onclick=()=>{ds.splice(idx,1);save(LS.desserts,ds);buildDessertList();render();};
  });
  $('#addDessert').onclick=()=>{const v=($('#newDessert').value||'').trim();if(!v)return;const list=load(LS.desserts,[]);list.push(v);save(LS.desserts,list);$('#newDessert').value='';buildDessertList();render();};
}

/* Templates */
const tplModal=$('#tplModal'); $('#tplClose').onclick=()=>hide(tplModal); $('#tplApplyDone').onclick=()=>hide(tplModal);
$('#tplSave').onclick=()=>{const name=($('#tplName').value||'').trim();if(!name)return alert('Name your template');const plan=loadWeekPlan(mondayISO());const t=load(LS.templates,[]);t.push({id:uid(),name,plan});save(LS.templates,t);$('#tplName').value='';buildTplLists();}
function openTemplates(){buildTplLists();show(tplModal)}
function buildTplLists(){
  const built=$('#tplBuiltins');built.innerHTML='';
  const pizza=document.createElement('div');pizza.className='item';
  pizza.innerHTML=`<div>üçï Pizza Friday</div><button class="btn" data-apply>Apply</button>`;
  pizza.querySelector('[data-apply]').onclick=()=>{applyPizzaFriday();};
  built.appendChild(pizza);

  const wrap=$('#tplUser');wrap.innerHTML='';
  const tpls=load(LS.templates,[]);
  if(!tpls.length){
    const empty=document.createElement('div');empty.className='item';empty.innerHTML='<div>No saved templates yet.</div>';
    wrap.appendChild(empty);
  }else{
    tpls.forEach(t=>{
      const row=document.createElement('div');row.className='item';
      row.innerHTML=`<div>${escapeHtml(t.name)}</div><div style="display:flex;gap:8px"><button class="btn" data-apply>Apply</button><button class="btn" data-del>Delete</button></div>`;
      wrap.appendChild(row);
      row.querySelector('[data-apply]').onclick=()=>{save(LS.week(mondayISO()),t.plan);render();};
      row.querySelector('[data-del]').onclick=()=>{const arr=load(LS.templates,[]).filter(x=>x!==t);save(LS.templates,arr);buildTplLists();};
    });
  }
}
function applyPizzaFriday(){
  const plan=loadWeekPlan(mondayISO());
  plan.days["Fri"].kids.main="üçï Pizza";
  plan.days["Fri"].parents.main="üçï Pizza";
  saveWeekPlan(mondayISO(),plan); render();
}

/* Groceries / share */
const groModal=$('#groModal'); $('#groClose').onclick=()=>hide(groModal);
function openGroceries(){
  const pre=document.createElement('pre');pre.style.whiteSpace='pre-wrap';pre.style.margin='0';pre.textContent=groceryText();
  const body=$('#groBody'); body.innerHTML=''; body.appendChild(pre); show(groModal);
}
$('#groCopy').onclick=()=>navigator.clipboard.writeText(groceryText()).then(()=>alert('Grocery list copied.'));
$('#groDownload').onclick=()=>{const blob=new Blob([groceryText()],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`Fambam-Groceries-${mondayISO()}.txt`;a.click();URL.revokeObjectURL(a.href);};
$('#openGroModal').onclick = openGroceries;
$('#groCopyInline').onclick = ()=>navigator.clipboard.writeText(groceryText()).then(()=>alert('Copied.'));
$('#groDownloadInline').onclick = ()=>{const blob=new Blob([groceryText()],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`Fambam-Groceries-${mondayISO()}.txt`;a.click();URL.revokeObjectURL(a.href);};

function groceryText(){
  const plan=loadWeekPlan(mondayISO());
  const pantry=new Set(load(LS.pantry,[]).map(s=>s.toLowerCase()));
  const buckets={"Kids mains":{}, "Kids sides":{}, "Parents mains":{}, "Parents sides":{}, "Desserts":{}};
  const bump=(b,name)=>{if(!name)return;const clean=name.replace(/^[^\w]+/,'').trim();if(!clean)return;if(pantry.has(clean.toLowerCase()))return;buckets[b][clean]=(buckets[b][clean]||0)+1;};
  DAYS.forEach(d=>{const x=plan.days[d]||emptyDay();bump("Kids mains",x.kids.main);bump("Kids sides",x.kids.side);bump("Parents mains",x.parents.main);bump("Parents sides",x.parents.side);bump("Desserts",x.dessert);});
  const lines=[];
  for(const [section,items] of Object.entries(buckets)){
    const names=Object.keys(items).sort((a,b)=>a.localeCompare(b));
    if(!names.length)continue;
    lines.push(`${section}`);
    names.forEach(n=>lines.push(`- ${n}${items[n]>1 ? ` √ó${items[n]}` : ''}`));
  }
  if(!lines.length) return 'No grocery items yet.';
  return lines.join('\\n');
}
function planSummaryText(){
  const plan=loadWeekPlan(mondayISO());
  const lines=[`üçΩÔ∏è Fambam Dinner Plan ‚Äî ${$('#weekLabel').textContent}`];
  DAYS.forEach(d=>{
    const x=plan.days[d];
    const kids=[x.kids.main,x.kids.side].filter(Boolean).join(' + ');
    const pars=[x.parents.main,x.parents.side].filter(Boolean).join(' + ');
    const des=x.dessert?` ‚Ä¢ Dessert: ${x.dessert}`:'';
    lines.push(`${d}: Kids ${kids||'‚Äî'} | Parents ${pars||'‚Äî'}${des}`)
  });
  return lines.join('\\n');
}
async function shareText(content){
  try{ if(navigator.share){ await navigator.share({text:content}); return; } }catch{}
  const encoded=encodeURIComponent(content);
  const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
  const href=isIOS?`sms:&body=${encoded}`:`sms:?body=${encoded}`;
  try{ location.href=href; return; }catch{}
  try{ await navigator.clipboard.writeText(content); alert('Copied to clipboard.'); }
  catch{ alert('Share unavailable. Copy/paste this:\\n\\n'+content); }
}

/* ---------- Boot ---------- */
seedFoodsIfNeeded();
render();
addEventListener('pageshow', render);
addEventListener('storage', e=>{
  if (!e.key) return;
  if (e.key.startsWith('dp:plan:') || e.key === 'dp:foods:list' || e.key === 'dp:desserts:list' || e.key === 'dp:pantry') {
    render();
  }
});

/* Service worker */
if('serviceWorker' in navigator) addEventListener('load', ()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
</script>
</body>
</html>
