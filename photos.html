<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam · Photos</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<!-- Universal wallpaper -->
<link rel="stylesheet" href="wallpaper.css">
<script src="wallpaper.js" defer></script>

<!-- Shared app styles -->
<link rel="stylesheet" href="fambam.css">

<!-- THEME BOOT (same as other pages) -->
<script>
(function themeBoot(){
  try{
    const raw = localStorage.getItem('ui:theme');
    const saved = raw ? JSON.parse(raw) : { mode:'dark', accent:'#22d3ee' };
    const mode = (saved.mode==='light') ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.style.setProperty('--accent', saved.accent || '#22d3ee');
    const meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', mode==='light' ? '#f2efe7' : '#0f172a');

    const swapLogo = ()=>{
      const logo = document.querySelector('.brand img');
      if (logo) logo.src = (mode==='light') ? 'fambam2.png' : 'fambam.png';
    };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', swapLogo, {once:true});
    } else { swapLogo(); }

    window.addEventListener('storage', (e)=>{
      if (e.key!=='ui:theme') return;
      try{
        const t = JSON.parse(e.newValue||'{}');
        const m = (t.mode==='light') ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', m);
        document.documentElement.style.setProperty('--accent', t.accent || '#22d3ee');
        if (meta) meta.setAttribute('content', m==='light' ? '#f2efe7' : '#0f172a');
        const logo = document.querySelector('.brand img');
        if (logo) logo.src = (m==='light') ? 'fambam2.png' : 'fambam.png';
      }catch(_){}
    });
  }catch(_){}
})();
</script>

<style>
/* ---------- Photos page (scoped) ---------- */
.page-photos .app{
  max-width:1100px; margin:0 auto; padding:20px;
  display:grid; gap:18px; grid-template-rows:auto 1fr auto;
}

/* keep header above dropdown/content */
.page-photos header.panel { position:relative; z-index:1000; }
.page-photos .menu-wrap { position:relative; z-index:1001; }
.page-photos .menu-dd    { z-index:1002; }

/* layout */
.page-photos .grid{ display:grid; gap:14px; grid-template-columns:1fr 360px; }
@media(max-width:900px){ .page-photos .grid{ grid-template-columns:1fr; } }

/* viewer */
.page-photos .viewer{
  position:relative; height:60vh; min-height:360px; border-radius:16px; overflow:hidden;
  background:var(--chipBg); border:1px solid var(--chipBorder);
}
.page-photos .viewer img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transition:opacity .5s; }

/* right panel as a column so the list can grow */
.page-photos .panel.side{ display:flex; flex-direction:column; }
.page-photos .panel.side .list{ flex:1; min-height:0; overflow:auto; }

/* list */
.page-photos .list{
  display:grid; gap:10px; max-height:60vh; padding-right:4px;
  -webkit-overflow-scrolling:touch; overscroll-behavior:contain;
}
.page-photos .row{
  display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
  background:var(--card); border:1px solid var(--panelBorder);
  border-radius:12px; padding:8px 10px; cursor:pointer;
}
.page-photos .row:hover{ filter:brightness(1.02); }
.page-photos .row.active{ box-shadow: inset 0 0 0 2px var(--accent); }
.page-photos .thumb{
  width:52px; height:52px; border-radius:10px; object-fit:cover;
  background:var(--chipBg); border:1px solid var(--chipBorder);
}
.page-photos .row .name{ font-size:.92rem; color:var(--text); }

/* hidden input */
.page-photos input[type="file"].sr-only{ display:none !important; }

/* toast */
.page-photos .toast{
  position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
  background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--text);
  padding:10px 12px; border-radius:10px; box-shadow:var(--shadow);
  opacity:0; pointer-events:none; transition:opacity .25s;
}
.page-photos .toast.show{ opacity:1; }
</style>
</head>

<body class="page-photos">
<div class="app">
  <!-- Shared header (uses fambam.css) -->
  <header class="panel header">
    <a href="./index.html" class="brand" title="Home">
      <img src="fambam.png" alt="Fambam">
    </a>
    <div class="title">
      <div class="big">Photos</div>
      <div class="small">Pick images for the home slideshow card.</div>
    </div>
    <div class="menu-wrap">
      <button id="btnMenu" class="hamburger" aria-haspopup="true" aria-expanded="false">☰</button>
      <div id="menuDD" class="menu-dd" role="menu" aria-hidden="true">
        <button class="mi" data-mi="add">Add Photos</button>
        <button class="mi" data-mi="clear">Clear All</button>
        <button class="mi" data-mi="about">About Photos</button>
      </div>
    </div>
  </header>

  <section class="grid">
    <div class="panel">
      <div class="viewer"><img id="big" alt=""></div>
    </div>
    <div class="panel side">
      <div class="small" style="margin-bottom:8px">Rotate every:</div>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <label><input type="radio" name="iv" value="10000"> 10s</label>
        <label><input type="radio" name="iv" value="30000"> 30s</label>
        <label><input type="radio" name="iv" value="60000"> 1m</label>
      </div>
      <div class="small" style="margin-bottom:8px">Photos</div>
      <div id="list" class="list"></div>
      <div class="small" style="opacity:.7;margin-top:6px">Up to 20 photos.</div>
    </div>
  </section>

  <footer class="panel small" style="text-align:center;opacity:.75">
    Images are stored locally on this device only.
  </footer>
</div>

<!-- Hidden picker -->
<input id="picker" type="file" accept="image/*,.heic,.heif" multiple class="sr-only"/>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
const LS_LIST='photos:list';
const LS_IV  ='photos:cadence_ms';
const MAX_PHOTOS = 20;

const $=(s,e=document)=>e.querySelector(s);
const listEl=$('#list'), big=$('#big'), picker=$('#picker');

/* --- Simple menu (keeps your custom items) --- */
(function menu(){
  const btn=$('#btnMenu'), dd=$('#menuDD');
  const open=()=>{dd.classList.add('open');btn.setAttribute('aria-expanded','true');dd.setAttribute('aria-hidden','false');};
  const close=()=>{dd.classList.remove('open');btn.setAttribute('aria-expanded','false');dd.setAttribute('aria-hidden','true');};
  btn.addEventListener('click',e=>{e.stopPropagation(); dd.classList.contains('open')?close():open();});
  document.addEventListener('click',e=>{ if(!dd.contains(e.target) && e.target!==btn) close(); });
  dd.addEventListener('click',e=>{
    const el=e.target.closest('.mi'); if(!el) return; close();
    const act=el.dataset.mi;
    if(act==='add') picker.click();
    if(act==='clear'){
      if(confirm('Remove all photos?')){ imgs=[]; saveList(imgs); renderList(); startShow(); }
    }
    if(act==='about'){ showToast('JPEG/PNG/HEIC supported. Large photos are resized on import.'); }
  });
})();

/* --- Storage helpers --- */
function loadList(){ try{const v=JSON.parse(localStorage.getItem(LS_LIST)); if(Array.isArray(v)) return v; }catch{} return []; }
function saveList(a){ localStorage.setItem(LS_LIST, JSON.stringify(a)); }
function loadIv(){ const v=+localStorage.getItem(LS_IV)||10000; return [10000,30000,60000].includes(v)?v:10000; }
function saveIv(v){ localStorage.setItem(LS_IV, v); }

/* --- State --- */
let imgs=loadList(); let iv=loadIv(); let idx=0; let timer=null;

/* --- UI render --- */
function renderList(){
  listEl.innerHTML='';
  if(!imgs.length){
    listEl.innerHTML='<div class="small" style="opacity:.8">No photos yet. Tap “Add Photos”.</div>';
    big.removeAttribute('src'); return;
  }
  imgs.forEach((src,i)=>{
    const row=document.createElement('div'); row.className='row'; row.dataset.index=i;
    row.innerHTML=`
      <img class="thumb" alt="Photo ${i+1} thumbnail" src="${src}">
      <div class="name">Photo ${i+1}</div>
      <button class="btn" data-remove>Remove</button>
    `;
    row.onclick = (ev)=>{ if(ev.target.closest('[data-remove]')) return; jumpTo(i); };
    row.querySelector('[data-remove]').onclick=()=>{
      const wasCurrent = i===idx;
      imgs.splice(i,1); saveList(imgs); renderList();
      if(wasCurrent) idx = Math.max(0, idx-1);
      startShow();
    };
    listEl.appendChild(row);
  });
  highlightActive();
}
function highlightActive(){
  listEl.querySelectorAll('.row').forEach(r=>r.classList.remove('active'));
  const r = listEl.querySelector(`.row[data-index="${idx}"]`);
  if(r) r.classList.add('active');
}
function jumpTo(i){
  if(!imgs.length) return;
  idx = Math.max(0, Math.min(i, imgs.length-1));
  big.style.opacity=0; setTimeout(()=>{ big.src=imgs[idx]; big.style.opacity=1; },150);
  highlightActive();
}

/* --- Slideshow --- */
function startShow(){
  if(timer) clearInterval(timer);
  if(!imgs.length){ big.removeAttribute('src'); return; }
  idx=idx%imgs.length; big.src=imgs[idx]; highlightActive();
  timer=setInterval(()=>{ idx=(idx+1)%imgs.length; big.style.opacity=0; setTimeout(()=>{ big.src=imgs[idx]; big.style.opacity=1; highlightActive(); },150); }, iv);
}
document.querySelectorAll('input[name="iv"]').forEach(r=>{
  if(+r.value===iv) r.checked=true;
  r.onchange=()=>{ iv=+r.value; saveIv(iv); startShow(); };
});

/* --- Import pipeline (HEIC-friendly, resize, cap 20) --- */
picker.onchange = async (e)=>{
  const all=[...e.target.files||[]]; if(!all.length) return;
  const slotsLeft = Math.max(0, MAX_PHOTOS - imgs.length);
  const files = all.slice(0, slotsLeft);
  const skippedForCap = all.length - files.length;

  let added=0, failed=0;
  for(const f of files){
    try{
      const data=await readAndShrinkSmart(f, 1800, .9);
      if(data){ imgs.push(data); added++; } else { failed++; }
    }catch{ failed++; }
  }
  saveList(imgs); renderList(); startShow(); picker.value='';
  if(added) showToast(`Added ${added} photo${added>1?'s':''}${(failed||skippedForCap)?` · Skipped ${failed+skippedForCap}`:''}`);
  else showToast('No supported photos were added.');
};
async function readAndShrinkSmart(file, maxSide=1800, quality=.9){
  const bitmap = await decodeToBitmap(file).catch(()=>null);
  if(!bitmap) return null;
  const scale = Math.min(1, maxSide/Math.max(bitmap.width, bitmap.height));
  const w = Math.max(1, Math.round(bitmap.width * scale));
  const h = Math.max(1, Math.round(bitmap.height * scale));
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  c.getContext('2d').drawImage(bitmap,0,0,w,h);
  return c.toDataURL('image/jpeg', quality);
}
function decodeToBitmap(file){
  return new Promise((resolve, reject)=>{
    if ('createImageBitmap' in window) {
      createImageBitmap(file).then(resolve).catch(()=>{
        const fr = new FileReader();
        fr.onload = ()=>{
          const img = new Image();
          img.onload = ()=> resolve(img);
          img.onerror = reject;
          img.src = fr.result;
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    } else {
      const fr = new FileReader();
      fr.onload = ()=>{
        const img = new Image();
        img.onload = ()=> resolve(img);
        img.onerror = reject;
        img.src = fr.result;
      };
      fr.onerror = reject;
      fr.readAsDataURL(file);
    }
  });
}

/* --- Toast --- */
let toastTimer=null;
function showToast(msg){
  const t=$('#toast'); t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'), 2400);
}

/* --- Boot --- */
renderList(); startShow();

/* SW */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
</script>
</body>
</html>