<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam ¬∑ Chores</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<!-- Universal wallpaper (shared across all pages) -->
<link rel="stylesheet" href="wallpaper.css">
<script src="wallpaper.js" defer></script>

<!-- THEME BOOT (Dark/Light + Accent + Auto Logo Swap) -->
<script>
/* Reads localStorage `ui:theme` = { mode:"dark"|"light", accent:"#RRGGBB" }.
   Applies immediately, syncs <meta name="theme-color">, and swaps Fambam logo.
   Expects `fambam.png` (dark) and `fambam2.png` (light) in the same directory. */
(function () {
  var DARK_SRC  = 'fambam.png';
  var LIGHT_SRC = 'fambam2.png';

  function findLogo() {
    return (
      document.getElementById('logoImg') ||
      document.querySelector('.brand img') ||
      document.querySelector('header .title img') ||
      document.querySelector('img[alt="Fambam"]') ||
      null
    );
  }

  function swapLogoForMode(mode) {
    var logo = findLogo();
    if (!logo) return;

    var cur = logo.getAttribute('src') || '';
    var next;
    if (/fambam2?\.png$/i.test(cur)) {
      next = cur.replace(/fambam2?\.png$/i, mode === 'light' ? 'fambam2.png' : 'fambam.png');
    } else {
      next = (mode === 'light') ? LIGHT_SRC : DARK_SRC;
    }
    logo.setAttribute('src', next);

    var a = logo.closest('a');
    if (a && !a.getAttribute('href')) a.setAttribute('href', './index.html');
  }

  function applyTheme(t) {
    var mode   = (t && t.mode === 'light') ? 'light' : 'dark';
    var accent = (t && t.accent) || '#22d3ee';

    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.style.setProperty('--accent', accent);

    var meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', mode === 'light' ? '#f2efe7' : '#0f172a');

    swapLogoForMode(mode);
    document.addEventListener('DOMContentLoaded', function(){ swapLogoForMode(mode); }, { once:true });
  }

  try {
    var raw = localStorage.getItem('ui:theme');
    var saved = raw ? JSON.parse(raw) : { mode: 'dark', accent: '#22d3ee' };
    applyTheme(saved);
  } catch (_) {
    applyTheme({ mode: 'dark', accent: '#22d3ee' });
  }

  window.addEventListener('storage', function (e) {
    if (e.key !== 'ui:theme') return;
    try { applyTheme(JSON.parse(e.newValue || '{}')); } catch (_) {}
  });
})();
</script>

<style>
/* --- layout sanity --- */
*, *::before, *::after { box-sizing: border-box; }

/* Tokens (match index/breakfast) */
:root{
  --panel:#111827; --card:#1f2937; --muted:#6b7280; --text:#e5e7eb; --accent:#22d3ee;
  --bg:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;

  --panelBorder:#0b1224;
  --chipBg:#0b1224;
  --chipBorder:#334155;

  --dropdownBg:#111827;
  --dropdownBorder:#1f2937;

  --wallpaper:url(''); --wallpaper-shift:40%;
}

/* LIGHT THEME OVERRIDES */
html[data-theme="light"]{
  --panel:#f2efe7;
  --card:#ffffff;
  --muted:#556070;
  --text:#0f1623;
  --bg:#f0ece4;
  --shadow:0 10px 28px rgba(0,0,0,.08);

  --panelBorder:#e6e2da;
  --chipBg:#f6f3ec;
  --chipBorder:#e3ded4;

  --dropdownBg:#ffffff;
  --dropdownBorder:#ebe7df;
}

html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text);
  background:#404c69; /* simple fallback */
  -webkit-tap-highlight-color:transparent; touch-action:manipulation;
  overflow-x:hidden;
}

/* Wallpaper layers ‚Äî consistent overlay for both themes */
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background-image: var(--wallpaper);
  background-size: cover; background-repeat:no-repeat;
  background-position: center var(--wallpaper-shift);
  transform: translateZ(0);
}
body::after{
  content:""; position:fixed; inset:0; z-index:-1;
  background: rgba(64,76,105,.9);
  pointer-events:none;
}

.app{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:18px;grid-template-rows:auto auto 1fr auto}
.panel{background:var(--panel);border:1px solid var(--panelBorder);box-shadow:var(--shadow);border-radius:var(--radius);padding:14px}

/* Header: logo + title left, hamburger right */
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.h-left{display:flex;align-items:center;gap:14px;min-width:0}
.brand{display:flex;align-items:center;gap:10px}
.brand img{height:38px;display:block;cursor:pointer}
.title{font-weight:800;letter-spacing:.2px}
.title .small{font-weight:600;font-size:.85rem;color:var(--muted)}

/* Hamburger dropdown (text-only items) */
.menu-wrap{position:relative}
.hamburger{font:inherit;cursor:pointer;background:var(--chipBg);border:1px solid var(--chipBorder);border-radius:12px;color:var(--text);padding:10px 12px}
.menu-dropdown{
  position:absolute; right:0; top:110%; min-width:200px; z-index:20;
  background:var(--dropdownBg); border:1px solid var(--dropdownBorder); border-radius:12px;
  box-shadow:var(--shadow); padding:6px; display:none;
}
.menu-dropdown.open{display:block}
.menu-item{display:block; width:100%; text-align:left; padding:10px 12px; border:none; background:transparent; color:var(--text); border-radius:10px; cursor:pointer}
.menu-item:hover{background:var(--chipBg)}

/* Board */
.board{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
@media(min-width:900px){.board{grid-template-columns:repeat(3,minmax(0,1fr))}}
.card{display:grid;gap:10px;background:var(--panel);border:1px solid var(--panelBorder);border-radius:16px;padding:14px;min-height:190px}
.card .head{display:flex;align-items:center;justify-content:space-between}
.chore-name{font-weight:800}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chipBg);border:1px solid var(--chipBorder)}
.person{display:flex;align-items:center;gap:10px}
.face{width:52px;height:52px;border-radius:50%;background:var(--chipBg);display:grid;place-items:center;font-size:24px;border:2px solid var(--chipBorder);overflow:hidden}
.face img{width:100%;height:100%;object-fit:cover}
.selector{display:flex;gap:8px;align-items:center}
.select{max-width:100%}
.swap{outline:2px solid transparent}
.swap[aria-selected="true"]{outline:2px solid var(--accent)}
.help{opacity:.8}

/* Done circles row */
.dots{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap}
.dot{
  width:36px;height:36px;border-radius:999px;
  background:var(--chipBg);border:1px solid var(--chipBorder);
  display:grid;place-items:center;
  font-weight:800;font-size:.85rem;color:#cbd5e1;
  cursor:pointer; user-select:none;
}
html[data-theme="light"] .dot{ color:#334155; }
.dot.done{
  background:#0f766e; border-color:#0d9488; color:#e6fffa;
  box-shadow: inset 0 0 0 2px rgba(0,0,0,.18);
}
.dot:active{transform:translateY(1px)}

/* Modal (Manage) */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.modal{width:min(900px,100%);background:var(--panel);border:1px solid var(--panelBorder);border-radius:16px;box-shadow:var(--shadow)}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--panelBorder)}
.modal .body{padding:14px 16px;display:grid;gap:16px}
.modal .footer{padding:14px 16px;border-top:1px solid var(--panelBorder);display:flex;justify-content:flex-end;gap:10px}
.list{display:grid;gap:10px}
.item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;background:var(--card);border:1px solid var(--panelBorder);border-radius:12px;padding:10px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.chklist{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
@media(min-width:720px){.chklist{grid-template-columns:repeat(3,minmax(0,1fr))}}
.footer{text-align:center;opacity:.7;font-size:.85rem}
.version{opacity:.6;font-size:.8rem;margin-top:6px}
input[type="text"]{background:var(--card);border:1px solid var(--panelBorder);border-radius:12px;padding:10px 12px;color:var(--text);font:inherit}
.btn-primary{background:linear-gradient(180deg,var(--accent),color-mix(in oklab, var(--accent) 70%, #0891b2 30%));color:#001018;border:none;font-weight:700}
.btn-ghost{background:transparent;border:1px dashed var(--chipBorder);color:var(--muted)}
.icon-btn{padding:6px 10px;border-radius:10px;border:1px solid var(--chipBorder);background:var(--chipBg);cursor:pointer}

/* a11y helper (used for "Assign" label) */
.sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>
  <div class="app">
    <header class="panel">
      <div class="h-left">
        <a href="./index.html" class="brand" title="Home">
          <img src="fambam.png" alt="Fambam">
        </a>
        <div class="title">
          <div style="font-size:1.6rem">Chores</div>
          <div class="small">Weekly rotation (Mon‚ÄìSun). Tap a card to swap or use the dropdown to reassign.</div>
        </div>
      </div>
      <div class="menu-wrap">
        <button id="btnHamburger" class="hamburger" aria-haspopup="true" aria-expanded="false" aria-controls="menuDropdown">‚ò∞</button>
        <div id="menuDropdown" class="menu-dropdown" role="menu" aria-hidden="true">
          <button class="menu-item" data-action="shuffle">Shuffle</button>
          <button class="menu-item" data-action="manage">Manage</button>
        </div>
      </div>
    </header>

    <section class="panel" id="weekPanel">
      <div class="row">
        <div class="help">Week of <b id="weekLabel"></b></div>
      </div>
    </section>

    <section class="board" id="board"></section>

    <div class="footer">
      Works offline. Data stays on this device (local only).
      <div class="version">Chores v1.3.1 ‚Äî theme-ready</div>
    </div>
  </div>

  <!-- Manage Modal -->
  <div class="modal-backdrop" id="manageModal" aria-hidden="true" role="dialog" aria-labelledby="manageTitle">
    <div class="modal">
      <header>
        <div id="manageTitle" style="font-weight:800">Manage Chores</div>
        <button id="manageClose" class="icon-btn">‚úñ</button>
      </header>
      <div class="body">
        <div class="help">Edit the chore list and which kids participate in the rotation.</div>

        <div>
          <div class="badge">Chore List</div>
          <div class="list" id="choreList"></div>
          <div class="row">
            <input id="newChore" type="text" placeholder="Add chore (e.g., Trash)" />
            <button id="addChore" class="btn-primary">Add</button>
          </div>
        </div>

        <div>
          <div class="badge">Eligible Kids</div>
          <div id="kidChecks" class="chklist"></div>
          <div class="help">Only checked kids will be included in the weekly rotation.</div>
        </div>
      </div>
      <div class="footer">
        <button id="manageSave" class="btn-primary">Save</button>
      </div>
    </div>
  </div>

<!-- Family Store -->
<script src="family.js?v=3.3.6"></script>
<script>
// Minimal shim if family.js misses
if (!window.Family) {
  console.warn('family.js not loaded ‚Äî using fallback Family shim (Chores).');
  (function(){
    const K={parents:'hub:family:parents', kids:'hub:family:kids'};
    const uid=()=>Math.random().toString(36).slice(2,10);
    const load=(k,f)=>{ try{const v=JSON.parse(localStorage.getItem(k)); return v ?? f;}catch{ return f; } };
    const save=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
    window.Family = {
      getKids(){ return load(K.kids, []); },
      getActiveKids(){ return this.getKids().filter(k=>k.enabled!==false); },
      upsertKid(k){ const a=this.getKids(); const i=a.findIndex(x=>x.id===k.id);
        if(i>=0) a[i]={...a[i],...k}; else a.push({...k,id:k.id||uid(),enabled:true}); save(K.kids,a); },
      onChange(){ return ()=>{}; }
    };
  })();
}

// ---------- Storage keys ----------
const LS = {
  chores: 'ch:chores:list',            // [{id,label}]
  elig:   'ch:eligible:kids',          // [kidId]
  week:   (mondayISO)=> `ch:assign:${mondayISO}`, // { [choreId]: kidId }
  done:   (mondayISO)=> `ch:done:${mondayISO}`    // { [choreId]: {Mon:true,...} }
};

const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
const uid=()=>Math.random().toString(36).slice(2,10);
const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{ return f;}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const initials=n=>((n||'?').trim()[0]||'?').toUpperCase();

function getKids(){
  try{
    if(Family && typeof Family.getActiveKids==='function'){
      const k=Family.getActiveKids(); if(Array.isArray(k)) return k;
    }
    if(Family && typeof Family.getKids==='function'){
      const k=Family.getKids(); if(Array.isArray(k)) return k.filter(x=>x.enabled!==false);
    }
  }catch(e){ console.warn('Family store unavailable',e); }
  return [];
}

/* ---------- Local week helpers (Mon‚ÄìSun, STRICTLY LOCAL) ---------- */
function localISO(d){
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function startOfWeekMondayLocal(d=new Date()){
  const monday=new Date(d);
  monday.setHours(0,0,0,0);
  const offset=((monday.getDay()+6)%7); // Mon=0..Sun=6
  monday.setDate(monday.getDate()-offset);
  return monday;
}
function thisMondayISO(){ return localISO(startOfWeekMondayLocal(new Date())); }

/* ---------- Defaults ---------- */
function ensureDefaults(){
  let chores = load(LS.chores, null);
  if(!Array.isArray(chores) || !chores.length){
    chores = [
      {id:uid(), label:'Trash'},
      {id:uid(), label:'Vacuuming'},
      {id:uid(), label:'Feed Dogs'}
    ];
    save(LS.chores, chores);
  }
  // Default: ALL current kids eligible (and repair if elig isn't set yet)
  let elig = load(LS.elig, null);
  const kids = getKids().slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  if(!Array.isArray(elig) || elig.length===0){
    elig = kids.map(k=>k.id);
    save(LS.elig, elig);
  }
}

/* ---------- Rotation logic (local weeks) ---------- */
function rotateForWeek(mondayISO){
  const chores = load(LS.chores, []);
  const eligIds = load(LS.elig, []).filter(id => getKids().some(k=>k.id===id));
  if(!chores.length || !eligIds.length) return {};

  // previous week (local)
  const prev = new Date(mondayISO);
  prev.setDate(prev.getDate()-7);
  const prevISO = localISO(prev);
  const prevMap = load(LS.week(prevISO), null);

  let assignment = {};
  if(prevMap){
    const base = eligIds.slice();
    chores.forEach((c,i)=> assignment[c.id] = base[(i+1)%base.length]); // simple rotate
  } else {
    chores.forEach((c,i)=> assignment[c.id] = eligIds[i%eligIds.length]);
  }
  save(LS.week(mondayISO), assignment);
  return assignment;
}

/* ---------- Done map (per week) ---------- */
const DAY_KEYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const DAY_LABELS = ['M','T','W','T','F','S','S'];

function loadWeekDone(){ return load(LS.done(thisMondayISO()), {}) || {}; }
function saveWeekDone(map){ save(LS.done(thisMondayISO()), map); }

/* ---------- UI render ---------- */
let selectedChoreId = null;

function weekLabelText(mISO){
  const [Y,M,D]=mISO.split('-').map(n=>parseInt(n,10));
  const m = new Date(Y, M-1, D, 0,0,0,0);
  const e = new Date(m); e.setDate(e.getDate()+6);
  const fmt = d => d.toLocaleDateString(undefined,{month:'short',day:'numeric'});
  return `${fmt(m)} ‚Äì ${fmt(e)}`;
}

function renderBoard(){
  const mondayISO = thisMondayISO();
  $('#weekLabel').textContent = weekLabelText(mondayISO);

  const chores = load(LS.chores, []);
  const kids = getKids();
  const assigns = load(LS.week(mondayISO), {}) || {};
  const doneMap = loadWeekDone();

  const board = $('#board'); board.innerHTML='';
  if(!chores.length){
    const n=document.createElement('div'); n.className='panel'; n.textContent='No chores defined. Tap ‚ÄúManage‚Äù.';
    board.appendChild(n); return;
  }
  if(!kids.length){
    const n=document.createElement('div'); n.className='panel'; n.textContent='No active kids. Add/enable kids in Admin (on Home).';
    board.appendChild(n); return;
  }

  chores.forEach(c=>{
    const kidId = assigns[c.id];
    const kid = kids.find(k=>k.id===kidId) || null;
    const done = doneMap[c.id] || {};

    const dotsHTML = DAY_KEYS.map((k,idx)=>{
      const lbl = DAY_LABELS[idx];
      const isDone = !!done[k];
      return `<button class="dot ${isDone?'done':''}" data-chore="${c.id}" data-day="${k}" aria-pressed="${isDone}" title="${k}">${lbl}</button>`;
    }).join('');

    const card=document.createElement('div'); card.className='card'; card.dataset.chore=c.id;
    card.innerHTML = `
      <div class="head">
        <div class="chore-name">${c.label}</div>
        <div class="badge">Weekly</div>
      </div>
      <div class="person">
        <div class="face">${kid?.photo?`<img src="${kid.photo}" alt="">`:`<span>${initials(kid?.name||'?')}</span>`}</div>
        <div style="font-weight:800">${kid? kid.name : 'Unassigned'}</div>
      </div>
      <div class="selector">
        <label class="sr-only" for="sel-${c.id}">Assign</label>
        <select id="sel-${c.id}" class="select">
          ${kidOptions(kidId)}
        </select>
        <button class="icon-btn swapBtn" title="Tap to select for swap">üîÅ</button>
      </div>
      <div class="dots" aria-label="Completion">${dotsHTML}</div>
    `;
    board.appendChild(card);
  });

  // assignment changes
  $$('.card .select', board).forEach(sel=>{
    sel.onchange = (e)=>{
      const choreId = e.target.id.slice(4);
      assignKid(choreId, e.target.value);
    };
  });

  // swap
  $$('.swapBtn', board).forEach(btn=>{
    btn.onclick = ()=>{
      const card = btn.closest('.card');
      const cid = card.dataset.chore;
      if(selectedChoreId === cid){
        selectedChoreId = null;
        card.classList.remove('swap'); card.setAttribute('aria-selected','false');
        return;
      }
      if(selectedChoreId){
        const a = selectedChoreId, b = cid; selectedChoreId=null;
        $$('.card').forEach(c=>{c.classList.remove('swap'); c.setAttribute('aria-selected','false');});
        swapAssignees(a,b);
      } else {
        selectedChoreId = cid;
        card.classList.add('swap'); card.setAttribute('aria-selected','true');
      }
    };
  });

  // done toggles
  $$('.dot', board).forEach(dot=>{
    dot.onclick = ()=>{
      const choreId = dot.dataset.chore;
      const dayKey  = dot.dataset.day;
      const map = loadWeekDone();
      const entry = map[choreId] || {};
      entry[dayKey] = !entry[dayKey];
      map[choreId] = entry;
      saveWeekDone(map);
      dot.classList.toggle('done', !!entry[dayKey]);
      dot.setAttribute('aria-pressed', entry[dayKey] ? 'true' : 'false');
    };
  });
}

function kidOptions(selectedId){
  const eligIds = load(LS.elig, []);
  const kids = getKids().filter(k=> eligIds.includes(k.id));
  return kids.map(k=>`<option value="${k.id}" ${k.id===selectedId?'selected':''}>${k.name}</option>`).join('');
}

/* ---------- Assignments ---------- */
function currentAssigns(){ return load(LS.week(thisMondayISO()), {}) || {}; }
function saveAssigns(a){ save(LS.week(thisMondayISO()), a); renderBoard(); }
function assignKid(choreId, kidId){ const a = currentAssigns(); a[choreId]=kidId; saveAssigns(a); }
function swapAssignees(choreIdA, choreIdB){
  const a = currentAssigns();
  const x=a[choreIdA], y=a[choreIdB]; a[choreIdA]=y; a[choreIdB]=x; saveAssigns(a);
}

/* ---------- Manage modal ---------- */
const manageModal = document.getElementById('manageModal');
document.getElementById('manageClose').onclick = ()=> hide(manageModal);
document.getElementById('manageSave').onclick = ()=>{
  hide(manageModal);
  ensureAssignmentsForThisWeek();
  renderBoard();
};
document.getElementById('addChore').onclick = ()=>{
  const label = (document.getElementById('newChore').value||'').trim();
  if(!label) return;
  const chores = load(LS.chores, []);
  chores.push({id:uid(), label});
  save(LS.chores, chores);
  document.getElementById('newChore').value=''; buildManageLists();
};

function openManage(){ buildManageLists(); show(manageModal); }
function buildManageLists(){
  const chores = load(LS.chores, []);
  const list = document.getElementById('choreList'); list.innerHTML='';
  chores.forEach(c=>{
    const row=document.createElement('div'); row.className='item'; row.dataset.id=c.id;
    row.innerHTML=`
      <input class="lbl" type="text" value="${escapeHtml(c.label)}"/>
      <button class="btn-ghost" data-remove>Remove</button>
    `;
    list.appendChild(row);
  });
  list.querySelectorAll('.item').forEach(row=>{
    const id=row.dataset.id;
    row.querySelector('.lbl').oninput = (e)=>{
      const chores = load(LS.chores, []);
      const i=chores.findIndex(x=>x.id===id); if(i>=0){ chores[i].label=e.target.value; save(LS.chores, chores); renderBoard(); }
    };
    row.querySelector('[data-remove]').onclick = ()=>{
      const chores = load(LS.chores, []).filter(x=>x.id!==id);
      save(LS.chores, chores);
      const a = currentAssigns(); if(id in a){ delete a[id]; saveAssigns(a); }
      const d = loadWeekDone(); if(id in d){ delete d[id]; saveWeekDone(d); }
      buildManageLists(); renderBoard();
    };
  });

  // Eligible kids
  const wrap = document.getElementById('kidChecks'); wrap.innerHTML='';
  const kids = getKids();
  let elig = load(LS.elig, []);
  if(!Array.isArray(elig) || elig.length===0){ elig = kids.map(k=>k.id); save(LS.elig, elig); }
  kids.forEach(k=>{
    const id=`k-${k.id}`;
    const div=document.createElement('label'); div.style.display='flex'; div.style.gap='8px'; div.style.alignItems='center';
    div.innerHTML=`<input id="${id}" type="checkbox" ${elig.includes(k.id)?'checked':''}/> ${escapeHtml(k.name)}`;
    wrap.appendChild(div);
    div.querySelector('input').onchange = (e)=>{
      let cur = load(LS.elig, []);
      if(e.target.checked){ if(!cur.includes(k.id)) cur.push(k.id); }
      else { cur = cur.filter(x=>x!==k.id); }
      save(LS.elig, cur);
      ensureAssignmentsForThisWeek();
      renderBoard();
    };
  });
}

function show(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function hide(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

/* ---------- Boot / weekly ensure ---------- */
function ensureAssignmentsForThisWeek(){
  const mondayISO = thisMondayISO();
  let a = load(LS.week(mondayISO), null);
  if(!a){
    a = rotateForWeek(mondayISO);
  } else {
    const chores = load(LS.chores, []);
    const eligIds = load(LS.elig, []);
    const kids = getKids().filter(k=>eligIds.includes(k.id));
    chores.forEach((c,i)=>{
      if(!a[c.id] && kids.length){ a[c.id]=kids[i%kids.length].id; }
    });
    save(LS.week(mondayISO), a);
  }
}

/* ----- Header hamburger actions ----- */
(function hamburger(){
  const btn = document.getElementById('btnHamburger');
  const dd  = document.getElementById('menuDropdown');
  const open = ()=>{ dd.classList.add('open'); btn.setAttribute('aria-expanded','true'); dd.setAttribute('aria-hidden','false'); };
  const close= ()=>{ dd.classList.remove('open'); btn.setAttribute('aria-expanded','false'); dd.setAttribute('aria-hidden','true'); };

  btn.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.contains('open')?close():open(); });
  document.addEventListener('click', (e)=>{ if (!dd.contains(e.target) && e.target!==btn) close(); });

  dd.addEventListener('click', (e)=>{
    const a = e.target.closest('.menu-item'); if(!a) return;
    close();
    const act = a.dataset.action;
    if (act==='shuffle'){ rotateForWeek(thisMondayISO()); renderBoard(); }
    else if (act==='manage'){ openManage(); }
  });
})();

/* ----- Init & react to Family changes ----- */
ensureDefaults();
ensureAssignmentsForThisWeek();
renderBoard();

try {
  Family.onChange && Family.onChange(()=> {
    const kids = getKids();
    let elig = load(LS.elig, []);
    if(!Array.isArray(elig) || elig.length===0){
      elig = kids.map(k=>k.id); save(LS.elig, elig);
    }
    ensureAssignmentsForThisWeek();
    renderBoard();
  });
} catch(_){}

if('serviceWorker' in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
</script>
</body>
</html>