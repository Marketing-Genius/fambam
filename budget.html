<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam · Budget</title>

<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<link rel="stylesheet" href="wallpaper.css">
<link rel="stylesheet" href="fambam.css">
<script src="wallpaper.js" defer></script>

<style>
/* ---- Budget (scoped) ---- */
.page-budget .app{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:16px}
.page-budget .header{align-items:center}
.bbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.bbtn{background:var(--chipBg);border:1px solid var(--chipBorder);border-radius:12px;padding:8px 10px;color:var(--text);cursor:pointer}
.blabel{padding:6px 10px;border-radius:999px;background:var(--card);border:1px solid var(--panelBorder)}
.summary{display:grid;gap:10px}
@media(min-width:860px){.summary{grid-template-columns:repeat(3,minmax(0,1fr))}}
.card-kpi{background:var(--card);border:1px solid var(--panelBorder);border-radius:14px;padding:12px}
.card-kpi .hd{opacity:.8;font-weight:700}
.card-kpi .num{font-weight:800;font-size:1.2rem;margin-top:4px}

.grid2{display:grid;gap:14px}
@media(min-width:940px){.grid2{grid-template-columns:1fr 1fr}}
.panel{background:var(--panel);border:1px solid var(--panelBorder);border-radius:18px;padding:14px;box-shadow:var(--shadow)}

.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.tr{display:grid;grid-template-columns:1.2fr .6fr .6fr .9fr .7fr;gap:8px;align-items:center;
     background:var(--card);border:1px solid var(--panelBorder);border-radius:12px;padding:8px 10px}
.tr .mi{opacity:.8}
.badge{display:inline-flex;gap:6px;align-items:center;background:var(--chipBg);
  border:1px solid var(--chipBorder);border-radius:999px;padding:4px 8px;color:var(--muted)}
.right{margin-left:auto}
.fab{position:fixed;right:20px;bottom:20px;z-index:4000;width:56px;height:56px;border-radius:999px;
  display:grid;place-items:center;background:var(--accent);color:#001018;border:none;font-size:26px;box-shadow:var(--shadow);cursor:pointer}

input,select{background:var(--card);border:1px solid var(--panelBorder);border-radius:10px;color:var(--text);padding:6px 8px;font:inherit}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:5000;padding:20px}
.modal{width:min(680px,100%);background:var(--panel);border:1px solid var(--panelBorder);border-radius:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;max-height:90vh}
.modal header,.modal .footer{padding:12px 14px;border-bottom:1px solid var(--tileBorder)}
.modal .footer{border-top:1px solid var(--tileBorder);border-bottom:none;display:flex;gap:8px;justify-content:flex-end}
.modal .body{padding:12px 14px;display:grid;gap:10px;overflow:auto}
.row{display:grid;gap:8px;grid-template-columns:1fr 1fr}
@media(max-width:560px){.row{grid-template-columns:1fr}}
</style>

<script>
/* Theme + header float (same boot you use elsewhere) */
(function headerBoot(){
  function apply(){
    try{
      const on = JSON.parse(localStorage.getItem('ui:headerFloat') || 'false');
      document.body.classList.toggle('header-float', !!on);
    }catch(_){}
  }
  (document.readyState==='loading')?document.addEventListener('DOMContentLoaded',apply,{once:true}):apply();
  addEventListener('storage',e=>{ if(e.key==='ui:headerFloat') apply(); });
})();
</script>
</head>

<body class="page-budget">
<div class="app">
  <header class="panel header app-header">
    <a class="brand" href="./index.html"><img src="fambam.png" alt="Fambam" style="height:38px"></a>
    <div class="title">Budget</div>
    <div class="bbar" style="margin-left:auto">
      <button id="mPrev" class="bbtn">◀</button>
      <span id="mLabel" class="blabel">—</span>
      <button id="mNext" class="bbtn">▶</button>
      <button id="mToday" class="bbtn">This month</button>
    </div>
  </header>

  <section class="summary">
    <div class="card-kpi"><div class="hd">Spent / Planned</div><div id="kSpent" class="num">—</div></div>
    <div class="card-kpi"><div class="hd">Upcoming 7 days</div><div id="kUpcoming" class="num">—</div></div>
    <div class="card-kpi"><div class="hd">Settle-up</div><div id="kSettle" class="num">—</div></div>
  </section>

  <section class="grid2">
    <div class="panel">
      <div style="font-weight:800;margin-bottom:8px">Recurring Bills</div>
      <div id="recTable" class="table" aria-live="polite"></div>
    </div>
    <div class="panel">
      <div style="font-weight:800;margin-bottom:8px">Transactions</div>
      <div id="txTable" class="table" aria-live="polite"></div>
    </div>
  </section>

  <footer style="text-align:center;opacity:.7">Works offline. Data stays on this device (local only).</footer>
</div>

<button id="fabAdd" class="fab" title="Add expense">＋</button>

<!-- Add/Edit Transaction Modal -->
<div id="txModal" class="modal-backdrop" role="dialog" aria-hidden="true">
  <div class="modal">
    <header><div style="font-weight:800">Add Expense</div></header>
    <div class="body">
      <div class="row">
        <label>Label <input id="fLabel" placeholder="Costco"/></label>
        <label>Date <input id="fDate" type="date"/></label>
      </div>
      <div class="row">
        <label>Amount <input id="fAmount" type="number" step="0.01" inputmode="decimal"/></label>
        <label>Category
          <select id="fCat"></select>
        </label>
      </div>
      <div class="row">
        <label>Payer
          <select id="fPayer"></select>
        </label>
        <label>Split
          <select id="fSplitType">
            <option value="percent">Percent</option>
            <option value="amount">Amount</option>
            <option value="ratio">Ratio</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label id="labA">Parent A <input id="fA" type="number" step="0.01"/></label>
        <label id="labB">Parent B <input id="fB" type="number" step="0.01"/></label>
      </div>
      <label>Notes <input id="fNotes" /></label>
    </div>
    <div class="footer">
      <button class="bbtn" id="txCancel">Cancel</button>
      <button class="bbtn" id="txSave">Save</button>
    </div>
  </div>
</div>

<script src="family.js?v=3.3.6"></script>
<script>
/* ----------------- Data helpers ----------------- */
const LS = {
  cats: 'bdg:cats',
  rules:'bdg:rules',
  rec:  'bdg:recurring',
  tx:   (ym)=>`bdg:tx:${ym}`,
  map:  'bdg:parentsMap'
};
const $ = (s,e=document)=>e.querySelector(s);
const load=(k,f)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return v??f; }catch{ return f; } };
const save=(k,v)=>localStorage.setItem(k, JSON.stringify(v));

/* Map parents -> {A: id1, B: id2} */
function ensureParentsMap(){
  let map = load(LS.map,null);
  const parents = (window.Family?.getParents?.()||[]);
  if(!map || !parents.some(p=>p.id===map.A) || !parents.some(p=>p.id===map.B)){
    // pick first two deterministically by name
    const sorted = parents.slice().sort((a,b)=>(a.name||'').localeCompare(b.name||''));
    map = { A: sorted[0]?.id || 'PARENT_A', B: sorted[1]?.id || 'PARENT_B' };
    save(LS.map, map);
  }
  return map;
}
function parentLabel(key){
  const map = ensureParentsMap();
  const id = map[key];
  const parents = (window.Family?.getParents?.()||[]);
  return parents.find(p=>p.id===id)?.name || (key==='A'?'Parent A':'Parent B');
}

/* Month helpers */
function ym(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
let state = { month: ym(new Date()) };

/* Seed defaults */
(function seed(){
  if(!load(LS.cats,null)) save(LS.cats, ["Mortgage","Utilities","Internet","Groceries","Kids Sports","Subscriptions","Misc"]);
  if(!load(LS.rules,null)) save(LS.rules, {
    "Mortgage": {"type":"percent","A":60,"B":40},
    "Groceries":{"type":"percent","A":50,"B":50}
  });
  if(!load(LS.rec,null)) save(LS.rec, [
    {"id":"rec1","label":"Mortgage","amount":2400,"dueDay":1,"category":"Mortgage","split":{"type":"percent","A":60,"B":40}},
    {"id":"rec2","label":"Internet","amount":75,"dueDay":7,"category":"Internet","split":{"type":"percent","A":50,"B":50}},
    {"id":"rec3","label":"Netflix","amount":19.99,"dueDay":12,"category":"Subscriptions","split":{"type":"percent","A":0,"B":100}}
  ]);
})();

/* ----------------- Compute splits ----------------- */
function sharesFor(amount, split){
  const A = Number(split.A||0), B = Number(split.B||0);
  const t = (split.type||'percent');
  if(t==='amount') return {A, B};
  if(t==='ratio'){
    const sum = (A+B)||1; return { A: amount*(A/sum), B: amount*(B/sum) };
  }
  // percent
  return { A: amount*(A/100), B: amount*(B/100) };
}
function settleUp(tx){
  // tx = array of {amount, payer:'A'|'B', split:{type,A,B}}
  let paidA=0,paidB=0,shareA=0,shareB=0;
  tx.forEach(t=>{
    const a = Number(t.amount||0);
    const sh = sharesFor(a, t.split||{type:'percent',A:50,B:50});
    shareA+=sh.A; shareB+=sh.B;
    if(t.payer==='A') paidA+=a; else if(t.payer==='B') paidB+=a;
  });
  const netA = paidA - shareA; // + means A fronted more than share
  const netB = paidB - shareB;
  return { netA, netB }; // should sum ~0 (minor rounding)
}

/* ----------------- Render ----------------- */
function monthLabel(ymStr){
  const [y,m]=ymStr.split('-').map(Number);
  const d = new Date(y,m-1,1);
  return d.toLocaleDateString(undefined,{month:'long',year:'numeric'});
}

function render(){
  $('#mLabel').textContent = monthLabel(state.month);

  // Load data
  const cats = load(LS.cats,[]);
  const tx   = load(LS.tx(state.month),[]);
  const rec  = load(LS.rec,[]);
  // KPIs
  const spent = tx.reduce((s,t)=>s+Number(t.amount||0),0);
  $('#kSpent').textContent = `$${spent.toFixed(2)} spent`;
  // Upcoming 7 days from recurring
  const [y,m]=state.month.split('-').map(Number);
  const today=new Date(); const start=new Date(y,m-1, today.getFullYear()===y && today.getMonth()+1===m ? today.getDate() : 1);
  const in7 = rec.filter(r=>{
    const due = new Date(y,m-1, r.dueDay||1);
    const diff = (due - today)/(1000*60*60*24);
    return diff>=0 && diff<=7;
  }).length;
  $('#kUpcoming').textContent = `${in7} bill${in7===1?'':'s'} due`;

  const {netA,netB} = settleUp(tx);
  const aName=parentLabel('A'), bName=parentLabel('B');
  $('#kSettle').textContent =
    netA>0 ? `${bName} owes ${aName} $${Math.abs(netA).toFixed(2)}`
  : netB>0 ? `${aName} owes ${bName} $${Math.abs(netB).toFixed(2)}`
  : 'Even';

  // Recurring table
  const rWrap = $('#recTable'); rWrap.innerHTML='';
  rec.forEach(r=>{
    const row=document.createElement('div'); row.className='tr';
    row.innerHTML = `
      <div><b>${r.label}</b><div class="mi">${r.category||''}</div></div>
      <div>Due ${r.dueDay||1}</div>
      <div>$${Number(r.amount).toFixed(2)}</div>
      <div class="mi">${r.split?.type||'percent'} ${r.split?.A||0}/${r.split?.B||0}</div>
      <div class="right"><button class="bbtn" data-add>Add</button></div>
    `;
    row.querySelector('[data-add]').onclick = ()=>{
      openTxModal({
        label:r.label, date:`${state.month}-${String(Math.min(r.dueDay||1,28)).padStart(2,'0')}`,
        amount:r.amount, category:r.category, payer:'A', split:r.split
      });
    };
    rWrap.appendChild(row);
  });

  // Transactions table
  const tWrap = $('#txTable'); tWrap.innerHTML='';
  tx.forEach(t=>{
    const shares = sharesFor(Number(t.amount||0), t.split||{type:'percent',A:50,B:50});
    const row=document.createElement('div'); row.className='tr';
    row.innerHTML = `
      <div><b>${t.label||'—'}</b><div class="mi">${t.category||''}</div></div>
      <div>${t.date||''}</div>
      <div>$${Number(t.amount||0).toFixed(2)}</div>
      <div class="mi">${parentLabel('A')}: $${shares.A.toFixed(2)} · ${parentLabel('B')}: $${shares.B.toFixed(2)}</div>
      <div class="right badge">${t.payer==='A'?parentLabel('A'):parentLabel('B')}</div>
    `;
    tWrap.appendChild(row);
  });
}

/* ----------------- Modal ----------------- */
function fillSelects(){
  // categories
  const cats = load(LS.cats,[]);
  const s = $('#fCat'); s.innerHTML=''; cats.forEach(c=>{ const o=document.createElement('option'); o.value=o.textContent=c; s.appendChild(o); });
  // payers
  const p = $('#fPayer'); p.innerHTML='';
  [['A',parentLabel('A')],['B',parentLabel('B')]].forEach(([v,l])=>{
    const o=document.createElement('option'); o.value=v; o.textContent=l; p.appendChild(o);
  });
  $('#labA').firstChild.textContent = parentLabel('A')+' ';
  $('#labB').firstChild.textContent = parentLabel('B')+' ';
}
function openTxModal(seed){
  fillSelects();
  $('#fLabel').value  = seed?.label||'';
  $('#fDate').value   = seed?.date || (new Date().toISOString().slice(0,10));
  $('#fAmount').value = seed?.amount||'';
  $('#fCat').value    = seed?.category||($('#fCat option')?.[0]?.value||'Misc');
  $('#fPayer').value  = seed?.payer||'A';
  const sp = seed?.split || {type:'percent',A:50,B:50};
  $('#fSplitType').value = sp.type||'percent';
  $('#fA').value = sp.A||0; $('#fB').value = sp.B||0;
  $('#fNotes').value = seed?.notes||'';
  show($('#txModal'));
}
function show(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function hide(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }

$('#fabAdd').onclick = ()=> openTxModal({});
$('#txCancel').onclick = ()=> hide($('#txModal'));
$('#txSave').onclick = ()=>{
  const tx = load(LS.tx(state.month),[]);
  tx.unshift({
    id: Math.random().toString(36).slice(2,10),
    label: $('#fLabel').value.trim() || 'Expense',
    date:  $('#fDate').value,
    amount: Number($('#fAmount').value||0),
    category: $('#fCat').value,
    payer: $('#fPayer').value,
    split: { type: $('#fSplitType').value, A: Number($('#fA').value||0), B: Number($('#fB').value||0) },
    notes: $('#fNotes').value.trim()
  });
  save(LS.tx(state.month), tx);
  hide($('#txModal'));
  render();
};

/* Month nav */
$('#mPrev').onclick=()=>{ const [y,m]=state.month.split('-').map(Number); const d=new Date(y,m-2,1); state.month=ym(d); render(); };
$('#mNext').onclick=()=>{ const [y,m]=state.month.split('-').map(Number); const d=new Date(y,m,1); state.month=ym(d); render(); };
$('#mToday').onclick=()=>{ state.month=ym(new Date()); render(); };

/* Boot */
ensureParentsMap();
render();
addEventListener('storage', e=>{
  if(!e.key) return;
  if(e.key===LS.rec || e.key===LS.cats || e.key===LS.rules || e.key===LS.map || e.key.startsWith('bdg:tx:')) render();
});
if('serviceWorker' in navigator){ addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{})); }
</script>
</body>
</html>
