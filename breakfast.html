<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam · Breakfast Chooser</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<!-- Shared wallpaper styles + logic -->
<link rel="stylesheet" href="wallpaper.css">
<script src="wallpaper.js" defer></script>

<!-- THEME BOOT (Dark/Light + Accent + Auto Logo Swap) -->
<script>
/* Reads localStorage `ui:theme` = { mode:"dark"|"light", accent:"#RRGGBB" }.
   Applies immediately, syncs <meta name="theme-color">, and swaps Fambam logo.
   Expects `fambam.png` (dark) and `fambam2.png` (light) in the same directory. */
(function () {
  var DARK_SRC  = 'fambam.png';
  var LIGHT_SRC = 'fambam2.png';

  function findLogo() {
    return (
      document.getElementById('logoImg') ||
      document.querySelector('.brand img') ||
      document.querySelector('header .title img') ||
      document.querySelector('img[alt="Fambam"]') ||
      null
    );
  }

  function swapLogoForMode(mode) {
    var logo = findLogo();
    if (!logo) return;

    var cur = logo.getAttribute('src') || '';
    var next;
    if (/fambam2?\.png$/i.test(cur)) {
      next = cur.replace(/fambam2?\.png$/i, mode === 'light' ? 'fambam2.png' : 'fambam.png');
    } else {
      next = (mode === 'light') ? LIGHT_SRC : DARK_SRC;
    }
    logo.setAttribute('src', next);

    var a = logo.closest('a');
    if (a && !a.getAttribute('href')) a.setAttribute('href', './index.html');
  }

  function applyTheme(t) {
    var mode   = (t && t.mode === 'light') ? 'light' : 'dark';
    var accent = (t && t.accent) || '#22d3ee';

    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.style.setProperty('--accent', accent);

    var meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', mode === 'light' ? '#f2efe7' : '#0f172a');

    swapLogoForMode(mode);
    document.addEventListener('DOMContentLoaded', function(){ swapLogoForMode(mode); }, { once:true });
  }

  try {
    var raw = localStorage.getItem('ui:theme');
    var saved = raw ? JSON.parse(raw) : { mode: 'dark', accent: '#22d3ee' };
    applyTheme(saved);
  } catch (_) {
    applyTheme({ mode: 'dark', accent: '#22d3ee' });
  }

  window.addEventListener('storage', function (e) {
    if (e.key !== 'ui:theme') return;
    try { applyTheme(JSON.parse(e.newValue || '{}')); } catch (_) {}
  });
})();
</script>

<style>
/* --- layout sanity --- */
*, *::before, *::after { box-sizing: border-box; }

/* Tokens (match index/calendar) */
:root{
  --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
  --bg:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;

  --panelBorder:#0b1224;
  --chipBg:#0b1224;
  --chipBorder:#334155;

  --dropdownBg:#111827;
  --dropdownBorder:#1f2937;

  --wallpaper:url(''); --wallpaper-shift:40%;
}

/* LIGHT THEME OVERRIDES (soft ivory palette) */
html[data-theme="light"]{
  --panel:#f2efe7;
  --card:#ffffff;
  --muted:#556070;
  --text:#0f1623;
  --bg:#f0ece4;
  --shadow:0 10px 28px rgba(0,0,0,.08);

  --panelBorder:#e6e2da;
  --chipBg:#f6f3ec;
  --chipBorder:#e3ded4;

  --dropdownBg:#ffffff;
  --dropdownBorder:#ebe7df;
}

html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  color:var(--text);
  background:#404c69; /* simple fallback */
  -webkit-tap-highlight-color:transparent; touch-action:manipulation;
  overflow-x:hidden;
}

/* Wallpaper layers — consistent overlay for both themes */
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background-image: var(--wallpaper);
  background-size: cover; background-repeat:no-repeat;
  background-position: center var(--wallpaper-shift);
  transform: translateZ(0);
}
body::after{
  content:""; position:fixed; inset:0; z-index:-1;
  background: rgba(64,76,105,.9);
  pointer-events:none;
}

.app{max-width:1100px;margin:0 auto;padding:20px;display:grid;gap:18px;grid-template-rows:auto auto 1fr auto}
.panel{background:var(--panel);border:1px solid var(--panelBorder);box-shadow:var(--shadow);border-radius:18px;padding:14px}

/* Header */
header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;position:relative;z-index:1}
.left{display:flex;align-items:center;gap:14px;min-width:0}
.brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit}
.brand img{height:38px;display:block}
.title{min-width:0}
.title .big{font-weight:800;font-size:1.4rem}
.title .small{font-weight:600;font-size:.9rem;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.btn{background:var(--chipBg);border:1px solid var(--chipBorder);border-radius:12px;padding:10px 12px;color:var(--text);font:inherit;cursor:pointer}
.btn-primary{background:linear-gradient(180deg,var(--accent),color-mix(in oklab, var(--accent) 70%, #0891b2 30%));border:none;color:#001018;font-weight:800}
.btn-icon{display:grid;place-items:center;width:44px;height:44px;border-radius:12px;border:1px solid var(--chipBorder);background:var(--chipBg)}

/* Hamburger (match index) */
.menu-wrap{position:relative; z-index: 2; overflow:visible}
.hamburger{font:inherit;cursor:pointer;background:var(--chipBg);color:var(--text);border:1px solid var(--chipBorder);border-radius:12px;padding:10px 12px}
.menu-dropdown{
  position:absolute;right:0;top:110%;min-width:220px;z-index:3 !important;
  background:var(--dropdownBg);border:1px solid var(--dropdownBorder);border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);padding:6px;display:none
}
.menu-dropdown.open{display:block}
.menu-item{width:100%;text-align:left;padding:10px 12px;border:none;background:transparent;color:var(--text);border-radius:10px;cursor:pointer}
.menu-item:hover{background:var(--chipBg)}

/* Kids row — bigger chips */
.kids{display:flex;gap:12px;flex-wrap:wrap}
.kid{
  display:flex;align-items:center;gap:12px;
  background:var(--card);border:1px solid var(--panelBorder);
  border-radius:16px;padding:10px 14px; cursor:grab;
  user-select:none; -webkit-user-select:none;
}
.kid:active{ cursor:grabbing; }
.kid[data-active="true"]{outline:2px solid var(--accent)}
.avatar{
  width:56px;height:56px;border-radius:50%;background:var(--chipBg);
  border:2px solid var(--chipBorder);object-fit:cover;display:grid;place-items:center;
  font-weight:800;color:var(--text); font-size:1.2rem;
}

/* Food cards accept drops */
.card{ position:relative; background:var(--panel); border:1px solid var(--panelBorder);
  border-radius:16px;padding:14px;display:grid;gap:12px }
.card.drop-ok{ outline:2px solid var(--accent); outline-offset:2px; }
.card.drop-bad{ outline:2px solid #7f1d1d; outline-offset:2px; }

/* “Who picked this” pills */
.pill{display:flex;align-items:center;gap:8px;background:var(--card);
  border:1px solid var(--panelBorder);border-radius:999px;padding:6px 10px}
.pill img{width:22px;height:22px;border-radius:50%;object-fit:cover;border:1px solid var(--chipBorder)}

/* Grid can hold up to 8 cards comfortably */
.grid{display:grid;gap:14px}
@media(min-width:780px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media(min-width:1020px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
   
/* Choices grid */
.grid{display:grid;gap:14px}
@media(min-width:780px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
.card{background:var(--panel);border:1px solid var(--panelBorder);border-radius:16px;padding:14px;display:grid;gap:12px}
.card .head{display:flex;align-items:center;justify-content:space-between}
.food{font-size:1.2rem;font-weight:800}
.picks{display:flex;gap:8px;flex-wrap:wrap}
.pill{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--panelBorder);border-radius:999px;padding:6px 10px}
.pill img{width:20px;height:20px;border-radius:50%;object-fit:cover;border:1px solid var(--chipBorder)}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.modal{width:min(720px,100%);max-height:90vh;display:flex;flex-direction:column;
       background:var(--panel);border:1px solid var(--panelBorder);border-radius:16px;box-shadow:var(--shadow)}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--panelBorder);position:sticky;top:0;background:inherit}
.modal .body{padding:14px 16px;display:grid;gap:16px;overflow:auto;max-height:70vh}
.modal .footer{padding:14px 16px;border-top:1px solid var(--panelBorder);display:flex;justify-content:flex-end;gap:10px}
.list{display:grid;gap:10px}
.item{display:grid;grid-template-columns:120px 1fr auto;gap:10px;align-items:center;background:var(--card);border:1px solid var(--panelBorder);border-radius:12px;padding:10px}
input[type="text"]{background:var(--card);border:1px solid var(--panelBorder);border-radius:12px;padding:10px 12px;color:var(--text);font:inherit}

/* Footer hint */
.hint{opacity:.8;font-size:.9rem;text-align:center}
.version{opacity:.6;font-size:.8rem;margin-top:6px}

/* --- Drag infra (match index page behavior) --- */
.dragging, .dragging * {
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  -webkit-tap-highlight-color: transparent;
}
.dragging { touch-action: none; cursor: grabbing; }
html.drag-lock, body.drag-lock { overflow: hidden !important; overscroll-behavior: contain; }

.drag-shield {
  position: fixed; inset: 0; z-index: 9998;
  background: transparent; pointer-events: auto;
  touch-action: none; cursor: grabbing;
}

.drag-ghost{
  position: fixed; left: 0; top: 0;
  transform: translate(-50%,-50%) scale(.98);
  z-index: 9999; pointer-events: none;
  filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
  opacity: .96; overflow: hidden; box-sizing: border-box;
}

/* Make draggables and targets opt-out of native scrolling while interacting */
.kid, .card { touch-action: none; }

/* Drop target highlight */
.card.drop-target { outline: 2px solid var(--accent); outline-offset: 2px; } 
   
</style>
</head>
<body>
  <div class="app">
    <header class="panel">
      <div class="left">
        <!-- Brand = Home button -->
        <a class="brand" href="./index.html" title="Home">
          <img src="fambam.png" alt="Fambam">
        </a>
        <div class="title">
          <div class="big">Breakfast Chooser</div>
          <div class="small">Drag your kid onto a food (or tap a kid, then a food).</div>
        </div>
      </div>

      <div class="controls">
        <label for="theDate" class="small">Date</label>
        <input id="theDate" class="btn" type="date"/>

        <!-- Hamburger menu -->
        <div class="menu-wrap">
          <button id="btnMenu" class="hamburger" aria-haspopup="true" aria-expanded="false" aria-controls="menuDropdown" title="Menu">☰</button>
          <div id="menuDropdown" class="menu-dropdown" role="menu" aria-hidden="true">
            <button class="menu-item" data-action="reset"  role="menuitem">Reset</button>
            <button class="menu-item" data-action="random" role="menuitem">Random</button>
            <button class="menu-item" data-action="share"  role="menuitem">Share</button>
            <button class="menu-item" data-action="manage" role="menuitem">Manage</button>
          </div>
        </div>
      </div>
    </header>

    <section class="panel">
      <div class="kids" id="kidsRow"></div>
    </section>

    <section class="grid" id="choicesGrid"></section>

    <div class="hint">
      Works offline. Data stays on this device (local only).
      <div class="version">Breakfast v3.6.2 — theme-ready</div>
    </div>
  </div>

  <!-- Manage (edit choices) Modal -->
  <div class="modal-backdrop" id="menuModal" aria-hidden="true" role="dialog" aria-labelledby="menuTitle">
    <div class="modal">
      <header>
        <div id="menuTitle" style="font-weight:800">Manage Breakfast Choices</div>
        <button id="menuClose" class="btn">✖</button>
      </header>
      <div class="body">
        <div class="small" style="opacity:.8">Edit up to 8 choices (emoji + name)</div>
        <div id="menuList" class="list"></div>
      </div>
      <div class="footer">
        <button id="menuDone" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- Family store -->
  <script src="family.js?v=3.3.6"></script>
  <script>
  if(!window.Family){
    (function(){
      const K={kids:'hub:family:kids', pin:'hub:family:pin'};
      const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
      window.Family={
        getKids(){ return load(K.kids,[]); },
        verifyPin(p){ const real=load(K.pin,null); return real?String(real)===String(p):true; },
        onChange(){ return ()=>{}; }
      };
    })();
  }
  </script>

  <script>
  const LS = {
    menu:'bf:menu',
    day:(iso)=>`bf:day:${iso}`
  };
  const $=(s,e=document)=>e.querySelector(s);
  const $$=(s,e=document)=>[...e.querySelectorAll(s)];
  const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
  const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

  /* ---------- LOCAL DATE HELPERS (FIX) ---------- */

  // Use the date input's value directly when present, otherwise build local YYYY-MM-DD.
  function todayISO(){
    const v = $('#theDate').value;
    if (v) return v; // <input type="date"> provides a local YYYY-MM-DD string already
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd= String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  // Pretty print from an ISO date without introducing UTC shifts.
  function prettyFromISO(iso){
    const [y,m,d] = iso.split('-').map(Number);
    const local = new Date(y, m-1, d); // construct as local Y/M/D
    return local.toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric'});
  }

  function seedMenu(){
  let m = load(LS.menu, null);
  if (!Array.isArray(m) || m.length === 0){
    m = [
      {emoji:'🧇',label:'Waffles (Eggo)'},
      {emoji:'🥧',label:'Pop-Tart'},
      {emoji:'🥣',label:'Cereal'},
      {emoji:'🥯',label:'Bagel & Cream Cheese'}
    ];
    save(LS.menu, m);
  }
}

  async function shareText(content){
    try{ if(navigator.share){ await navigator.share({text:content}); return; } }catch{}
    const encoded=encodeURIComponent(content);
    const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
    const href=isIOS?`sms:&body=${encoded}`:`sms:?body=${encoded}`;
    try{ location.href=href; return; }catch{}
    try{ await navigator.clipboard.writeText(content); alert('Copied to clipboard.'); }
    catch{ alert('Share unavailable. Copy/paste this:\n\n'+content); }
  }

  let activeKidId=null;

function renderKids(){
  const wrap=$('#kidsRow'); wrap.innerHTML='';
  const kids=(Family.getKids&&Family.getKids())||[];
  if(!kids.length){ wrap.innerHTML='<span class="small" style="color:#cbd5e1">No kids yet. Add them in Home → Admin Settings.</span>'; return; }

  kids.forEach(k=>{
    const el=document.createElement('button');
    el.className='kid'; el.dataset.id=k.id; el.dataset.active=activeKidId===k.id;
    const imgHtml = k.photo
      ? `<img class="avatar" src="${k.photo}" alt="${k.name}">`
      : `<div class="avatar">${(k.name||'?').slice(0,1).toUpperCase()}</div>`;
    el.innerHTML=`${imgHtml}<span>${k.name}</span>`;
    // tap toggles “active” (still supported)
    el.onclick=()=>{ activeKidId=(activeKidId===k.id? null : k.id); renderKids(); };

    // drag wires
    attachKidDrag(el, k.id);

    wrap.appendChild(el);
  });
}

  function renderChoices(){
  const grid = $('#choicesGrid'); grid.innerHTML = '';
  const menu = load(LS.menu, []);
  const iso  = todayISO();
  const map  = load(LS.day(iso), {});
  const kids = (Family.getKids && Family.getKids()) || [];

  // paint all cards
  menu.forEach((opt, idx)=>{
    const el = document.createElement('div');
    el.className = 'card';
    el.dataset.idx = String(idx);               // used by BF_DND.dropZones
    el.innerHTML = `
      <div class="head">
        <div class="food">${opt.emoji} ${opt.label}</div>
        <button class="btn" data-choose="${idx}">Choose</button>
      </div>
      <div class="picks" id="picks-${idx}"></div>
    `;
    grid.appendChild(el);
  });

 // fill “who picked this” pills
  menu.forEach((_, idx)=>{
    const row = $(`#picks-${idx}`);
    Object.entries(map).forEach(([kidId, choiceIdx])=>{
      if (Number(choiceIdx) === idx){
        const kid = kids.find(k => String(k.id) === String(kidId));
        if (!kid) return;
        const pill = document.createElement('div');
        pill.className = 'pill';
        pill.innerHTML = kid.photo
          ? `<img src="${kid.photo}" alt=""> <span>${kid.name}</span>`
          : `<div class="avatar" style="width:22px;height:22px;font-size:.8rem">${(kid.name||'?').slice(0,1).toUpperCase()}</div><span>${kid.name}</span>`;
        row.appendChild(pill);
      }
    });
  });

  // tap-to-choose fallback
  $$('[data-choose]').forEach(btn=>{
    btn.onclick = ()=>{
      if (!activeKidId){ alert('Tap a child first.'); return; }
      const idx = Number(btn.dataset.choose);
      const m = load(LS.day(iso), {});
      m[activeKidId] = idx;
      save(LS.day(iso), m);
      renderChoices();
    };
  });

     
  // let the BF_DND controller know the current drop zones
  BF_DND.setDropZones($$('.card'));
}

  function buildSummary(){
    const iso = todayISO();
    const dateTxt = prettyFromISO(iso);
    const menu=load(LS.menu,[]);
    const map=load(LS.day(iso),{});
    const kids=(Family.getKids&&Family.getKids())||[];
    const lines=[`🍳 Fambam Breakfast — ${dateTxt}`];
    kids.forEach(k=>{
      const c = map[k.id]; const food = (c!=null? `${menu[c].emoji} ${menu[c].label}` : '—');
      lines.push(`${k.name}: ${food}`);
    });
    return lines.join('\n');
  }

/* ===== Breakfast Drag & Drop: Kid -> Food Card ===== */
const BF_DND = {
  active:false, timer:null, pressMs:200, cancelMovePx:8,
  startX:0, startY:0, ghost:null, shield:null,
  kidId:null, hoverIdx:-1, dropZones:[],
  autoscrollDir:0, autoscrollRAF:0
};

BF_DND.setDropZones = function(zones){ this.dropZones = Array.from(zones||[]); };

function attachKidDrag(kidEl, kidId){
  kidEl.addEventListener('dragstart', e=>e.preventDefault());
  kidEl.addEventListener('contextmenu', e=>e.preventDefault(), {passive:false});

  const onDown = (e)=>{
    if (e.button === 2) return;
    const p = getPoint(e);
    BF_DND.startX = p.x; BF_DND.startY = p.y;
    BF_DND.kidId = kidId; BF_DND.hoverIdx = -1;

    BF_DND.timer = setTimeout(()=> beginKidDrag(kidEl, kidId, p), BF_DND.pressMs);

    window.addEventListener('pointermove', onMove, {passive:false});
    window.addEventListener('pointerup', onUp, {passive:false, once:true});
    window.addEventListener('pointercancel', onCancel, {passive:false, once:true});
    document.addEventListener('visibilitychange', onCancel, {once:true});
  };

  const onMove = (e)=>{
    const p = getPoint(e);
    if (!BF_DND.active){
      // cancel long-press if user moves too much
      if (dist(BF_DND.startX,BF_DND.startY,p.x,p.y) > BF_DND.cancelMovePx){
        clearTimeout(BF_DND.timer); BF_DND.timer=null;
      }
      return;
    }
    // dragging
    e.preventDefault();
    positionGhost(p);
    updateEdgeScroll(p.y);
    const idx = dropIndexFromPoint(p.x, p.y);
    if (idx !== BF_DND.hoverIdx){
      BF_DND.hoverIdx = idx;
      highlightDrop(idx);
    }
  };

  const onUp = ()=>{
    if (!BF_DND.active){
      clearTimeout(BF_DND.timer); BF_DND.timer=null;
      cleanupKidDrag(); return;
    }
    // commit selection if on a drop zone
    if (BF_DND.hoverIdx !== -1){
      const iso = todayISO();
      const m = load(LS.day(iso),{});
      m[BF_DND.kidId] = BF_DND.hoverIdx;
      save(LS.day(iso), m);
      renderChoices(); // refresh pills
    }
    endKidDrag();
  };

  const onCancel = ()=>{
    clearTimeout(BF_DND.timer); BF_DND.timer=null;
    if (BF_DND.active) endKidDrag();
  };

  kidEl.addEventListener('pointerdown', onDown, {passive:false});
}

/* ---------- internals ---------- */

function beginKidDrag(kidEl, kidId, point){
  BF_DND.active = true;
  try{ navigator.vibrate && navigator.vibrate(7); }catch(_){}

  // lock page scroll + disable selection
  document.documentElement.classList.add('drag-lock');
  document.body.classList.add('drag-lock','dragging');

  // shield to swallow touches/clicks (prevents native scroll/selection)
  const shield = document.createElement('div');
  shield.className = 'drag-shield';
  document.body.appendChild(shield);
  BF_DND.shield = shield;

  // ghost: clone the entire kid chip (photo + name)
  const rect  = kidEl.getBoundingClientRect();
  const clone = kidEl.cloneNode(true);
  clone.classList.add('drag-ghost');
  Object.assign(clone.style, {
    width: rect.width + 'px',  height: rect.height + 'px',
    minWidth: rect.width + 'px', minHeight: rect.height + 'px',
    maxWidth: rect.width + 'px', maxHeight: rect.height + 'px',
    left: point.x + 'px', top: point.y + 'px',
    borderRadius: '16px' // match .kid chip radius
  });
  document.body.appendChild(clone);
  BF_DND.ghost = clone;

  // initial highlight (none)
  highlightDrop(-1);
}

function endKidDrag(){
  setAutoscroll(0);
  cleanupKidDrag();
  highlightDrop(-1);
}

function cleanupKidDrag(){
  if (BF_DND.ghost) BF_DND.ghost.remove();
  BF_DND.ghost = null;
  if (BF_DND.shield) BF_DND.shield.remove();
  BF_DND.shield = null;

  document.body.classList.remove('dragging','drag-lock');
  document.documentElement.classList.remove('drag-lock');

  BF_DND.active=false; BF_DND.kidId=null; BF_DND.hoverIdx=-1;
}

/* --- utils mirroring index behavior --- */
function positionGhost(p){
  if (!BF_DND.ghost) return;
  BF_DND.ghost.style.left = p.x + 'px';
  BF_DND.ghost.style.top  = p.y + 'px';
}

function getPoint(e){
  const t = (e.touches && e.touches[0]) || e;
  return { x: t.clientX, y: t.clientY };
}
function dist(x1,y1,x2,y2){ const dx=x2-x1, dy=y2-y1; return Math.hypot(dx,dy); }

function dropIndexFromPoint(x,y){
  // prefer direct hit; fall back to nearest center
  let best=-1, bestScore=0;
  for (const el of BF_DND.dropZones){
    const r = el.getBoundingClientRect();
    const idx = Number(el.dataset.idx||-1);
    const inside = (x>=r.left && x<=r.right && y>=r.top && y<=r.bottom);
    if (inside) return idx;
    // proximity fallback
    const cx=(r.left+r.right)/2, cy=(r.top+r.bottom)/2;
    const score = 1/Math.max(1, Math.hypot(cx-x, cy-y));
    if (score>bestScore){ bestScore=score; best=idx; }
  }
  return best;
}

function highlightDrop(idx){
  BF_DND.dropZones.forEach(el=>{
    el.classList.toggle('drop-target', Number(el.dataset.idx)===Number(idx));
  });
}

/* --- edge autoscroll (rarely needed on this page, but safe) --- */
function setAutoscroll(dir){
  if (dir === BF_DND.autoscrollDir) return;
  BF_DND.autoscrollDir = dir;
  if (BF_DND.autoscrollRAF) { cancelAnimationFrame(BF_DND.autoscrollRAF); BF_DND.autoscrollRAF = 0; }
  if (!dir) return;
  const speed = 16; // px per frame
  const step = ()=>{
    if (!BF_DND.active || !BF_DND.autoscrollDir) { BF_DND.autoscrollRAF = 0; return; }
    window.scrollBy(0, BF_DND.autoscrollDir * speed);
    BF_DND.autoscrollRAF = requestAnimationFrame(step);
  };
  BF_DND.autoscrollRAF = requestAnimationFrame(step);
}
function updateEdgeScroll(clientY){
  const edge = 80;
  if (clientY < edge) setAutoscroll(-1);
  else if (clientY > (window.innerHeight - edge)) setAutoscroll(1);
  else setAutoscroll(0);
}     

  /* --- Manage modal wires --- */
  const manageModal=$('#menuModal');
  const closeManage=()=>{manageModal.style.display='none';manageModal.setAttribute('aria-hidden','true');};
  const openManage=()=>{buildMenuList();manageModal.style.display='flex';manageModal.setAttribute('aria-hidden','false');};
  $('#menuClose').onclick=closeManage;
  $('#menuDone').onclick=closeManage;

  function buildMenuList(){
  const list=$('#menuList'); list.innerHTML='';
  const menu=load(LS.menu,[]);
  const MAX=8;

  // rows
  menu.forEach((m,idx)=>{
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`
      <input data-emo type="text" value="${m.emoji||''}" placeholder="🍳" style="width:100px;text-align:center"/>
      <input data-label type="text" value="${m.label||''}" placeholder="Item name (e.g., Waffles)"/>
      <div style="display:flex;gap:8px">
        <button class="btn" data-save>Save</button>
        <button class="btn" data-del>Remove</button>
      </div>`;
    const saveBtn=row.querySelector('[data-save]');
    const delBtn =row.querySelector('[data-del]');
    saveBtn.onclick=()=>{
      menu[idx]={ emoji: row.querySelector('[data-emo]').value||'🍳',
                  label: row.querySelector('[data-label]').value||'Item' };
      save(LS.menu,menu); renderChoices();
    };
    delBtn.onclick=()=>{
      menu.splice(idx,1); save(LS.menu,menu); buildMenuList(); renderChoices();
    };
    list.appendChild(row);
  });

  // add button
  const addWrap=document.createElement('div'); addWrap.className='item';
  addWrap.innerHTML=`
    <div style="opacity:.8">Add another choice</div>
    <div></div>
    <button class="btn" id="addChoice" ${menu.length>=MAX?'disabled':''}>Add</button>`;
  addWrap.querySelector('#addChoice').onclick=()=>{
    if(menu.length>=MAX) return;
    menu.push({emoji:'🍳',label:'New choice'});
    save(LS.menu,menu); buildMenuList(); renderChoices();
  };
  list.appendChild(addWrap);
}

  /* --- Hamburger logic (match index) --- */
  (function menu(){
    const btn = document.getElementById('btnMenu');
    const dd  = document.getElementById('menuDropdown');
    const openDD = ()=>{ dd.classList.add('open'); btn.setAttribute('aria-expanded','true'); dd.setAttribute('aria-hidden','false'); };
    const closeDD= ()=>{ dd.classList.remove('open'); btn.setAttribute('aria-expanded','false'); dd.setAttribute('aria-hidden','true'); };

    btn?.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.contains('open')?closeDD():openDD(); });
    document.addEventListener('click', (e)=>{ if (!dd.contains(e.target) && e.target!==btn) closeDD(); });

    dd?.addEventListener('click', async (e)=>{
      const el = e.target.closest('.menu-item'); if (!el) return;
      const action = el.dataset.action;
      const iso = todayISO();
      closeDD();

      if (action === 'reset') {
        if(confirm('Clear choices for this date?')){
          localStorage.removeItem(LS.day(iso));
          renderChoices();
        }
      } else if (action === 'random') {
        const kids=(Family.getKids&&Family.getKids())||[];
        if(!kids.length) return;
        const menu=load(LS.menu,[]);
        const map={}; kids.forEach(k=>{ map[k.id]=Math.floor(Math.random()*menu.length); });
        save(LS.day(iso),map);
        renderChoices();
      } else if (action === 'share') {
        shareText(buildSummary());
      } else if (action === 'manage') {
        openManage();
      }
    });
  })();

  (function initDate(){
    const d=new Date();
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    $('#theDate').value=`${y}-${m}-${dd}`;
    $('#theDate').onchange=()=>renderChoices();
  })();

  seedMenu();
  renderKids();
  renderChoices();

  if('serviceWorker' in navigator) addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
  </script>
</body>
</html>
