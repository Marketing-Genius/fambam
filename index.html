<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Fambam">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">
<link rel="stylesheet" href="wallpaper.css">
<script src="wallpaper.js" defer></script>
<link rel="stylesheet" href="fambam.css">
<script src="menu.js" defer></script>  

<script>
/* THEME BOOT + logo swap (copy this into other pages) */
(function themeBoot(){
  try{
    const raw = localStorage.getItem('ui:theme');
    const saved = raw ? JSON.parse(raw) : { mode:'dark', accent:'#22d3ee' };
    const mode = (saved.mode==='light') ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.style.setProperty('--accent', saved.accent || '#22d3ee');
    const meta = document.querySelector('meta[name="theme-color"]');
    const headerColor = (mode==='light') ? '#f2efe7' : '#0f172a';
    if (meta) meta.setAttribute('content', headerColor);
    const swapLogo = ()=>{
      const logo = document.getElementById('logoImg');
      if (logo) logo.src = (document.documentElement.getAttribute('data-theme')==='light') ? 'fambam2.png' : 'fambam.png';
    };
    requestAnimationFrame(swapLogo);
    window.addEventListener('storage', (e)=>{
      if (e.key==='ui:theme'){
        try{
          const t = JSON.parse(e.newValue||'{}');
          const m = (t.mode==='light') ? 'light' : 'dark';
          document.documentElement.setAttribute('data-theme', m);
          document.documentElement.style.setProperty('--accent', t.accent || '#22d3ee');
          if (meta) meta.setAttribute('content', m==='light' ? '#f2efe7' : '#0f172a');
          swapLogo();
        }catch(_){}
      }
    });
  }catch(_){}
})();
</script>

<script>
(function bootWallpaper(){
  try{
    const dataUrl = localStorage.getItem('hub:wallpaper:dataurl');
    if (dataUrl) {
      document.documentElement.style.setProperty('--wallpaper-image', `url("${dataUrl}")`);
    }
    // Also re-apply overlay/shift if saved
    const cfg = JSON.parse(localStorage.getItem('ui:wallpaper') || '{}');
    if (cfg.shift) document.documentElement.style.setProperty('--wallpaper-shift', String(cfg.shift));
    const ov = cfg.overlay;
    if (ov) {
      if (ov.type === 'solid' && ov.color) {
        document.documentElement.style.setProperty('--wp-overlay', ov.color);
      } else if (ov.type === 'gradient' && ov.start && ov.end) {
        const angle = Number(ov.angle ?? 180);
        document.documentElement.style.setProperty('--wp-overlay', `linear-gradient(${angle}deg, ${ov.start}, ${ov.end})`);
      }
      if (typeof ov.opacity === 'number') {
        document.documentElement.style.setProperty('--wp-overlay-opacity', String(ov.opacity));
      }
    }
  }catch(_){}
})();
</script>
  
<style>
/* --- layout sanity --- */
*, *::before, *::after { box-sizing: border-box; }

/* Base tokens (overridden by [data-theme]) */
:root{
  --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
  --bg:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
  --slotH: 220px;

  --panelBorder:#0b1224;
  --tileBorder: rgba(31,41,55,.95);
  --glassHeader: rgba(17,24,39,.5);
  --chipBg:#0b1224;
  --chipBorder:#334155;
  --previewBg:#081228;
  --previewBorder:#27324a;
}

/* LIGHT THEME OVERRIDES (soft ivory palette) */
html[data-theme="light"]{
  --panel:#f2efe7; --card:#ffffff; --muted:#556070; --text:#0f1623; --bg:#f0ece4;
  --shadow:0 10px 28px rgba(0,0,0,.08);
  --panelBorder:#e6e2da; --tileBorder:#ebe7df; --glassHeader: rgba(255,255,255,.72);
  --chipBg:#f6f3ec; --chipBorder:#e3ded4; --previewBg:#fffdf7; --previewBorder:#ebe6db;
}
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  color:var(--text); background:#404c69; overflow-x:hidden;
}
  
/* App */
.app{
  min-height: 100svh;
  display:flex; flex-direction:column; gap:18px;
  padding:20px; max-width:1100px; margin:0 auto;
}

/* Grid */
#slots{
  margin-top:12px; display:grid; gap:16px;
  grid-template-columns:repeat(4, minmax(0,1fr));
  grid-auto-rows: var(--slotH);
}
@media(max-width:860px){ #slots{ grid-template-columns:repeat(2, minmax(0,1fr)); } }
.slot{ height: var(--slotH); border-radius:16px; position:relative; }
.slot.editing{ outline:2px dashed var(--chipBorder); background:rgba(2,6,23,.06); }
html[data-theme="light"] .slot.editing{ background:rgba(15,22,35,.04); }
.slot.editing .add-btn{
  position:absolute; inset:auto 10px 10px auto;
  background:var(--chipBg); border:1px dashed var(--chipBorder); color:var(--text);
  border-radius:999px; width:44px; height:44px; display:grid; place-items:center; cursor:pointer;
}

/* Tile */
.tile{
  position:relative;
  display:flex;flex-direction:column;gap:10px;align-items:flex-start;
  background:var(--card);border:1px solid var(--tileBorder);
  border-radius:16px;padding:16px;text-decoration:none;color:var(--text);
  box-shadow:var(--shadow);backdrop-filter: blur(4px);
  height:100%; overflow:hidden;
}
.tile .emoji{font-size:36px;filter:drop-shadow(0 6px 10px rgba(0,0,0,.12))}
.tile .label{font-weight:800}
.tile .hint{opacity:.8}

/* Prevent iOS long-press link preview/callout on tiles */
.tile { -webkit-touch-callout: none; }

/* Block native scroll gestures that compete with long-press */
#slots, #slots .tile { touch-action: none; }

/* Stop iOS text selection / interactions while dragging */
.dragging, .dragging * {
  user-select: none;
  -webkit-user-select: none;
  -webkit-touch-callout: none;
  -webkit-tap-highlight-color: transparent;
}
.dragging { touch-action: none; cursor: grabbing; }

/* Drag ghost: keep exact size of the picked card */
.drag-ghost{
  position: fixed;
  left: 0; top: 0;
  transform: translate(-50%,-50%) scale(.98);
  z-index: 9999;
  pointer-events: none;
  filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
  opacity: .96;
  overflow: hidden;           /* never grow by content */
  box-sizing: border-box;
}

/* while dragging, lock page scroll */
html.drag-lock, body.drag-lock {
  overflow: hidden !important;
  overscroll-behavior: contain;
}

/* make sure the shield doesn't allow touch scrolling */
.drag-shield {
  position: fixed;
  inset: 0;
  z-index: 9998;
  background: transparent;
  pointer-events: auto;
  touch-action: none;
  cursor: grabbing;
}
   
/* Shared preview surfaces */
.bf-box,.dp-box,.ch-box,.pt-box,.fam-box{
  margin-top:6px; width:100%;
  background:var(--previewBg); border:1px solid var(--previewBorder);
  border-radius:16px; padding:12px;
  max-height: calc(var(--slotH) - 72px);
  overflow:hidden;
}

/* Breakfast preview */
.bf-date{font-size:.9rem;font-weight:800}
.bf-empty{opacity:.8;font-size:.95rem;margin-top:10px}
.bf-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px 12px; margin-top:10px; }
.bf-item{ display:flex; align-items:center; gap:10px; min-height:40px; }
.bf-face{ width:34px; height:34px; border-radius:50%; overflow:hidden; display:grid; place-items:center; flex:0 0 auto; background:#334155; color:#e5e7eb; font-size:.95rem; font-weight:800; }
html[data-theme="light"] .bf-face{ background:#e3e0d8; color:#1b2432; }
.bf-face img{width:100%;height:100%;object-fit:cover}
.bf-emoji{font-size:1.4rem; line-height:1}

/* Dinner preview */
.dp-title{font-size:.95rem;font-weight:800}
.dp-empty{opacity:.8;font-size:.95rem;margin-top:10px}
.dp-rows{display:grid; gap:10px; margin-top:10px}
.dp-row{display:flex; align-items:center; justify-content:space-between}
.dp-row .who{font-weight:800}
.dp-icons{display:flex; align-items:center; gap:10px; font-size:1.4rem; line-height:1}

/* Chores preview */
.ch-title{font-size:.95rem;font-weight:800}
.ch-empty{opacity:.8;font-size:.95rem;margin-top:10px}
.ch-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px 12px; margin-top:10px; }
.ch-item{display:flex; align-items:center; gap:10px; min-height:40px}
.ch-task{font-size:1.2rem; line-height:1;}

/* Points preview (2×2 leaderboard) */
.pt-title{font-size:.95rem;font-weight:800}
.pt-empty{opacity:.8;font-size:.95rem;margin-top:10px}
.pt-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px 12px; margin-top:10px; }
.pt-item{display:flex; align-items:center; gap:10px; min-height:40px}
.pt-score{font-weight:800;}

/* Family preview */
.fam-title{font-size:.95rem;font-weight:800}
.fam-sub{opacity:.9;font-size:.95rem;margin-top:4px;min-height:1.2em}

/* 2 rows × 3 columns grid, centered avatars, no names */
.fam-grid{
  display:grid;
  grid-template-columns:repeat(3, minmax(0,1fr));
  gap:12px;
  margin-top:10px;
}
.fam-item{
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:40px;
}

/* Edit affordances */
.tile .minus{
  position:absolute; right:8px; bottom:8px; width:36px; height:36px;
  display:none; place-items:center; font-weight:800;
  background:#3f1620; border:1px solid #7f1d1d; color:#fecaca; border-radius:999px;
}
.editing .tile .minus{ display:grid; cursor:pointer; }
.tile.selecting{ outline:2px solid var(--accent); }

/* Photos tile */
.tile.photo-only{ padding:0; border:none; background:transparent; box-shadow:none; }
.photo-prev{ position:absolute; inset:0; border-radius:16px; overflow:hidden; z-index:0; opacity:.22; }
.photo-prev img{ width:100%; height:100%; object-fit:cover; display:block; }
.tile.photos-card{ background: transparent; border: none; padding: 0; }
.tile.photos-card .photo-prev{ opacity: 1; }
.tile.photos-card .emoji, .tile.photos-card .label, .tile.photos-card .hint{ display: none; }
.tile.photos-card .minus{ display:none; }
.editing .tile.photos-card .minus{ display:grid; background: rgba(0,0,0,.4); border-color:#000; }
.tile.photos-card::before{ content:""; position:absolute; inset:0; border-radius:16px; box-shadow: var(--shadow); pointer-events:none; }

/* Subtle "open" arrow on Photos card */
.photos-arrow{
  position:absolute; right:10px; bottom:10px;
  width:38px; height:38px; border-radius:50%; border:2px solid #fff;
  background:rgba(0,0,0,.2); color:#fff; display:grid; place-items:center;
  font-size:18px; line-height:1; opacity:.2; transition:opacity .2s, transform .2s; pointer-events:none;
}
.tile.photos-card:hover .photos-arrow{ opacity:.6; transform:translateY(-1px); }

/* Family card: name beside the face */
.fam-name{ font-weight:700 }

/* Store preview */
.st-box{ margin-top:6px; width:100%; background:var(--previewBg); border:1px solid var(--previewBorder);
  border-radius:16px; padding:12px; max-height: calc(var(--slotH) - 72px); overflow:hidden; }
.st-row{ display:flex; align-items:center; gap:12px; min-height:42px; font-size:1.05rem; }
.st-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
  
/* Modal + form + edit bar */
.sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.modal{width:min(900px,100%);background:var(--panel);border:1px solid var(--panelBorder);border-radius:16px;box-shadow:var(--shadow)}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--panelBorder)}
.modal .body{padding:14px 16px;display:grid;gap:18px;max-height:70vh;overflow:auto}
.modal .footer{padding:14px 16px;border-top:1px solid var(--panelBorder);display:flex;justify-content:flex-end;gap:10px}
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:10px;background:var(--chipBg);border:1px solid var(--chipBorder);cursor:pointer;color:var(--text)}
.tab[aria-selected="true"]{outline:2px solid var(--accent)}
.list{display:grid; gap:12px;}
.item{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--panelBorder);border-radius:12px;padding:12px}
.item .grow{flex:1}
.face{width:48px;height:48px;border-radius:50%;background:var(--chipBg);display:grid;place-items:center;font-size:22px;border:2px solid var(--chipBorder);overflow:hidden}
.face img{width:100%;height:100%;object-fit:cover}
.row{display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin:6px 0;}
.btn{font:inherit;color:var(--text);background:var(--chipBg);border:1px solid var(--chipBorder);border-radius:12px;padding:10px 12px;cursor:pointer}
.btn-primary{background:linear-gradient(180deg,var(--accent),color-mix(in oklab, var(--accent) 70%, #0891b2 30%));color:#001018;border:none;font-weight:800}
.btn-lg{padding:12px 16px;border-radius:14px;font-weight:800}
.btn-warn{background:#3f1620;border:1px solid #7f1d1d;color:#fecaca}
.btn[disabled]{opacity:.5;filter:grayscale(1);pointer-events:none}
.toggle{display:inline-flex;align-items:center;gap:8px}
#editBar{display:none; align-items:center; justify-content:space-between;margin-top:6px; padding:10px 12px; border-radius:12px;background:rgba(17,24,39,.65); border:1px solid var(--panelBorder);}
html[data-theme="light"] #editBar{ background:rgba(255,255,255,.7); }
#editBar.show{display:flex}

/* Drag target outline during preview */
.slot.drag-target{ outline:2px solid var(--accent); outline-offset:2px; }

 /* Make the wallpaper overlay follow a variable (same for dark/light) */
body::after{ background: var(--wp-overlay, rgba(64,76,105,.9)); }

/* If you want a nice visible preview ring around the demo, optional: */
.wp-preview{ border-radius: 12px; border: 1px solid rgba(255,255,255,.2); overflow:hidden }
  
</style>
</head>
<body>
  <div class="app">
<header class="panel header app-header">
  <a href="./index.html" class="brand" title="Home">
    <img id="logoImg" src="fambam.png" alt="Fambam">
  </a>

  <div class="menu-wrap">
    <button class="hamburger" aria-haspopup="true" aria-expanded="false">☰</button>
    <div class="menu-dd" role="menu" aria-hidden="true">
      <button class="mi" data-mi="pages">All Pages</button>
      <button class="mi" data-mi="edithome">Edit Home</button>
      <button class="mi" data-mi="admin">Admin Settings</button>
      <button class="mi" data-mi="about">About</button>
    </div>
  </div>
</header>

    <!-- Edit bar -->
    <div id="editBar">
      <div>Tap a card, then tap a slot to move it. Use “+” to add. Tap “−” on a card to remove.</div>
      <div style="display:flex;gap:10px">
        <button id="btnAddAnywhere" class="btn">Add/Remove Card</button>
        <button id="btnDoneEdit" class="btn-primary">Done</button>
      </div>
    </div>

    <!-- Fixed grid of 16 slots -->
    <main id="slots" aria-label="Home grid"></main>
  </div>

  <!-- Hidden pickers -->
<input
  type="file"
  id="file-picker"
  accept="image/*,.heic,.heif,.heic-sequence,.heif-sequence"
  class="sr-only"
/>
  <input type="file" id="wallpaper-picker"
       accept="image/*,.heic,.heif,.heic-sequence,.heif-sequence"
       class="sr-only"/>

  <!-- Admin Modal -->
  <div class="modal-backdrop" id="adminModal" aria-hidden="true" role="dialog" aria-labelledby="adminTitle">
    <div class="modal">
      <header>
        <div id="adminTitle" style="font-weight:800">Admin Settings</div>
        <button id="adminClose" class="btn">✖</button>
      </header>
      <div class="body">
        <div class="tabs">
          <button class="tab" data-tab="parents" aria-selected="true">Parents</button>
          <button class="tab" data-tab="kids">Kids</button>
          <button class="tab" data-tab="global">Global Settings</button>
        </div>

        <!-- Parents -->
        <section class="tab-panel" data-panel="parents">
          <div class="list" id="parentsList"></div>
          <div class="row">
            <input id="newParentName" class="btn" placeholder="Add parent name" />
            <button id="addParent" class="btn-primary btn-lg">Add Parent</button>
          </div>
          <div class="row">
  <input id="pinInput" class="btn" placeholder="Set Admin PIN (optional)" inputmode="numeric" />
  <button id="savePin" class="btn-primary btn-lg">Save PIN</button>
  <label class="toggle" style="margin-left:8px">
    <input id="pinRequired" type="checkbox" checked />
    Require Admin PIN
  </label>
</div>
        </section>

        <!-- Kids -->
        <section class="tab-panel" data-panel="kids" style="display:none">
          <div class="list" id="kidsList"></div>
          <div class="row">
            <input id="newKidName" class="btn" placeholder="Add kid name" />
            <button id="addKid" class="btn-primary btn-lg">Add Kid</button>
          </div>
        </section>

        <!-- Global Settings -->
        <section class="tab-panel" data-panel="global" style="display:none">
          <div class="item" style="align-items:flex-start">
            <div class="grow">
              <div style="font-weight:800; margin-bottom:6px">Theme</div>
              <div class="row">
                <label class="toggle"><input type="radio" name="themeMode" value="dark" checked> Dark</label>
                <label class="toggle"><input type="radio" name="themeMode" value="light"> Light</label>
              </div>
              <div class="row">
                <label>Accent</label>
                <input id="accentPicker" type="color" class="btn" value="#22d3ee" style="padding:6px 8px; width:60px; height:36px;">
                <button id="accentReset" class="btn">Reset</button>
              </div>
              <div class="row" style="opacity:.8">Accent affects buttons, outlines, and focus rings across the app.</div>
            </div>
          </div>

          <div class="item">
            <div class="grow">
              <div style="font-weight:800; margin-bottom:6px">Wallpaper</div>
              <div class="row">
                <button id="btnPickWallpaper" class="btn">Pick Wallpaper</button>
                <button id="btnClearWallpaper" class="btn">Clear Wallpaper</button>
              </div>
            </div>
          </div>

<!-- Wallpaper Overlay controls -->
<div class="item">
  <div class="grow">
    <div class="section-title" style="font-weight:800; margin-bottom:6px">Wallpaper Overlay</div>

    <div class="grid" style="gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))">
      <label>Mode
        <select id="wpMode">
          <option value="solid">Solid</option>
          <option value="gradient">Gradient</option>
        </select>
      </label>

      <label>Opacity
        <input id="wpOpacity" type="range" min="0" max="1" step="0.01">
      </label>

      <label id="wpSolidWrap">Color (solid)
        <input id="wpSolidColor" type="color">
      </label>

      <label id="wpGradStart">Gradient start
        <input id="wpStart" type="color">
      </label>

      <label id="wpGradEnd">Gradient end
        <input id="wpEnd" type="color">
      </label>

      <label id="wpGradAngle">Angle (deg)
        <input id="wpAngle" type="number" min="0" max="360" step="1">
      </label>

      <!-- ✅ New: Vertical shift control -->
      <label id="wpShiftWrap">Vertical shift (%)
        <input id="wpShift" type="range" min="0" max="100" step="1">
      </label>
    </div>

    <div class="row" style="margin-top:8px;gap:8px">
      <button id="wpSave" class="btn">Save Overlay</button>
      <button id="wpReset" class="btn">Reset to Default</button>
    </div>
  </div>
</div>
          
<div class="item">
  <div class="grow">
    <div style="font-weight:800; margin-bottom:6px">Data (Export / Import)</div>
    <div class="row">
      <button id="btnExportData" class="btn">Export Data</button>
      <button id="btnImportData" class="btn">Import Data</button>
      <input id="importFileInput" type="file" accept="application/json" class="sr-only">
    </div>
    <div class="row" style="opacity:.75">
      Creates a .json backup you can save to Files/AirDrop. Import replaces current data on this device.
    </div>
  </div>
</div>
          
          <div class="item">
            <div class="grow" style="opacity:.75">More global options (like theme templates) coming soon.</div>
          </div>
        </section>
      </div>
      <div class="footer">
        <button id="adminSave" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- PIN Modal -->
  <div id="pinModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="pinTitle">
    <div class="modal" style="max-width:420px">
      <header>
        <div id="pinTitle" style="font-weight:800">Enter Admin PIN</div>
        <button id="pinClose" class="btn">✖</button>
      </header>
      <div class="body" style="gap:12px">
        <input id="pinInputModal" class="btn" inputmode="numeric" pattern="[0-9]*" placeholder="PIN (numbers only)" autofocus />
      </div>
      <div class="footer">
        <button id="pinOk" class="btn-primary btn-lg">OK</button>
      </div>
    </div>
  </div>

  <!-- Add / Remove Cards Modal -->
  <div id="addCardModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="addCardTitle">
    <div class="modal" style="max-width:560px">
      <header>
        <div id="addCardTitle" style="font-weight:800">Add / Remove Cards</div>
        <button id="addCardClose" class="btn">✖</button>
      </header>
      <div class="body" id="addCardBody"></div>
      <div class="footer">
        <button id="addCardDone" class="btn-primary">Done</button>
      </div>
    </div>
  </div>

  <!-- All Pages Modal -->
  <div id="pagesModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="pagesTitle">
    <div class="modal" style="max-width:560px">
      <header>
        <div id="pagesTitle" style="font-weight:800">All Pages</div>
        <button id="pagesClose" class="btn">✖</button>
      </header>
      <div class="body" id="pagesBody"></div>
      <div class="footer">
        <button id="pagesDone" class="btn-primary">Close</button>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div id="aboutModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="aboutTitle">
    <div class="modal" style="max-width:600px">
      <header>
        <div id="aboutTitle" style="font-weight:800">About Fambam</div>
        <button id="aboutClose" class="btn">✖</button>
      </header>
      <div class="body">
        <p><b>Fambam</b> — single-device family hub (PWA). Data stays on this iPad.</p>
        <ul>
          <li>Wallpaper is stored locally and never uploaded.</li>
          <li>Admin-gated settings via PIN.</li>
          <li>Home supports grid placement by tapping a card then a slot.</li>
        </ul>
        <p style="opacity:.75">Works offline. Data stays on this device (local only).</p>
      </div>
      <div class="footer">
        <button class="btn-primary" id="aboutOk">OK</button>
      </div>
    </div>
  </div>

<!-- Family Store -->
<script src="family.js?v=3.3.6"></script>
<script>
// Fallback Family shim if family.js failed
if (!window.Family) {
  console.warn('family.js not loaded — using fallback Family shim.');
  (function(){
  const K = {
    pin: 'hub:family:pin',
    pinReq: 'hub:family:pinRequired',        // NEW
    parents: 'hub:family:parents',
    kids: 'hub:family:kids'
  };
  const uid = ()=>Math.random().toString(36).slice(2,10);
  const load = (k,f)=>{ try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? f; } catch { return f; } };
  const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));

  window.Family = {
    setPin(pin){ save(K.pin, pin || null); },
    // If requirement is OFF, any attempt is considered OK
    verifyPin(pin){
      const required = this.isPinRequired();
      const real = load(K.pin, null);
      return !required || !real || String(real) === String(pin);
    },
    isPinRequired(){ return load(K.pinReq, true) ? true : false; },   // default: required
    setPinRequired(on){ save(K.pinReq, !!on); },

    getParents(){ return load(K.parents, []); },
    upsertParent(p){ const a=this.getParents(); const i=a.findIndex(x=>x.id===p.id);
      if(i>=0) a[i]={...a[i],...p}; else a.push({...p,id:p.id||uid()}); save(K.parents,a); },
    removeParent(id){ save(K.parents, this.getParents().filter(p=>p.id!==id)); },

    getKids(){ return load(K.kids, []); },
    getActiveKids(){ return this.getKids().filter(k=>k.enabled!==false); },
    upsertKid(k){ const a=this.getKids(); const i=a.findIndex(x=>x.id===k.id);
      if(i>=0) a[i]={...a[i],...k}; else a.push({...k,id:k.id||uid(),enabled:true}); save(K.kids,a); },
    removeKid(id){ save(K.kids, this.getKids().filter(k=>k.id!==id)); },
    setKidEnabled(id,en){ const a=this.getKids(); const k=a.find(x=>x.id===id); if(k){ k.enabled=!!en; save(K.kids,a); } },

    onChange(){ return ()=>{}; }
  };
})();
}
</script>

<!-- Seed PIN once to 4321 -->
<script>
(function seedPinOnce(){
  try{
    const FLAG = 'hub:pinSeeded';
    if (!localStorage.getItem(FLAG)) {
      Family.setPin('4321');                 // keep your demo PIN
      Family.setPinRequired(true);           // NEW default
      localStorage.setItem(FLAG, '1');
      console.log('Admin PIN seeded to 4321 (requirement ON)');
    }
    // If someone upgraded without the flag, ensure the requirement key exists:
    if (localStorage.getItem('hub:family:pinRequired') === null) {
      Family.setPinRequired(true);
    }
  }catch(e){ console.warn('PIN seed failed', e); }
})();
</script>

<!-- Wallpaper utilities (shared helper + safe fallback) -->
<script>
function pickWallpaper(){
  const input = document.getElementById('wallpaper-picker');
  // allow HEIC/HEIF too (some browsers require explicit extensions)
  input.accept = 'image/*,.heic,.heif,.heic-sequence,.heif-sequence';
  input.removeAttribute('capture'); // avoid camera-only on mobile

  input.onchange = async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
   try{
  const dataUrl = await compressImage(file, 2400, 0.85);

  // Persist no matter what
  localStorage.setItem('hub:wallpaper:dataurl', dataUrl);

  // Apply immediately via CSS var (works even if wallpaper.js is broken/missing)
  document.documentElement.style.setProperty('--wallpaper-image', `url("${dataUrl}")`);

  // If your wallpaper.js wants to do extra stuff (like overlay/shift), let it try too
  if (window.Wallpaper?.set) {
    Wallpaper.set({ image: dataUrl });
  }
} finally {
  input.value = '';
}
  };

  // must be triggered by a user gesture (your button click)
  input.click();
}

function clearWallpaper(){
  if (window.Wallpaper?.set) {
    Wallpaper.set({ image: '' });
  } else {
    localStorage.removeItem('hub:wallpaper:dataurl');
    document.documentElement.style.setProperty('--wallpaper-image', `url('')`);
  }
}
  
async function compressImage(file, maxSide=2400, quality=.85){
  function drawToCanvas(source, w, h){
    const c = document.createElement('canvas'); c.width = w; c.height = h;
    const ctx = c.getContext('2d');
    ctx.drawImage(source, 0, 0, w, h);
    return c.toDataURL('image/jpeg', quality);
  }
  function fit(w, h, maxSide){
    const scale = Math.min(1, maxSide/Math.max(w,h));
    return { w: Math.max(1, Math.round(w*scale)), h: Math.max(1, Math.round(h*scale)) };
  }

  // Try createImageBitmap first (often works with HEIC/HEIF)
  try{
    if ('createImageBitmap' in window) {
      const bmp = await createImageBitmap(file);
      const { w, h } = fit(bmp.width, bmp.height, maxSide);
      // draw ImageBitmap onto canvas via an offscreen <canvas>
      const c = document.createElement('canvas'); c.width=w; c.height=h;
      const ctx = c.getContext('2d');
      ctx.drawImage(bmp, 0, 0, w, h);
      return c.toDataURL('image/jpeg', quality);
    }
  }catch(e){ /* continue to next attempt */ }

  // Fallback 1: object URL + <img> decode
  try{
    const url = URL.createObjectURL(file);
    const jpeg = await new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = ()=>{ 
        const { w, h } = fit(img.naturalWidth || img.width, img.naturalHeight || img.height, maxSide);
        resolve(drawToCanvas(img, w, h));
        URL.revokeObjectURL(url);
      };
      img.onerror = (err)=>{ URL.revokeObjectURL(url); reject(err); };
      img.src = url;
    });
    return jpeg;
  }catch(e){ /* continue to next attempt */ }

  // Fallback 2: data URL + <img> decode
  try{
    const dataUrl = await new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result||'')); 
      r.onerror = reject; 
      r.readAsDataURL(file);
    });
    const jpeg = await new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = ()=>{
        const { w, h } = fit(img.naturalWidth || img.width, img.naturalHeight || img.height, maxSide);
        resolve(drawToCanvas(img, w, h));
      };
      img.onerror = reject;
      img.src = dataUrl;
    });
    return jpeg;
  }catch(e){
    alert('That image format isn’t supported by this browser. Please pick a JPG or PNG.');
    throw e;
  }
}
</script>

<script>
document.querySelector('.menu-wrap')?.addEventListener('menu:select', (e) => {
  const action = e.detail.action;
  if (action === 'pages') openPages();
  else if (action === 'edithome') toggleEdit(true);
  else if (action === 'admin') {
  const pinIsRequired = (() => {
    if (Family.isPinRequired) return !!Family.isPinRequired();
    // fallback: read raw localStorage (default = true)
    try {
      const raw = localStorage.getItem('hub:family:pinRequired');
      return raw === null ? true : !!JSON.parse(raw);
    } catch { return true; }
  })();

  const hasPin = (localStorage.getItem('hub:family:pin') ?? 'null') !== 'null';
  if (pinIsRequired && hasPin) requestPinUI(openAdmin);
  else openAdmin();
} else if (action === 'about') {
    showModal('aboutModal', true);
  }
});
</script>

<script>
function openPages(){
  const body = document.getElementById('pagesBody'); body.innerHTML='';
  CARDS.forEach(c=>{
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`<div class="grow"><b>${c.label}</b><div style="opacity:.7">${c.hint||''}</div></div><a class="btn" href="${c.href}">Open</a>`;
    body.appendChild(row);
  });
  showModal('pagesModal', true);
}
document.getElementById('pagesDone').onclick=()=>showModal('pagesModal', false);
document.getElementById('pagesClose').onclick=()=>showModal('pagesModal', false);
</script>

<!-- PIN modal helpers -->
<script>
function requestPinUI(onSuccess){
  const m = document.getElementById('pinModal');
  const input = document.getElementById('pinInputModal');
  const ok = document.getElementById('pinOk');
  const x = document.getElementById('pinClose');

  function close(){ m.style.display='none'; m.setAttribute('aria-hidden','true'); input.value=''; ok.onclick = x.onclick = null; input.onkeydown=null; }
  function open(){
    m.style.display='flex'; m.setAttribute('aria-hidden','false');
    setTimeout(()=>{
      input.focus();
      if (input.setSelectionRange) input.setSelectionRange(input.value.length, input.value.length);
    }, 50);
  }

  function trySubmit(){
    const pin = (input.value||'').trim();
    if (!/^\d{1,8}$/.test(pin)) { alert('PIN must be 1–8 digits.'); return; }
    if (Family.verifyPin(pin)) { close(); onSuccess(); }
    else { alert('Incorrect PIN.'); input.focus(); input.select(); }
  }

  ok.onclick = trySubmit;
  input.onkeydown = (e)=>{ if(e.key==='Enter') trySubmit(); };
  x.onclick = close;

  open();
}
window.addEventListener('load', ()=>{
  if (location.hash === '#admin') {
    const hasPin = (localStorage.getItem('hub:family:pin') ?? 'null') !== 'null';
    const requirePin = Family?.isPinRequired ? !!Family.isPinRequired() : (()=>{
      try {
        const raw = localStorage.getItem('hub:family:pinRequired');
        return raw === null ? true : !!JSON.parse(raw);
      } catch { return true; }
    })();
    if (hasPin && requirePin) requestPinUI(openAdmin); else openAdmin();
  }
});
</script>

<!-- Admin modal logic (incl. Global Settings) -->
<script>
const modal = document.getElementById('adminModal');
document.getElementById('adminClose')?.addEventListener('click', closeAdmin);
document.getElementById('adminSave')?.addEventListener('click', closeAdmin);

document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    const tab = t.dataset.tab;
    document.querySelectorAll('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
    t.setAttribute('aria-selected','true');
    document.querySelectorAll('.tab-panel').forEach(p=>p.style.display = (p.dataset.panel===tab?'':'none'));
  });
});
function openAdmin(){ buildParents(); buildKids(); initGlobalSettings(); initWallpaperOverlayUI(); showModal('adminModal', true); }
function closeAdmin(){ showModal('adminModal', false); }

/* Parents UI */
function buildParents(){
  const list = document.getElementById('parentsList'); list.innerHTML='';
  (Family.getParents?.() || []).forEach(p=>{
    const row = document.createElement('div'); row.className='item'; row.dataset.id=p.id;
    row.innerHTML = `
      <div class="face">${p.photo?`<img src="${p.photo}" alt="${escapeHtml(p.name)}">`:`<span>${initials(p.name)}</span>`}</div>
      <input class="grow btn" value="${escapeHtml(p.name||'Parent')}" />
      <button class="btn" data-photo>Change Photo</button>
      <button class="btn-warn" data-remove>Remove</button>`;
    list.appendChild(row);
  });
  document.getElementById('addParent').onclick = ()=>{
    const name = (document.getElementById('newParentName').value||'').trim(); if(!name) return;
    Family.upsertParent({ name }); document.getElementById('newParentName').value=''; buildParents();
  };
  document.getElementById('savePin').onclick = ()=>{
    const pin = (document.getElementById('pinInput').value||'').trim() || null;
    if (pin && !/^\d{1,8}$/.test(pin)) { alert('PIN must be 1–8 digits.'); return; }
    Family.setPin(pin); alert(pin ? 'PIN saved.' : 'PIN cleared.');
  };

// === Require Admin PIN toggle wiring ===
const pinInput   = document.getElementById('pinInput');
const savePinBtn = document.getElementById('savePin');
const pinReqEl   = document.getElementById('pinRequired');

function getPinRequired(){
  if (Family.isPinRequired) return !!Family.isPinRequired();
  try {
    const raw = localStorage.getItem('hub:family:pinRequired');
    return raw === null ? true : !!JSON.parse(raw);
  } catch { return true; }
}
function setPinRequired(on){
  if (Family.setPinRequired) return Family.setPinRequired(!!on);
  localStorage.setItem('hub:family:pinRequired', JSON.stringify(!!on));
}

pinReqEl.checked = getPinRequired();

function syncPinRowUI(){
  const on = pinReqEl.checked;
  pinInput.disabled = !on;
  savePinBtn.disabled = !on;
  pinInput.placeholder = on ? 'Set Admin PIN (optional)' : 'PIN disabled';
}
syncPinRowUI();

pinReqEl.onchange = ()=>{
  setPinRequired(pinReqEl.checked);
  syncPinRowUI();
};
  
  list.querySelectorAll('.item').forEach(row=>{
    const id = row.dataset.id;
    row.querySelector('input').oninput = (e)=> Family.upsertParent({ id, name:e.target.value });
    row.querySelector('[data-photo]').onclick = ()=> pickPhoto('parent', id);
    row.querySelector('[data-remove]').onclick = ()=>{ Family.removeParent(id); buildParents(); };
  });
}
/* Kids UI */
function buildKids(){
  const list = document.getElementById('kidsList'); list.innerHTML='';
  (Family.getKids?.() || []).forEach(k=>{
    const row = document.createElement('div'); row.className='item'; row.dataset.id=k.id;
    row.innerHTML = `
      <div class="face">${k.photo?`<img src="${k.photo}" alt="${escapeHtml(k.name)}">`:`<span>${initials(k.name)}</span>`}</div>
      <input class="grow btn" value="${escapeHtml(k.name||'Kid')}" />
      <label class="toggle"><input type="checkbox" ${k.enabled!==false?'checked':''}/> Enabled</label>
      <button class="btn" data-photo>Change Photo</button>
      <button class="btn-warn" data-remove>Remove</button>`;
    list.appendChild(row);
  });
  document.getElementById('addKid').onclick = ()=>{
    const name = (document.getElementById('newKidName').value||'').trim(); if(!name) return;
    Family.upsertKid({ name }); document.getElementById('newKidName').value=''; buildKids();
  };
  list.querySelectorAll('.item').forEach(row=>{
    const id = row.dataset.id;
    row.querySelector('input').oninput = (e)=> Family.upsertKid({ id, name:e.target.value });
    row.querySelector('input[type="checkbox"]').onchange = (e)=> Family.setKidEnabled(id, e.target.checked);
    row.querySelector('[data-photo]').onclick = ()=> pickPhoto('kid', id);
    row.querySelector('[data-remove]').onclick = ()=>{ Family.removeKid(id); buildKids(); };
  });
}
/* helpers */
function initials(n){ const p=(n||'').trim(); return p? p[0].toUpperCase() : '?'; }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }
function pickPhoto(kind, id){
  const input = document.getElementById('file-picker');
  input.removeAttribute('capture');
  input.onchange = async (ev)=>{
    const file = ev.target.files && ev.target.files[0]; if(!file) return;
    const dataUrl = await compressImage(ev.target.files[0], 512, 0.82);
    try{
      if (kind==='kid') Family.upsertKid({ id, photo:dataUrl });
      else Family.upsertParent({ id, photo:dataUrl });
      if (kind==='kid') buildKids(); else buildParents();
    }catch(_){ alert('Could not save photo.'); }
    input.value='';
  };
  input.click();
}
function compress(file, maxSide=256, quality=0.8){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(1, maxSide/Math.max(img.width,img.height));
      const w=Math.max(1,Math.round(img.width*scale)), h=Math.max(1,Math.round(img.height*scale));
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg', quality));
    };
    const r=new FileReader(); r.onload=()=>img.src=r.result; r.readAsDataURL(file);
  });
}

/* --------- Global Settings (Theme + Wallpaper) ---------- */
function initGlobalSettings(){
  try{
    const raw = localStorage.getItem('ui:theme');
    const saved = raw ? JSON.parse(raw) : { mode:'dark', accent:'#22d3ee' };
    const mode = (saved.mode==='light') ? 'light' : 'dark';
    const accent = saved.accent || '#22d3ee';

    document.querySelectorAll('input[name="themeMode"]').forEach(r=>{
      r.checked = (r.value===mode);
      r.onchange = ()=> setTheme({ mode:r.value });
    });
    const pick = document.getElementById('accentPicker');
    pick.value = accent;
    pick.oninput = ()=> setTheme({ accent: pick.value });
    document.getElementById('accentReset').onclick = ()=>{ pick.value = '#22d3ee'; setTheme({ accent: '#22d3ee' }); };

    document.getElementById('btnPickWallpaper').onclick = pickWallpaper;
    document.getElementById('btnClearWallpaper').onclick = clearWallpaper;
  }catch(e){ console.warn('initGlobalSettings failed', e); }
}
function initWallpaperOverlayUI(){
  const KEY = 'ui:wallpaper';

  // Grab form controls
  const el = {
    mode:  document.getElementById('wpMode'),
    op:    document.getElementById('wpOpacity'),
    solid: document.getElementById('wpSolidColor'),
    start: document.getElementById('wpStart'),
    end:   document.getElementById('wpEnd'),
    angle: document.getElementById('wpAngle'),
    solidWrap: document.getElementById('wpSolidWrap'),
    gradStart: document.getElementById('wpGradStart'),
    gradEnd:   document.getElementById('wpGradEnd'),
    gradAngle: document.getElementById('wpGradAngle'),
    save:  document.getElementById('wpSave'),
    shift: document.getElementById('wpShift'),
    reset: document.getElementById('wpReset')
  };

  const DEF = {
    // Defaults match the old look (deep blue solid @ 90%)
    overlay:{ type:'solid', color:'#404C69E6', opacity:0.90 },
    shift:'40%'
  };

  function loadCfg(){
    try { return JSON.parse(localStorage.getItem(KEY) || '{}') } catch { return {}; }
  }
  function saveCfg(next){
    const cur = loadCfg();
    const merged = { ...cur, ...next };
    localStorage.setItem(KEY, JSON.stringify(merged));
    // Apply immediately if wallpaper.js is present
    if (window.Wallpaper?.set) Wallpaper.set(merged);
  }
  function setVisibility(mode){
    const isSolid = (mode === 'solid');
    el.solidWrap.style.display = isSolid ? '' : 'none';
    el.gradStart.style.display = el.gradEnd.style.display = el.gradAngle.style.display = isSolid ? 'none' : '';
  }

  // Hydrate form from saved values
  (function hydrate(){
    const cfg = loadCfg();
    const ov  = cfg.overlay || DEF.overlay;

    el.mode.value = ov.type || 'solid';
    el.op.value   = (ov.opacity ?? DEF.overlay.opacity);

    // Provide sensible defaults if missing
    el.solid.value = ov.color || '#404C69E6';
    el.start.value = ov.start || '#404C69E6';
    el.end.value   = ov.end   || '#1E293BE6';
    el.angle.value = (ov.angle ?? 180);

const sh  = (cfg.shift || DEF.shift || '40%').toString().replace('%','');
  el.shift.value = sh;

    setVisibility(el.mode.value);
  })();

  // Mode toggle shows/hides relevant inputs
  el.mode.onchange = ()=> setVisibility(el.mode.value);

  // ✅ live preview + persist latest slider value
el.shift.oninput = ()=>{
  const pct = `${el.shift.value}%`;
  if (window.Wallpaper?.set) Wallpaper.set({ shift: pct });
  document.documentElement.style.setProperty('--wallpaper-shift', pct);
  const cur = loadCfg();
  localStorage.setItem(KEY, JSON.stringify({ ...cur, shift: pct }));
};

  // Save overlay → persists + live-applies via wallpaper.js
  el.save.onclick = ()=>{
    const mode = el.mode.value;
    const next = { overlay: { type: mode, opacity: Number(el.op.value) },
    shift: `${el.shift.value}%`
    };
    if (mode === 'solid') {
      next.overlay.color = el.solid.value;        // hex8 or rgba OK
    } else {
      next.overlay.start = el.start.value;
      next.overlay.end   = el.end.value;
      next.overlay.angle = Number(el.angle.value);
    }
    saveCfg(next);
    alert('Wallpaper overlay saved.');
  };

  // Reset to defaults
  el.reset.onclick = ()=>{
    localStorage.setItem(KEY, JSON.stringify(DEF));
    if (window.Wallpaper?.set) Wallpaper.set(DEF);
    // Rehydrate form to defaults
    el.mode.value = 'solid';
    el.op.value = DEF.overlay.opacity;
    el.solid.value = DEF.overlay.color;
    el.start.value = '#404C69E6';
    el.end.value   = '#1E293BE6';
    el.angle.value = 180;
    el.shift.value = parseInt((DEF.shift || '40%'), 10);
  document.documentElement.style.setProperty('--wallpaper-shift', DEF.shift);
    
    setVisibility('solid');
    alert('Wallpaper overlay reset.');
  };
}
function setTheme(patch){
  try{
    const raw = localStorage.getItem('ui:theme');
    const cur = raw ? JSON.parse(raw) : { mode:'dark', accent:'#22d3ee' };
    const next = { ...cur, ...patch };
    if (next.mode!=='light') next.mode='dark';
    if (!/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(next.accent||'')) next.accent = '#22d3ee';

    document.documentElement.setAttribute('data-theme', next.mode);
    document.documentElement.style.setProperty('--accent', next.accent);
    const meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', next.mode==='light' ? '#f2efe7' : '#0f172a');

    const logo = document.getElementById('logoImg');
    if (logo) logo.src = (next.mode==='light') ? 'fambam2.png' : 'fambam.png';

    localStorage.setItem('ui:theme', JSON.stringify(next));
  }catch(e){ console.warn('setTheme failed', e); }
}
</script>

<!-- Home grid logic (slots + editing + Photos + Breakfast + Dinner + Chores + Points + Family previews) -->
<script>
const SLOT_KEY = 'hub:home:slots:v2';
const SLOTS_TOTAL = 16;

const CARDS = [
  {id:'breakfast', href:'./breakfast.html', emoji:'🍽️', label:'Breakfast', hint:''},
  {id:'dinner',    href:'./dinner.html',    emoji:'🍝', label:'Dinner Planner', hint:'Weekly plan'},
  {id:'chores',    href:'./chores.html',    emoji:'🧹', label:'Chores',          hint:'Weekly rotation'},
  {id:'points',    href:'./points.html',    emoji:'⭐', label:'Points',          hint:'Leaderboard'},
  {id:'family',    href:'./family.html',    emoji:'👨‍👩‍👧‍👦', label:'Family',    hint:''},
  {id:'calendar',  href:'./calendar.html',  emoji:'📅', label:'Family Calendar', hint:'Events & activities'},
  {id:'photos',    href:'./photos.html',    emoji:'🖼️', label:'Photos',          hint:'Slideshow'},
  {id:'store',     href:'./store.html',     emoji:'🛒', label:'Store',           hint:'Rewards'}
];
const byId = Object.fromEntries(CARDS.map(c=>[c.id,c]));

/* Load/save slots */
function loadSlots(){
  try{
    const v=JSON.parse(localStorage.getItem(SLOT_KEY));
    if(Array.isArray(v)) return v.slice(0,SLOTS_TOTAL).concat(Array(SLOTS_TOTAL).fill(null)).slice(0,SLOTS_TOTAL);
  }catch{}
  const seed = ['breakfast','dinner','chores','calendar','points','family','store']; // include Store by default
  return seed.concat(Array(SLOTS_TOTAL-seed.length).fill(null));
}
function saveSlots(a){ localStorage.setItem(SLOT_KEY, JSON.stringify(a)); }

let slots = loadSlots();
let isEditing = false;
let selectedCardId = null;
let selectedFromSlot = -1;

const $ = (s,e=document)=>e.querySelector(s);
const $$= (s,e=document)=>[...e.querySelectorAll(s)];

/* Photos util */
function safelyGetPhotoList(){
  try{ const arr = JSON.parse(localStorage.getItem('photos:list')) || []; return Array.isArray(arr)?arr:[]; }
  catch{ return []; }
}

/* Store util */
function readStoreItems(){
  try{
    const arr = JSON.parse(localStorage.getItem('store:items') || '[]');
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
  
/* Local-date helpers */
function todayISO(){
  const d=new Date();
  const y=d.getFullYear(), m=(d.getMonth()+1).toString().padStart(2,'0'), dd=d.getDate().toString().padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
/* NEW: month id used by the Points card to match points.html */
function monthId(d=new Date()){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}
function niceToday(){ return new Date().toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'}); }

/* Week helpers */
function startOfWeekMonday(d=new Date()){
  const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = (dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); return dt;
}
function thisMondayISO(){
  const m = startOfWeekMonday(new Date());
  const y=m.getFullYear(), mm=(m.getMonth()+1).toString().padStart(2,'0'), dd=m.getDate().toString().padStart(2,'0');
  return `${y}-${mm}-${dd}`;
}
function todayDowShort(){ return new Date().toLocaleDateString('en-US',{weekday:'short'}); }
function emojiFromLabel(label){
  const s=(label||'').trim();
  return s ? Array.from(s)[0] : '';
}
function choreIconFromName(label){
  const s=(label||'').trim();
  const first = emojiFromLabel(s);
  if (first && first !== s[0].toUpperCase()) return first;
  const L = s.toLowerCase();
  if (L.includes('table')) return '🍽️';
  if (L.includes('vacuum') || L.includes('sweep') || L.includes('clean')) return '🧹';
  if (L.includes('feed') && (L.includes('dog') || L.includes('dogs'))) return '🐶';
  if (L.includes('trash') || L.includes('garbage') || L.includes('bins')) return '🗑️';
  return first || s.charAt(0).toUpperCase();
}

/* === renderGrid (accepts optional preview order) === */
function renderGrid(previewOrder=null){
  const order = Array.isArray(previewOrder) ? previewOrder : slots;
  const wrap = $('#slots'); wrap.innerHTML='';
  for(let i=0;i<SLOTS_TOTAL;i++){
    const div = document.createElement('div');
    div.className = 'slot' + (isEditing?' editing':'');
    div.dataset.pos = i;
    const id = order[i];
    if(id && byId[id]){
      const t = renderTile(byId[id], i, order);
      if(isEditing){
        t.addEventListener('click', (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          if(selectedCardId===id){ selectedCardId=null; selectedFromSlot=-1; t.classList.remove('selecting'); return; }
          $$('.tile').forEach(x=>x.classList.remove('selecting'));
          selectedCardId = id; selectedFromSlot = i; t.classList.add('selecting');
        });
      }
      div.appendChild(t);
    } else {
      if(isEditing){
        const add = document.createElement('button');
        add.className='add-btn'; add.textContent='+';
        add.title='Add card';
        add.onclick=(ev)=>{ ev.stopPropagation(); openAddRemove(i); };
        div.appendChild(add);
      }
    }
    div.addEventListener('click', ()=>{
      if(!isEditing || selectedCardId==null) return;
      const to = i, from = selectedFromSlot;
      if(from===to) return;
      const idB = slots[to];
      slots[to] = selectedCardId;
      slots[from] = idB ?? null;
      selectedCardId=null; selectedFromSlot=-1;
      saveSlots(slots); renderGrid();
    });
    wrap.appendChild(div);
  }
}

function renderTile(c, slotIndex, orderRef){
  const a = document.createElement('a');
  a.href = c.href; a.className='tile'; a.draggable=false;

  if(c.id === 'photos'){
    const list = safelyGetPhotoList();
    if(list.length) a.classList.add('photos-card');
    if(list.length){
      a.classList.add('photo-only');
      a.innerHTML = `
        <div class="photo-prev"><img alt=""></div>
        <div class="photos-arrow">➔</div>
        <button class="minus" type="button">−</button>`;
      const img = a.querySelector('img');
      let idx = 0;
      img.src = list[0];
      const cadence = Number(localStorage.getItem('photos:cadence_ms')) || 10000;
      const timer = setInterval(()=>{ idx=(idx+1)%list.length; img.src=list[idx]; }, cadence);
      a.addEventListener('click',()=>clearInterval(timer),{once:true});
    } else {
      a.innerHTML = `<div class="label">${c.label}</div><div class="hint">${c.hint||''}</div><button class="minus" type="button">−</button>`;
    }

  } else if (c.id === 'breakfast') {
    a.innerHTML = `
      <div class="label">Breakfast</div>
      <div class="bf-box">
        <div class="bf-date">Today · ${niceToday()}</div>
        <div class="bf-empty">No selections yet — tap Breakfast.</div>
        <div class="bf-grid" aria-label="Breakfast selections" style="display:none"></div>
      </div>
      <button class="minus" type="button">−</button>
    `;
    try{
      const menu = JSON.parse(localStorage.getItem('bf:menu')||'[]');
      const key  = 'bf:day:'+todayISO();
      const day  = JSON.parse(localStorage.getItem(key)||'{}');
      const kids = (Family.getKids?.() || []);
      const entries = Object.entries(day);
      const emptyMsg = a.querySelector('.bf-empty');
      const grid = a.querySelector('.bf-grid');
      if (entries.length){
        emptyMsg.style.display='none';
        grid.style.display='grid';
        const byName = (id)=> (kids.find(k=>k.id===id)?.name || '').toLowerCase();
        entries.sort((a,b)=> byName(a[0]).localeCompare(byName(b[0])));
        for(const [kidId, idx] of entries.slice(0,4)){
          const kid = kids.find(k=>k.id===kidId);
          const choice = menu?.[idx];
          if(!choice) continue;
          const cell = document.createElement('div');
          cell.className='bf-item';
          const face = kid?.photo
            ? `<span class="bf-face"><img src="${kid.photo}" alt=""></span>`
            : `<span class="bf-face">${(kid?.name||'?').trim().charAt(0).toUpperCase()}</span>`;
          cell.innerHTML = `${face}<span class="bf-emoji">${choice.emoji||'❓'}</span>`;
          grid.appendChild(cell);
        }
      }
    }catch(err){ console.warn('Breakfast preview error', err); }

  } else if (c.id === 'dinner') {
    a.innerHTML = `
      <div class="label">Dinner Planner</div>
      <div class="dp-box">
        <div class="dp-title">Tonight’s Dinner</div>
        <div class="dp-empty">No selections yet — tap Dinner Planner.</div>
        <div class="dp-rows" style="display:none">
          <div class="dp-row"><div class="who">Kids</div><div class="dp-icons" data-row="kids"></div></div>
          <div class="dp-row"><div class="who">Parents</div><div class="dp-icons" data-row="parents"></div></div>
        </div>
      </div>
      <button class="minus" type="button">−</button>
    `;
    try{
      const mISO = thisMondayISO();
      const plan = JSON.parse(localStorage.getItem('dp:plan:'+mISO)||'null') || null;
      const dow  = todayDowShort();
      const data = plan?.days?.[dow] || null;
      const emptyMsg = a.querySelector('.dp-empty');
      const rowsWrap = a.querySelector('.dp-rows');
      if (data){
        const kidsIcons = [];
        const parsIcons = [];
        const kMain = emojiFromLabel(data.kids?.main);
        const kSide = emojiFromLabel(data.kids?.side);
        const pMain = emojiFromLabel(data.parents?.main);
        const pSide = emojiFromLabel(data.parents?.side);
        const dEmoji = emojiFromLabel(data.dessert);
        if (kMain) kidsIcons.push(kMain);
        if (kSide) kidsIcons.push(kSide);
        if (pMain) parsIcons.push(pMain);
        if (pSide) parsIcons.push(pSide);
        if (dEmoji){ kidsIcons.push(dEmoji); parsIcons.push(dEmoji); }
        const hasAny = kidsIcons.length || parsIcons.length;
        if (hasAny){
          emptyMsg.style.display='none';
          rowsWrap.style.display='grid';
          a.querySelector('.dp-icons[data-row="kids"]').innerHTML = kidsIcons.map(e=>`<span>${e}</span>`).join('');
          a.querySelector('.dp-icons[data-row="parents"]').innerHTML = parsIcons.map(e=>`<span>${e}</span>`).join('');
        }
      }
    }catch(err){ console.warn('Dinner preview error', err); }

  } else if (c.id === 'chores') {
    a.innerHTML = `
      <div class="label">Chores</div>
      <div class="ch-box">
        <div class="ch-title">This Week</div>
        <div class="ch-empty">No assignments yet — tap Chores.</div>
        <div class="ch-grid" style="display:none" aria-label="Chore assignments"></div>
      </div>
      <button class="minus" type="button">−</button>
    `;
    try{
      const mISO = thisMondayISO();
      const assigns = JSON.parse(localStorage.getItem('ch:assign:'+mISO) || '{}') || {};
      const choreList = JSON.parse(localStorage.getItem('ch:chores:list') || '[]') || [];
      const kids = (Family.getKids?.() || []);
      const choresById = Object.fromEntries(choreList.map(c=>[c.id, c.label]));
      const byKid = {};
      Object.entries(assigns).forEach(([choreId, kidId])=>{
        const label = choresById[choreId] || 'Chore';
        if(!byKid[kidId]) byKid[kidId] = [];
        byKid[kidId].push(label);
      });
      const entries = Object.entries(byKid);
      const empty = a.querySelector('.ch-empty');
      const grid  = a.querySelector('.ch-grid');
      if(entries.length){
        empty.style.display='none';
        grid.style.display='grid';
        const nameOf = id => (kids.find(k=>k.id===id)?.name || '').toLowerCase();
        entries.sort((a,b)=> nameOf(a[0]).localeCompare(nameOf(b[0])));
        for(const [kidId, labels] of entries.slice(0,4)){
          const kid = kids.find(k=>k.id===kidId);
          const face = kid?.photo
            ? `<span class="bf-face"><img src="${kid.photo}" alt=""></span>`
            : `<span class="bf-face">${(kid?.name||'?').trim().charAt(0).toUpperCase()}</span>`;
          const icons = labels.map(choreIconFromName).filter(Boolean).slice(0,3).join(' ');
          const row = document.createElement('div');
          row.className='ch-item';
          row.innerHTML = `${face}<div class="ch-task">${icons}</div>`;
          grid.appendChild(row);
        }
      }
    }catch(err){ console.warn('Chores preview error', err); }

  } else if (c.id === 'points') {
    a.innerHTML = `
      <div class="label">Points</div>
      <div class="pt-box">
        <div class="pt-title">This Month</div>
        <div class="pt-empty">No points yet — tap Points.</div>
        <div class="pt-grid" style="display:none"></div>
      </div>
      <button class="minus" type="button">−</button>
    `;
    try{
      const kids = (Family.getKids?.() || []);
      const grid = a.querySelector('.pt-grid');
      const empty = a.querySelector('.pt-empty');

      // Monthly-first, fallback to legacy all-time
      const mid = monthId();
      let balances = JSON.parse(localStorage.getItem(`pts:balances:${mid}`) || 'null') || {};
      if (!Object.keys(balances).length) {
        balances = JSON.parse(localStorage.getItem('pts:balances') || 'null') || {};
      }

      const pairs = Object.entries(balances).filter(([,v])=> typeof v==='number');
      if(pairs.length){
        empty.style.display='none';
        grid.style.display='grid';
        const nameOf = id => (kids.find(k=>k.id===id)?.name || '').toLowerCase();
        pairs.sort((a,b)=> b[1]-a[1] || nameOf(a[0]).localeCompare(nameOf(b[0])));
        for(const [kidId, pts] of pairs.slice(0,4)){
          const kid = kids.find(k=>k.id===kidId);
          const face = kid?.photo
            ? `<span class="bf-face"><img src="${kid.photo}" alt=""></span>`
            : `<span class="bf-face">${(kid?.name||'?').trim().charAt(0).toUpperCase()}</span>`;
          const row = document.createElement('div');
          row.className='pt-item';
          row.innerHTML = `${face}<div class="pt-score">${Number(pts)||0}</div>`;
          grid.appendChild(row);
        }
      }
    }catch(err){ console.warn('Points preview error', err); }

} else if (c.id === 'family') {
  a.innerHTML = `
    <div class="label">Family</div>
    <div class="fam-box">
      <div class="fam-grid" aria-label="Family"></div>
    </div>
    <button class="minus" type="button">−</button>
  `;

  try{
    const parents = (Family.getParents?.() || []).slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    const kids    = (Family.getActiveKids?.() || []).slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));

    // pick exactly 2 parents (if available) and 4 kids (if available)
    const p1 = parents[0] || null;
    const p2 = parents[1] || null;
    const k1 = kids[0]    || null;
    const k2 = kids[1]    || null;
    const k3 = kids[2]    || null;
    const k4 = kids[3]    || null;

    // desired order: row1 = p1, k1, k2 ; row2 = p2, k3, k4
    const display = [p1, k1, k2, p2, k3, k4].filter(Boolean);

    const grid = a.querySelector('.fam-grid');

    function faceHTML(person){
      const name = (person?.name || '?').trim();
      const initial = name ? name[0].toUpperCase() : '?';
      return person?.photo
        ? `<span class="bf-face"><img src="${person.photo}" alt=""></span>`
        : `<span class="bf-face"><span>${initial}</span></span>`;
    }

    display.forEach(person=>{
      const cell = document.createElement('div');
      cell.className = 'fam-item';
      cell.innerHTML = faceHTML(person); // faces only, no names
      grid.appendChild(cell);
    });
  }catch(err){ console.warn('Family preview error', err); }

} else if (c.id === 'store') {
  a.innerHTML = `
    <div class="label">Store</div>
    <div class="st-box">
      <div class="st-title">Top items this week!</div>
      <div class="st-empty">No items yet — tap Store.</div>
      <div class="st-grid" style="display:none"></div>
    </div>
    <button class="minus" type="button">−</button>
  `;
  try{
    const items = JSON.parse(localStorage.getItem('store:items') || '[]') || [];
    if (Array.isArray(items) && items.length){
      const top2 = items.slice().sort((a,b)=> (b.cost||0) - (a.cost||0)).slice(0,2);
      const grid  = a.querySelector('.st-grid');
      const empty = a.querySelector('.st-empty');
      empty.style.display='none';
      grid.style.display='grid';
      top2.forEach(it=>{
        const row = document.createElement('div');
        row.className = 'st-row';
        row.innerHTML = `
          <div style="font-size:1.4rem;line-height:1">${it.emoji || '🎁'}</div>
          <div style="font-weight:800">${it.name || 'Item'} — ${Number(it.cost)||0} Pts</div>
        `;
        grid.appendChild(row);
      });
    }
  }catch(err){ console.warn('Store preview error', err); }

  } else {
    a.innerHTML = `
      <div class="emoji">${c.emoji}</div>
      <div class="label">${c.label}</div>
      <div class="hint">${c.hint||''}</div>
      <button class="minus" type="button">−</button>
    `;
  }

  if(isEditing){ a.addEventListener('click', (e)=>e.preventDefault()); }

  const minus = a.querySelector('.minus');
  if(minus){
    ['click','pointerdown','touchstart','mousedown'].forEach(evt=>{
      minus.addEventListener(evt, (ev)=>{
        ev.preventDefault(); ev.stopPropagation();
      }, {passive:false});
    });
    minus.addEventListener('click', ()=>{
      slots[slotIndex]=null; selectedCardId=null; selectedFromSlot=-1; saveSlots(slots); renderGrid();
    });
  }

  // Long-press drag wiring (disabled in Edit Mode)
  if (!isEditing) attachLongPressDrag(a, slotIndex);

  return a;
}

/* ----- Edit controls / modal helpers ----- */
function toggleEdit(on){
  isEditing = !!on;
  $('#editBar').classList.toggle('show', isEditing);
  selectedCardId=null; selectedFromSlot=-1;
  renderGrid();
}
document.getElementById('btnDoneEdit').onclick = ()=> toggleEdit(false);

function openAddRemove(targetIndex){
  const placed = new Set(slots.filter(Boolean));
  const body = document.getElementById('addCardBody'); body.innerHTML='';
  CARDS.forEach(c=>{
    const isOnHome = placed.has(c.id);
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`
      <div class="grow">${c.emoji} <b>${c.label}</b><div style="opacity:.8">${c.hint||''}</div></div>
      <div style="display:flex;gap:8px">
        <button class="btn" data-add>Add</button>
        <button class="btn-warn" data-remove>Remove</button>
      </div>
    `;
    const btnAdd = row.querySelector('[data-add]');
    const btnRem = row.querySelector('[data-remove]');
    if(isOnHome){ btnAdd.setAttribute('disabled',''); } else { btnRem.setAttribute('disabled',''); }
    btnAdd.onclick=()=>{
      const idx = (typeof targetIndex==='number') ? targetIndex : slots.findIndex(x=>!x);
      if(idx<0){ alert('No empty slot available. Remove a card first.'); return; }
      slots[idx]=c.id; saveSlots(slots); renderGrid(); openAddRemove(idx);
    };
    btnRem.onclick=()=>{
      const ix = slots.findIndex(x=>x===c.id);
      if(ix>=0){ slots[ix]=null; saveSlots(slots); renderGrid(); }
      openAddRemove(targetIndex);
    };
    body.appendChild(row);
  });
  showModal('addCardModal', true);
}
document.getElementById('addCardDone').onclick=()=>showModal('addCardModal', false);
document.getElementById('addCardClose').onclick=()=>showModal('addCardModal', false);
document.getElementById('btnAddAnywhere').onclick=()=>{
  const firstEmpty = slots.findIndex(x=>!x);
  openAddRemove(firstEmpty<0?0:firstEmpty);
};

function showModal(id, show){
  const m=document.getElementById(id);
  if(!m) return;
  if(show){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
  else    { m.style.display='none'; m.setAttribute('aria-hidden','true'); }
}
document.getElementById('aboutOk')?.addEventListener('click',()=>showModal('aboutModal',false));
document.getElementById('aboutClose')?.addEventListener('click',()=>showModal('aboutModal',false));
</script>

<script>
/* ===== Long-press drag controller (robust) ===== */
const DND = {
  active:false, startX:0, startY:0, moved:false, timer:null,
  pickIndex:-1, hoverIndex:-1, ghost:null, preview:null,
  pressMs:400, cancelMovePx:8,
  shield:null, autoscrollDir:0, autoscrollRAF:0
};

function setAutoscroll(dir){
  if (dir === DND.autoscrollDir) return;
  DND.autoscrollDir = dir;
  if (DND.autoscrollRAF) { cancelAnimationFrame(DND.autoscrollRAF); DND.autoscrollRAF = 0; }
  if (!dir) return;
  const speed = 16; // px per frame
  const step = ()=>{
    if (!DND.active || !DND.autoscrollDir) { DND.autoscrollRAF = 0; return; }
    window.scrollBy(0, DND.autoscrollDir * speed);
    DND.autoscrollRAF = requestAnimationFrame(step);
  };
  DND.autoscrollRAF = requestAnimationFrame(step);
}
function updateEdgeScroll(clientY){
  const edge = 80;
  if (clientY < edge) setAutoscroll(-1);
  else if (clientY > (window.innerHeight - edge)) setAutoscroll(1);
  else setAutoscroll(0);
}

function attachLongPressDrag(tileEl, index){
  tileEl.addEventListener('dragstart', e=>e.preventDefault());
  tileEl.addEventListener('contextmenu', e=>e.preventDefault(), {passive:false});

  let savedHref = null;
  let tapNavigate = false;

  const onDown = (e)=>{
    if (isEditing) return;
    if (e.button === 2) return;
    const point = getPoint(e);

    if (tileEl.hasAttribute('href')) { savedHref = tileEl.getAttribute('href'); tileEl.removeAttribute('href'); }
    else savedHref = null;

    DND.startX = point.x; DND.startY = point.y;
    DND.moved = false; DND.pickIndex = index; DND.hoverIndex = index;
    DND.preview = null; tapNavigate = true;

    DND.timer = setTimeout(()=> beginDrag(tileEl, point), DND.pressMs);

    window.addEventListener('pointermove', onMove, {passive:false});
    window.addEventListener('pointerup', onUp, {passive:false, once:true});
    window.addEventListener('pointercancel', onCancel, {passive:false, once:true});
    document.addEventListener('visibilitychange', onCancelOnce, {once:true});
  };

  const onMove = (e)=>{
    const p = getPoint(e);

    if (!DND.active){
      if (dist(DND.startX,DND.startY,p.x,p.y) > DND.cancelMovePx){
        tapNavigate = false;
        cancelPress(tileEl, savedHref);
      }
      return;
    }
    // dragging
    e.preventDefault();
    updateEdgeScroll(p.y);
    positionGhost(p);

    const idx = slotIndexFromPoint(p.x, p.y);
    if (idx !== -1 && idx !== DND.hoverIndex){
      DND.hoverIndex = idx;
      const proj = projectOrder(slots, DND.pickIndex, DND.hoverIndex);
      DND.preview = proj;
      renderGrid(proj);
      highlightSlot(idx);
    }
  };

  const onUp = ()=>{
    window.removeEventListener('pointermove', onMove);
    if (!DND.active){
      cancelPress(tileEl, savedHref);
      if (tapNavigate && savedHref) location.href = savedHref;
      return;
    }
    endDrag();
    restoreHref(tileEl, savedHref);
  };

  const onCancel = ()=>{
    window.removeEventListener('pointermove', onMove);
    if (DND.active) cleanupDrag();
    restoreHref(tileEl, savedHref);
  };
  const onCancelOnce = ()=> onCancel();

  tileEl.addEventListener('pointerdown', onDown, {passive:false});
}

function beginDrag(tileEl, point){
  DND.active = true;
  try{ navigator.vibrate && navigator.vibrate(7); }catch(_){}

  // lock page scroll + disable text selection
  document.documentElement.classList.add('drag-lock');
  document.body.classList.add('drag-lock', 'dragging');

  // shield to swallow touches/clicks (prevents native scroll/selection)
  const shield = document.createElement('div');
  shield.className = 'drag-shield';
  document.body.appendChild(shield);
  DND.shield = shield;

  // ghost sized exactly like the source card
  const rect = tileEl.getBoundingClientRect();
  const clone = tileEl.cloneNode(true);
  clone.classList.add('drag-ghost');
  Object.assign(clone.style, {
    width: rect.width + 'px',
    height: rect.height + 'px',
    minWidth: rect.width + 'px',
    minHeight: rect.height + 'px',
    maxWidth: rect.width + 'px',
    maxHeight: rect.height + 'px',
    left: point.x + 'px',
    top: point.y + 'px'
  });
  document.body.appendChild(clone);
  DND.ghost = clone;

  const proj = projectOrder(slots, DND.pickIndex, DND.hoverIndex);
  DND.preview = proj;
  renderGrid(proj);
  highlightSlot(DND.hoverIndex);
}

function endDrag(){
  if (DND.preview){ slots = DND.preview.slice(); saveSlots(slots); }
  setAutoscroll(0);
  cleanupDrag();
  renderGrid();
}

function cleanupDrag(){
  clearTimeout(DND.timer); DND.timer = null;

  if (DND.autoscrollRAF) { cancelAnimationFrame(DND.autoscrollRAF); DND.autoscrollRAF = 0; }
  DND.autoscrollDir = 0;

  if (DND.ghost) DND.ghost.remove();
  DND.ghost = null;

  if (DND.shield) DND.shield.remove();
  DND.shield = null;

  document.body.classList.remove('dragging','drag-lock');
  document.documentElement.classList.remove('drag-lock');

  DND.active = false;
  DND.preview = null;

  // clear any highlights
  $$('#slots .slot').forEach(el=>el.classList.remove('drag-target'));
}

function cancelPress(tileEl, hrefToRestore){
  clearTimeout(DND.timer); DND.timer=null;
  restoreHref(tileEl, hrefToRestore);
}
function restoreHref(el, href){
  if (href !== null) el.setAttribute('href', href);
}

function positionGhost(p){
  if (!DND.ghost) return;
  DND.ghost.style.left = p.x + 'px';
  DND.ghost.style.top  = p.y + 'px';
}
function getPoint(e){
  const t = (e.touches && e.touches[0]) || e;
  return { x: t.clientX, y: t.clientY };
}
function dist(x1,y1,x2,y2){ const dx=x2-x1, dy=y2-y1; return Math.hypot(dx,dy); }
function slotIndexFromPoint(x,y){
  const slotsEls = $$('#slots .slot');
  let best=-1, bestArea=0;
  for(let i=0;i<slotsEls.length;i++){
    const r = slotsEls[i].getBoundingClientRect();
    if (x>=r.left && x<=r.right && y>=r.top && y<=r.bottom) return i;
    const area = overlapArea(r, x, y);
    if (area>bestArea){ bestArea=area; best=i; }
  }
  return best;
}
function overlapArea(r, x, y){
  const cx=(r.left+r.right)/2, cy=(r.top+r.bottom)/2;
  const d=Math.max(1, Math.hypot(cx-x, cy-y));
  return 1/d;
}
function highlightSlot(i){
  $$('#slots .slot').forEach((el,idx)=> el.classList.toggle('drag-target', idx===i));
}
function projectOrder(arr, from, to){
  if (from===to) return arr.slice();
  const out = arr.slice();
  const item = out[from];
  out.splice(from,1);
  out.splice(to,0,item);
  return out.slice(0, SLOTS_TOTAL);
}
</script>

<script>
/* ===== Export / Import ===== */
(function(){
  const ALLOW_PREFIXES = [
    'hub:',       // family admin data, slots, pin, parents/kids
    'bf:',        // breakfast
    'dp:',        // dinner planner
    'ch:',        // chores
    'pts:',       // points (all-time + monthly + ledger + pending)
    'photos:',    // photos page settings + list
    'profile:',   // profiles (older)
    'prof:',      // profiles (newer mini-store)
    'ui:'         // theme etc.
  ];

  const EXCLUDE_MEDIA_KEYS = new Set([
    'hub:wallpaper:dataurl',
    'photos:list'
  ]);

  const $ = (s,e=document)=>e.querySelector(s);

  function shouldExportKey(k){
    return ALLOW_PREFIXES.some(p => k.startsWith(p));
  }

  function exportHubDataCore({excludeMedia=false}={}){
    try{
      const dump = {
        __meta: {
          app: 'Fambam',
          version: '1',
          exportedAt: new Date().toISOString(),
          noMedia: !!excludeMedia
        },
        data: {}
      };
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if (!shouldExportKey(k)) continue;
        if (excludeMedia && EXCLUDE_MEDIA_KEYS.has(k)) continue;
        dump.data[k] = localStorage.getItem(k);
      }
      const suffix = excludeMedia ? '-nomedia' : '';
      const name = `fambam-backup${suffix}-${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      const blob = new Blob([JSON.stringify(dump)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = name;
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 1000);
    }catch(err){
      alert('Export failed: ' + (err?.message || err));
    }
  }

  function exportHubData(){ exportHubDataCore({excludeMedia:false}); }
  function exportHubDataNoMedia(){ exportHubDataCore({excludeMedia:true}); }

  // (unchanged) — your robust import that writes keys back
  async function importHubDataFile(file){
    if (!file) return;

    const readText = f => new Promise((res, rej)=>{
      const r = new FileReader();
      r.onload = ()=>res(String(r.result||''));
      r.onerror = rej;
      r.readAsText(f);
    });

    function shouldExportKey(k){
      return ['hub:','bf:','dp:','ch:','pts:','photos:','profile:','prof:','ui:'].some(p=>k.startsWith(p));
    }

    // Recompress a dataURL (used for wallpaper)
    function recompressDataUrl(dataUrl, maxSide=1600, quality=0.7){
      return new Promise(resolve=>{
        try{
          const img = new Image();
          img.onload = ()=>{
            const scale = Math.min(1, maxSide/Math.max(img.width, img.height));
            const w = Math.max(1, Math.round(img.width*scale));
            const h = Math.max(1, Math.round(img.height*scale));
            const c = document.createElement('canvas'); c.width = w; c.height = h;
            c.getContext('2d').drawImage(img,0,0,w,h);
            resolve(c.toDataURL('image/jpeg', quality));
          };
          img.onerror = ()=>resolve(null);
          img.src = dataUrl;
        }catch{ resolve(null); }
      });
    }

    try{
      const text = await readText(file);
      const parsed = JSON.parse(text||'{}');
      const data = parsed && parsed.data;
      if (!data || typeof data !== 'object') { alert('Invalid backup file.'); return; }

      if (!confirm('Importing will replace current data on this device. Continue?')) return;

      // 1) Clear existing allowed keys
      const toDelete = [];
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if (shouldExportKey(k)) toDelete.push(k);
      }
      toDelete.forEach(k=> localStorage.removeItem(k));

      // 2) Sort keys: smallest first, biggest last
      const entries = Object.entries(data)
        .filter(([k]) => shouldExportKey(k))
        .sort((a,b)=> String(a[1]).length - String(b[1]).length);

      const BIG_WALL = 'hub:wallpaper:dataurl';
      const PHOTOS   = 'photos:list';

      const skipped = [];
      const notes = [];

      // Write all small/normal keys first, defer the big two
      const deferred = [];
      for (const [k,v] of entries){
        if (k===BIG_WALL || k===PHOTOS) { deferred.push([k,v]); continue; }
        try{
          localStorage.setItem(k, String(v));
        }catch(err){
          skipped.push(k);
        }
      }

      // Wallpaper (recompress if needed)
      const wallEntry = deferred.find(([k])=>k===BIG_WALL);
      if (wallEntry){
        const [k,v] = wallEntry;
        let wall = String(v||'');
        let ok = false;
        try{
          localStorage.setItem(k, wall);
          ok = true;
        }catch{
          const recompressed = await recompressDataUrl(wall, 1600, 0.7);
          if (recompressed){
            try{
              localStorage.setItem(k, recompressed);
              ok = true; notes.push('Wallpaper recompressed to fit.');
            }catch{}
          }
        }
        if (!ok) skipped.push(k);
      }

      // Photos (trim to fit)
      const photosEntry = deferred.find(([k])=>k===PHOTOS);
      if (photosEntry){
        const [k,v] = photosEntry;
        let arr; try{ arr = JSON.parse(String(v||'[]')); if(!Array.isArray(arr)) arr=[]; }catch{ arr=[]; }

        if (arr.length){
          let lo = 0, hi = arr.length, best = 0;
          while (lo <= hi){
            const mid = Math.floor((lo+hi)/2);
            try{
              localStorage.setItem(k, JSON.stringify(arr.slice(0,mid)));
              best = mid; lo = mid + 1;
            }catch{
              hi = mid - 1;
            }
          }
          if (best < arr.length) notes.push(`Photos trimmed: kept ${best}/${arr.length}.`);
          if (best === 0){ try{ localStorage.removeItem(k); }catch{} skipped.push(k); }
        } else {
          try{ localStorage.setItem(k, '[]'); }catch{ skipped.push(k); }
        }
      }

      let msg = 'Import complete.';
      if (notes.length)   msg += '\n' + notes.join('\n');
      if (skipped.length) msg += '\nSkipped keys: ' + skipped.join(', ');
      alert(msg + '\nThe app will reload to apply the data.');
      location.reload();

    }catch(err){
      alert('Import failed: ' + (err?.message || err));
    }
  }

  // Wire buttons (now includes "No Media")
  function wireDataButtons(){
    const btnExp  = $('#btnExportData');
    const btnExpN = $('#btnExportNoMedia');
    const btnImp  = $('#btnImportData');
    const fileIn  = $('#importFileInput');

    if (btnExp && !btnExp._wired){
      btnExp._wired = true;
      btnExp.addEventListener('click', exportHubData);
    }
    if (btnExpN && !btnExpN._wired){
      btnExpN._wired = true;
      btnExpN.addEventListener('click', exportHubDataNoMedia);
    }
    if (btnImp && fileIn && !btnImp._wired){
      btnImp._wired = true;
      btnImp.addEventListener('click', ()=> fileIn.click());
      fileIn.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if (f) importHubDataFile(f);
        e.target.value = '';
      });
    }
  }

  document.addEventListener('DOMContentLoaded', wireDataButtons);
  // also try re-wiring when the modal is opened via the menu
  document.addEventListener('click', (e)=>{
    if (e.target && (e.target.id==='adminSave' || e.target.id==='adminClose' || e.target.id==='btnMenu')) {
      setTimeout(wireDataButtons, 0);
    }
  });
})();
</script>

<!-- Boot + SW -->
<script>
renderGrid();
try { Family.onChange && Family.onChange(()=>{ renderGrid(); }); } catch(_){}
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
</script>
</body>
</html>
