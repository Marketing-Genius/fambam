<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<style>
:root{
  --panel:#111827; --card:#1f2937; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee;
  --bg:#0f172a; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
  --wallpaper:url('');              /* set at runtime */
  --wallpaper-shift: 40%;
  /* Home grid sizing (keeps slots & cards aligned) */
  --slotW: 260px;
  --slotH: 180px; /* <â€” synced height for slots AND cards */
  --gridGap: 22px;
}

/* Base */
html,body{height:100%}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
  color:var(--text); background:#0f172a; overflow-x:hidden;
}

/* Wallpaper */
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background-image: var(--wallpaper);
  background-size: cover; background-repeat:no-repeat;
  background-position: center var(--wallpaper-shift);
  transform: translateZ(0);
}
/* Heavy overlay so cards/menu pop */
body::after{
  content:""; position:fixed; inset:0; z-index:-1;
  /* slightly lighter, but still heavy mask */
  background: rgba(12,17,34,0.90);
  pointer-events:none;
}

/* App layout */
.app{
  min-height: 100svh;
  display: flex; flex-direction: column; gap: 18px;
  padding: 20px;
  max-width: 1160px; margin: 0 auto;
}

/* Header (translucent) */
header{
  position:relative; z-index: 9000; isolation:isolate;
  display:flex;justify-content:space-between;align-items:center;
  background:rgba(17,24,39,.55); border:1px solid rgba(11,18,36,.35);
  border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;
  backdrop-filter: blur(8px);
}
.title{display:flex;align-items:center;gap:10px}
.title img{height:38px;display:block}
.menu-wrap{position:relative; z-index: 9001; overflow:visible}
.hamburger{font:inherit;cursor:pointer;background:rgba(11,18,36,.6);color:#e5e7eb;border:1px solid #334155;border-radius:12px;padding:10px 12px}
.menu-dropdown{
  position:absolute;right:0;top:110%;min-width:260px;z-index:9002 !important;
  background:#111827;border:1px solid #1f2937;border-radius:12px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);padding:6px;display:none
}
.menu-dropdown.open{display:block}
.menu-item{width:100%;text-align:left;padding:10px 12px;border:none;background:transparent;color:#e5e7eb;border-radius:10px;cursor:pointer}
.menu-item:hover{background:#0b1224}

/* Board (editable grid) */
.board-wrap{margin-top:6px}
.board{
  display:grid;
  grid-template-columns: repeat(4, var(--slotW));
  grid-auto-rows: var(--slotH);
  gap: var(--gridGap);
  justify-content:flex-start;
}

/* Slots (visible in edit mode) */
.slot{
  width: var(--slotW); height: var(--slotH);
  border: 2px dashed rgba(148,163,184,.35);
  border-radius: 16px;
  position: relative;
  display:none; /* only in edit */
}
.board.edit .slot{ display:block; }

/* Add â€œ+â€ button on empty slot (edit mode) */
.slot .addbtn{
  position:absolute; inset:auto 10px 10px auto;
  width:40px;height:40px;border-radius:999px;display:grid;place-items:center;
  background:#0b1224;border:1px solid #334155;color:#e5e7eb;cursor:pointer;
}

/* Card tiles */
.tile{
  width: var(--slotW);
  height: var(--slotH);          /* <â€” keep cards locked to slot height */
  display:flex;flex-direction:column;gap:10px;align-items:flex-start;
  background:rgba(31,41,55,.88);border:1px solid rgba(31,41,55,.95);
  border-radius:16px;padding:16px;text-decoration:none;color:var(--text);
  box-shadow:var(--shadow);backdrop-filter: blur(4px); position:relative; z-index:1;
  overflow:hidden;
}
.tile .emoji{font-size:36px;filter:drop-shadow(0 6px 10px rgba(0,0,0,.35))}
.tile .label{font-weight:800}
.tile .hint{opacity:.8}
.tile.disabled{opacity:.5;pointer-events:none}

/* Remove â€œâ€“â€ badge (edit mode only) */
.tile .rm{
  display:none;
  position:absolute; right:10px; bottom:10px;
  width:34px;height:34px;border-radius:999px;display:grid;place-items:center;
  background:#3f1620;border:1px solid #7f1d1d;color:#fecaca;cursor:pointer;
}
.board.edit .tile .rm{ display:grid; }

/* Move selection ring (edit mode only) */
.board.edit .tile.selected{ outline:3px solid #22d3ee; outline-offset:3px; }

/* Photos tile: image fills card, no overlay while playing */
.tile.photo { padding:0; }
.tile.photo .meta{ padding:16px; }
.tile.photo img.viewer{
  position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
  display:none; border-radius:16px;
}
.tile.photo.playing{
  background: transparent;
  border-color: transparent;
}
.tile.photo.playing .meta{ display:none; }
.tile.photo.playing img.viewer{ display:block; }

/* About modal */
.sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.modal{width:min(720px,100%);background:rgba(17,24,39,.98);border:1px solid #1f2937;border-radius:16px;box-shadow:var(--shadow)}
.modal header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2937}
.modal .body{padding:14px 16px;display:grid;gap:12px}
.modal .footer{padding:14px 16px;border-top:1px solid #1f2937;display:flex;justify-content:flex-end;gap:10px}
.btn{font:inherit;color:#e5e7eb;background:#0b1224;border:1px solid #334155;border-radius:12px;padding:10px 12px;cursor:pointer}
.btn-primary{background:linear-gradient(180deg,#22d3ee,#06b6d4);color:#001018;border:none;font-weight:800}

/* Add-card picker */
.picker{display:none;position:fixed;inset:0;z-index:10001;align-items:center;justify-content:center;background:rgba(0,0,0,.55)}
.picker>div{background:#111827;border:1px solid #1f2937;border-radius:16px;box-shadow:var(--shadow);padding:14px;min-width:300px}
.picker .row{display:grid;gap:8px}
.picker button{width:100%;text-align:left}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <img src="fambam.png" alt="Fambam">
      </div>
      <div class="menu-wrap">
        <button id="btnMenu" class="hamburger" aria-haspopup="true" aria-expanded="false" aria-controls="menuDropdown" title="Menu">â˜°</button>
        <div id="menuDropdown" class="menu-dropdown" role="menu" aria-hidden="true">
          <button class="menu-item" data-action="edithome">Edit Home</button>
          <button class="menu-item" data-action="admin">Admin Settings</button>
          <button class="menu-item" data-action="wallpaper">Edit Wallpaper</button>
          <button class="menu-item" data-action="clearwp">Clear Wallpaper</button>
          <button class="menu-item" data-action="about">About</button>
        </div>
      </div>
    </header>

    <!-- Board -->
    <div class="board-wrap">
      <div id="board" class="board"></div>
    </div>
  </div>

  <!-- About -->
  <div id="aboutModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-labelledby="aboutTitle">
    <div class="modal">
      <header>
        <div id="aboutTitle" style="font-weight:800">About Fambam</div>
        <button class="btn" data-x>âœ–</button>
      </header>
      <div class="body">
        <div>Fambam â€” single-device PWA.</div>
        <div>Wallpaper and data are stored locally on this iPad (offline-first).</div>
        <div>Home screen layout can be customized from <b>Menu â†’ Edit Home</b>.</div>
      </div>
      <div class="footer">
        <button class="btn" data-x>Close</button>
      </div>
    </div>
  </div>

  <!-- Add-card picker -->
  <div id="picker" class="picker" aria-hidden="true">
    <div>
      <div style="font-weight:800;margin-bottom:8px">Add a card</div>
      <div class="row" id="pickerList"></div>
      <div style="text-align:right;margin-top:10px">
        <button class="btn" id="pickerCancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Hidden pickers -->
  <input type="file" id="wallpaper-picker" accept="image/*" class="sr-only"/>
  <input type="file" id="photos-picker" accept="image/*" multiple class="sr-only"/>

  <!-- Family store (kept) -->
  <script src="family.js?v=3.3.6"></script>

<script>
/* -------------------- State & helpers -------------------- */
const WP_KEY='hub:wallpaper:dataurl';
const LAYOUT_KEY='hub:home:layout:v2';     // {slots:[{id|null}], cards:{id:{href,label,hint,emoji,type}}}
const PHOTOS_KEY='hub:photos:list';        // [dataURL,...]
const PHOTOS_IVL='hub:photos:interval';    // ms

const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f}catch{return f}};
const escapeHtml=s=>(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* -------------------- Initial content -------------------- */
const DEFAULT_CARDS={
  breakfast:{id:'breakfast', href:'./breakfast.html', emoji:'ðŸ½ï¸', label:'Breakfast Chooser', hint:'Tap to open'},
  dinner:   {id:'dinner',    href:'./dinner.html',    emoji:'ðŸ', label:'Dinner Planner',    hint:'Weekly plan'},
  chores:   {id:'chores',    href:'./chores.html',    emoji:'ðŸ§¹', label:'Chores',            hint:'Weekly rotation'},
  calendar: {id:'calendar',  href:'./calendar.html',  emoji:'ðŸ“…', label:'Family Calendar',   hint:'Events & activities'},
  photos:   {id:'photos',    href:'#',                emoji:'ðŸ–¼ï¸', label:'Photos',            hint:'Slideshow', type:'photos'}
};

function seedLayoutIfNeeded(){
  let st=load(LAYOUT_KEY,null);
  if(!st){
    st={
      // 4 columns Ã— 4 rows = 16 slots
      slots: Array.from({length:16}, (_,i)=>({id:null})),
      cards: DEFAULT_CARDS
    };
    // place 4 defaults in top row
    st.slots[0].id='breakfast';
    st.slots[1].id='dinner';
    st.slots[2].id='chores';
    st.slots[3].id='calendar';
    save(LAYOUT_KEY,st);
  }
  return st;
}

/* -------------------- Wallpaper -------------------- */
(function applyWallpaper(){
  const data = localStorage.getItem(WP_KEY);
  if (data) document.documentElement.style.setProperty('--wallpaper', `url("${data}")`);
})();
function pickWallpaper(){
  const input = $('#wallpaper-picker');
  input.onchange = async (ev)=>{
    const file = ev.target.files && ev.target.files[0]; if(!file) return;
    const dataUrl = await compressImage(file, 2400, 0.85);
    localStorage.setItem(WP_KEY, dataUrl);
    document.documentElement.style.setProperty('--wallpaper', `url("${dataUrl}")`);
    input.value='';
  };
  input.click();
}
function clearWallpaper(){
  localStorage.removeItem(WP_KEY);
  document.documentElement.style.setProperty('--wallpaper', `url('')`);
}
function compressImage(file, maxSide=2400, quality=.85){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      const scale=Math.min(1, maxSide/Math.max(img.width,img.height));
      const w=Math.max(1,Math.round(img.width*scale)), h=Math.max(1,Math.round(img.height*scale));
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg', quality));
    };
    const r=new FileReader(); r.onload=()=>img.src=r.result; r.readAsDataURL(file);
  });
}

/* -------------------- Menu -------------------- */
(function menu(){
  const btn = $('#btnMenu'), dd  = $('#menuDropdown');
  const openDD = ()=>{ dd.classList.add('open'); btn.setAttribute('aria-expanded','true'); dd.setAttribute('aria-hidden','false'); };
  const closeDD= ()=>{ dd.classList.remove('open'); btn.setAttribute('aria-expanded','false'); dd.setAttribute('aria-hidden','true'); };
  btn?.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.contains('open')?closeDD():openDD(); });
  document.addEventListener('click', (e)=>{ if (!dd.contains(e.target) && e.target!==btn) closeDD(); });
  dd?.addEventListener('click', (e)=>{
    const el = e.target.closest('.menu-item'); if (!el) return;
    const action = el.dataset.action; closeDD();
    if (action === 'admin') {
      const hasPin = (localStorage.getItem('hub:family:pin') ?? 'null') !== 'null';
      if (hasPin) requestPinUI(()=>alert('Open Admin from Home via #admin is kept; go to Settings in your existing flow.'));
      else alert('No PIN set.');
    } else if (action==='about'){
      show($('#aboutModal'));
    } else if (action==='edithome'){
      toggleEdit(true);
    } else if (action==='wallpaper'){ pickWallpaper(); }
    else if (action==='clearwp'){ clearWallpaper(); }
  });
  // About close
  $$('#aboutModal [data-x]').forEach(b=> b.onclick=()=>hide($('#aboutModal')));
})();

/* -------------------- Home board rendering -------------------- */
let EDIT=false, moveSelection=null, photosTimer=null, photosIdx=0;

function toggleEdit(on){
  EDIT=on;
  $('#board').classList.toggle('edit', EDIT);
  moveSelection=null;
  renderBoard();
}

function renderBoard(){
  const st=seedLayoutIfNeeded();
  const board=$('#board'); board.innerHTML='';
  st.slots.forEach((slot,ix)=>{
    // slot bg (only shows in edit)
    const s=document.createElement('div'); s.className='slot'; s.dataset.ix=ix;
    const hasCard=!!slot.id && st.cards[slot.id];
    if(!hasCard){
      const add=document.createElement('button'); add.className='addbtn'; add.textContent='+';
      add.title='Add card';
      add.onclick=()=>openPicker(ix);
      s.appendChild(add);
    }
    board.appendChild(s);

    if(hasCard){
      const c=st.cards[slot.id];
      const a=document.createElement('a');
      a.className='tile' + (c.type==='photos'?' photo':'');
      a.style.gridArea='auto'; // keep standard grid flow
      a.dataset.id=c.id;
      if(c.type==='photos'){ a.href='javascript:void(0)'; } else { a.href=c.href; }

      // Photos viewer (image under the content)
      if(c.type==='photos'){
        const img=document.createElement('img'); img.className='viewer'; img.alt='Slideshow';
        a.appendChild(img);
      }

      const meta=document.createElement('div'); meta.className='meta';
      meta.innerHTML=`<div class="emoji">${c.emoji||''}</div>
                      <div class="label">${escapeHtml(c.label||'')}</div>
                      <div class="hint">${escapeHtml(c.hint||'')}</div>`;
      a.appendChild(meta);

      // remove badge in edit mode
      const rm=document.createElement('button'); rm.className='rm'; rm.textContent='âˆ’'; rm.title='Remove from Home';
      rm.onclick=(ev)=>{ev.preventDefault(); removeCard(ix);};
      a.appendChild(rm);

      // click behavior (edit vs normal)
      if(EDIT){
        a.onclick=(ev)=>{ev.preventDefault();
          if(moveSelection===ix){ moveSelection=null; a.classList.remove('selected'); return; }
          if(moveSelection==null){ moveSelection=ix; a.classList.add('selected'); }
          else { swapSlots(moveSelection, ix); moveSelection=null; }
        };
      }else{
        if(c.type==='photos'){
          a.onclick=(ev)=>{ev.preventDefault(); openPhotosPicker();};
        }
      }

      board.appendChild(a);

      // If photos tile and not editing: start/continue slideshow and show image cleanly
      if(c.type==='photos' && !EDIT){
        const list = load(PHOTOS_KEY, []);
        const imgEl = a.querySelector('img.viewer');
        if(list.length){
          a.classList.add('playing');
          if(!photosTimer){
            photosIdx = photosIdx % list.length;
            imgEl.src = list[photosIdx];
            const ivl = load(PHOTOS_IVL, 10000);
            photosTimer = setInterval(()=>{
              const list2 = load(PHOTOS_KEY, []);
              if(!list2.length){ clearInterval(photosTimer); photosTimer=null; a.classList.remove('playing'); return; }
              photosIdx = (photosIdx+1)%list2.length;
              const anchor = $('#board .tile.photo img.viewer'); if(anchor) anchor.src=list2[photosIdx];
            }, ivl);
          } else {
            imgEl.src = list[photosIdx % list.length];
          }
        }else{
          a.classList.remove('playing');
          if(photosTimer){ clearInterval(photosTimer); photosTimer=null; }
        }
      }
    }
  });
}

/* swap and remove helpers */
function swapSlots(a,b){
  const st=seedLayoutIfNeeded();
  [st.slots[a], st.slots[b]] = [st.slots[b], st.slots[a]];
  save(LAYOUT_KEY, st);
  renderBoard();
}
function removeCard(ix){
  const st=seedLayoutIfNeeded();
  st.slots[ix].id=null;
  save(LAYOUT_KEY, st);
  renderBoard();
}

/* Add-card picker */
function openPicker(ix){
  const st=seedLayoutIfNeeded();
  const inUse = new Set(st.slots.map(s=>s.id).filter(Boolean));
  const list=$('#pickerList'); list.innerHTML='';
  Object.values(st.cards).forEach(c=>{
    if(inUse.has(c.id)) return;
    const btn=document.createElement('button'); btn.className='btn';
    btn.innerHTML=`${c.emoji||''} ${escapeHtml(c.label)}`;
    btn.onclick=()=>{ st.slots[ix].id=c.id; save(LAYOUT_KEY,st); closePicker(); renderBoard(); };
    list.appendChild(btn);
  });
  show($('#picker'));
}
function closePicker(){ hide($('#picker')); }
$('#pickerCancel').onclick=closePicker;

/* Edit toggle via hash (optional) */
window.addEventListener('keydown',e=>{
  if(e.key==='Escape' && EDIT){ toggleEdit(false); }
});

/* -------------------- Photos: pick & interval -------------------- */
function openPhotosPicker(){
  // tap photo card to add/replace images; long-term you can add a small gear menu
  const input=$('#photos-picker');
  input.onchange=async (ev)=>{
    const files=[...ev.target.files||[]];
    if(!files.length) return;
    const resized=[];
    for(const f of files){
      const b=await compressImage(f, 2000, .85);
      resized.push(b);
    }
    const prev=load(PHOTOS_KEY,[]);
    save(PHOTOS_KEY, prev.concat(resized));
    input.value='';
    renderBoard();
  };
  input.click();
}

/* -------------------- Modal helpers -------------------- */
function show(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function hide(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }

/* -------------------- PIN modal (re-used from earlier pages if needed) -------------------- */
function requestPinUI(onSuccess){
  // lightweight inline prompt here to avoid re-introducing the big modal on Home
  const pin=prompt('Enter Admin PIN (numbers only):','');
  if(pin==null) return;
  if(!/^\d{1,8}$/.test(pin)) return alert('PIN must be 1â€“8 digits.');
  try{
    if(Family && Family.verifyPin && Family.verifyPin(pin)) onSuccess&&onSuccess();
    else alert('Incorrect PIN.');
  }catch{ onSuccess&&onSuccess(); }
}

/* -------------------- Boot -------------------- */
seedLayoutIfNeeded();
toggleEdit(false); // render once

// SW
if('serviceWorker' in navigator){ addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{})); }
</script>
</body>
</html>
