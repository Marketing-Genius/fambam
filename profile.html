<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam · Profile</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<!-- Shared wallpaper + app styles -->
<link rel="stylesheet" href="wallpaper.css">
<link rel="stylesheet" href="fambam.css">
<script src="wallpaper.js" defer></script>

<!-- THEME + HEADER FLOAT BOOT (kept) -->
<script>
(function () {
  var DARK_SRC='fambam.png', LIGHT_SRC='fambam2.png';
  var theme={mode:'dark',accent:'#22d3ee'};
  function apply(t){
    var mode=(t&&t.mode==='light')?'light':'dark', accent=(t&&t.accent)||'#22d3ee';
    theme={mode,accent};
    document.documentElement.setAttribute('data-theme',mode);
    document.documentElement.style.setProperty('--accent',accent);
    var meta=document.querySelector('meta[name="theme-color"]');
    if(meta) meta.setAttribute('content', mode==='light'?'#f2efe7':'#0f172a');
  }
  function swap(){
    var img=document.getElementById('logoImg')||document.querySelector('.brand img')||document.querySelector('img[alt="Fambam"]');
    if(!img) return; var base=img.getAttribute('src')||'';
    base=base.replace(/[^/]*$/,''); img.src=base+(theme.mode==='light'?LIGHT_SRC:DARK_SRC);
    var a=img.closest('a'); if(a && !a.getAttribute('href')) a.href='./index.html';
  }
  try{apply(JSON.parse(localStorage.getItem('ui:theme')||'null')||theme);}catch{apply(theme);}
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',swap,{once:true});} else {swap();}
  addEventListener('storage',e=>{ if(e.key==='ui:theme'){ try{apply(JSON.parse(e.newValue||'{}'));}catch{} swap(); } });
})();
(function(){
  function apply(){ try{document.body.classList.toggle('header-float', !!JSON.parse(localStorage.getItem('ui:headerFloat')||'false'));}catch{} }
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',apply,{once:true});} else {apply();}
  addEventListener('storage',e=>{ if(e.key==='ui:headerFloat') apply(); });
})();
</script>

<style>
/* small, page-scoped helpers */
.page-profile .app{ max-width:980px; margin:0 auto; padding:20px; display:grid; gap:18px; grid-template-rows:auto auto 1fr auto; }
.page-profile .panel{ backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
.page-profile .face{ width:72px;height:72px;border-radius:50%;overflow:hidden;display:grid;place-items:center;background:var(--chipBg);border:2px solid var(--chipBorder);font-weight:800;font-size:28px; }
.page-profile .small{ color:var(--muted); }
</style>
</head>

<body class="page-profile">
<div class="app">
  <header class="panel header app-header">
    <a href="./family.html" class="brand" title="Back">
      <img id="logoImg" src="fambam.png" alt="Fambam">
    </a>
    <div class="title" id="title">Profile</div>
  </header>

  <!-- Unified glass profile panel -->
  <section class="panel" id="profileSection">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <span class="face" id="pfFace"></span>
      <div>
        <div style="font-weight:800;font-size:1.4rem" id="pfName">Profile</div>
        <div class="small" id="pfRole">—</div>
        <div class="small" id="pfAge">Age —</div>
      </div>
      <div style="margin-left:auto">
        <button class="btn" id="btnNotesMentions">Notes mentioning this person</button>
      </div>
    </div>

    <div style="margin-top:12px;display:grid;gap:10px">
      <label class="small">Birthday
        <input id="pfBirthday" type="date" style="display:block;margin-top:6px;width:240px" />
      </label>

      <div id="rewardSection" class="section" style="background:var(--card);border:1px solid var(--panelBorder);border-radius:12px;padding:10px">
        <div style="font-weight:700;margin-bottom:8px">Reward Goal</div>
        <div style="display:grid;grid-template-columns:1fr 120px;gap:8px;align-items:end;max-width:520px">
          <label class="small">Item name
            <input id="goalLabel" type="text" placeholder="Robux" style="display:block;margin-top:6px">
          </label>
          <label class="small">Cost (pts)
            <input id="goalCost" type="number" min="1" step="1" placeholder="800" style="display:block;margin-top:6px">
          </label>
        </div>
        <div style="margin-top:10px">
          <div class="small" id="ptsSummary">Points —</div>
          <div style="height:14px;background:var(--chipBg);border:1px solid var(--chipBorder);border-radius:999px;overflow:hidden;margin-top:6px">
            <div id="goalBar" style="height:100%;width:0%;background:var(--accent)"></div>
          </div>
          <div class="small" id="goalPct" style="margin-top:6px;opacity:.8">0%</div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="saveGoal">Save Goal</button>
          <button class="btn" id="clearGoal">Clear Goal</button>
        </div>
      </div>
    </div>
  </section>

  <footer style="text-align:center;opacity:.7">Works offline. Data stays on this device (local only).</footer>
</div>

<!-- Mentions modal -->
<div class="modal-backdrop" id="mentionsModal" aria-hidden="true" role="dialog" aria-labelledby="mentionsTitle">
  <div class="modal">
    <header>
      <div id="mentionsTitle" style="font-weight:800">Mentions</div>
      <button id="mentionsClose" class="btn">✖</button>
    </header>
    <div class="body" id="mentionsBody"></div>
    <div class="footer">
      <button id="mentionsDone" class="btn">Done</button>
    </div>
  </div>
</div>

<!-- Family store -->
<script src="family.js?v=3.3.6"></script>

<script>
/* ---------- utils & stores ---------- */
const $=(s,e=document)=>e.querySelector(s);
const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));

/* Fallback Family if file missing */
if(!window.Family){
  (function(){
    const K={kids:'hub:family:kids',parents:'hub:family:parents'};
    const L=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{return f}};
    const S=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
    function up(key,item){const a=L(key,[]);const i=a.findIndex(x=>String(x.id)===String(item.id)); if(i>=0)a[i]={...a[i],...item}; else a.push(item); S(key,a);}
    window.Family={
      getKids(){return L(K.kids,[])}, getParents(){return L(K.parents,[])},
      upsertKid(k){ up(K.kids,k); }, upsertParent(p){ up(K.parents,p); }
    };
  })();
}

/* Profile blob helpers */
const Prof={ key:id=>`prof:${id}`,
  load(id){ try{return JSON.parse(localStorage.getItem(this.key(id)))||{}}catch{return{}} },
  save(id,patch){ const cur=this.load(id); save(this.key(id), {...cur, ...patch}); }
};

/* Resolve id + person */
const id = decodeURIComponent((location.hash||'').slice(1));
function resolvePerson(){
  const P=(Family.getParents?.()||[]), K=(Family.getKids?.()||[]);
  const person = [...P,...K].find(p=>String(p.id)===id) || null;
  return { person, isParent: P.some(p=>String(p.id)===id) };
}
let { person, isParent } = resolvePerson();

/* Date helpers */
function toInputDate(src){
  if(!src) return '';
  if(/^\d{4}-\d{2}-\d{2}$/.test(src)) return src;
  const m = src.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/); if(!m) return '';
  const y = m[3].length===2 ? (+m[3]>50?`19${m[3]}`:`20${m[3]}`) : m[3];
  return `${y}-${String(m[1]).padStart(2,'0')}-${String(m[2]).padStart(2,'0')}`;
}
function calcAge(iso){
  if(!iso) return null; const [y,m,d]=iso.split('-').map(Number); if(!(y&&m&&d)) return null;
  const now=new Date(), b=new Date(y,m-1,d); if(isNaN(b)) return null;
  let a=now.getFullYear()-y; if(now.getMonth()<m-1 || (now.getMonth()==m-1 && now.getDate()<d)) a--; return (a>=0&&a<140)?a:null;
}

/* Mentions from Dinner notes */
function getDinnerNotes(){ return load('dp:food:notes', {}); }
function openMentions(){
  const name=(person?.name||'').trim(); const wrap=$('#mentionsBody'); wrap.innerHTML='';
  if(!name){ wrap.innerHTML='<div style="opacity:.7">No name on this profile.</div>'; showMentions(); return; }
  const rx=new RegExp(`\\b${name.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&')}\\b`,'i');
  const hits=Object.entries(getDinnerNotes()).map(([label,obj])=>({label,text:String(obj?.global||'')})).filter(x=>x.text&&rx.test(x.text));
  wrap.innerHTML = hits.length
    ? hits.map(h=>`<div class="item"><div><b>${h.label}</b><div class="small" style="margin-top:4px;white-space:pre-wrap">${h.text}</div></div></div>`).join('')
    : '<div style="opacity:.7">No mentions found in dinner notes.</div>';
  showMentions();
}
function showMentions(){ const m=$('#mentionsModal'); m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function hideMentions(){ const m=$('#mentionsModal'); m.style.display='none'; m.setAttribute('aria-hidden','true'); }
addEventListener('DOMContentLoaded',()=>{ $('#btnNotesMentions').onclick=openMentions; $('#mentionsClose').onclick=hideMentions; $('#mentionsDone').onclick=hideMentions; });

/* ---------- Render ---------- */
function renderProfile(){
  if(!person){ $('#profileSection').innerHTML='<div>Profile not found.</div>'; return; }
  document.title=`Fambam · ${person.name||'Profile'}`;
  $('#title').textContent=person.name||'Profile';
  $('#pfName').textContent=person.name||'Profile';
  $('#pfRole').textContent=isParent?'Parent':'Kid';
  $('#pfFace').innerHTML = person.photo ? `<img src="${person.photo}" alt="">` : (person.name||'?').trim().charAt(0).toUpperCase();

  const bd = person.birthday || Prof.load(id).birthday || '';
  const bdEl = $('#pfBirthday'); bdEl.value = toInputDate(bd);
  const age = calcAge(bdEl.value); $('#pfAge').textContent = (age!=null)?`Age ${age}`:'Age —';

  // parents do not need goal tracking
  $('#rewardSection').style.display = isParent ? 'none' : '';

  if(!isParent){
    const pts = Number(localStorage.getItem(`points:total:${id}`)||0);
    const goal = load(`pf:goal:${id}`, null) || {};
    $('#goalLabel').value = goal.label||'';
    $('#goalCost').value  = goal.cost ||'';
    const cost=Math.max(1, Number($('#goalCost').value||0)||1);
    const pct=Math.max(0, Math.min(100, Math.round(pts*100/cost)));
    $('#goalBar').style.width=pct+'%';
    $('#goalPct').textContent = `${pct}% ${goal.label?`towards ${goal.label}`:''}`;
    $('#ptsSummary').textContent = `${pts} / ${cost} pts`;

    $('#saveGoal').onclick=()=>{ const label=($('#goalLabel').value||'').trim(); const cost=Math.max(1, Number($('#goalCost').value||0)||1); save(`pf:goal:${id}`,{label,cost}); renderProfile(); };
    $('#clearGoal').onclick=()=>{ localStorage.removeItem(`pf:goal:${id}`); renderProfile(); };
  }

  // persist birthday to Family + prof
  $('#pfBirthday').onchange=()=>{
    const iso = $('#pfBirthday').value||'';
    if(isParent) Family.upsertParent({...person, birthday: iso}); else Family.upsertKid({...person, birthday: iso});
    Prof.save(id, {birthday: iso});
    // refresh local person + age
    ({person, isParent} = resolvePerson());
    const a=calcAge(iso); $('#pfAge').textContent=(a!=null)?`Age ${a}`:'Age —';
    // ping other tabs/pages (Family) to rerender
    dispatchEvent(new StorageEvent('storage', {key:`prof:${id}`, newValue: JSON.stringify(Prof.load(id))}));
  };
}

document.addEventListener('DOMContentLoaded', renderProfile);
addEventListener('storage',e=>{
  if(!e.key) return;
  if(e.key.startsWith('hub:family:') || e.key===`pf:goal:${id}` || e.key===`points:total:${id}` || e.key===Prof.key(id)){
    ({person,isParent}=resolvePerson());
    renderProfile();
  }
});

if('serviceWorker' in navigator){ addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{})); }
</script>
</body>
</html>