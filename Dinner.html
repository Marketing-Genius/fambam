<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam · Dinner Planner</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<!-- Universal wallpaper -->
<link rel="stylesheet" href="wallpaper.css">
<script src="wallpaper.js" defer></script>

<!-- Shared app styles -->
<link rel="stylesheet" href="fambam.css">

<!-- THEME BOOT (same across pages) -->
<script>
(function themeBoot(){
  try{
    const raw = localStorage.getItem('ui:theme');
    const saved = raw ? JSON.parse(raw) : { mode:'dark', accent:'#22d3ee' };
    const mode = (saved.mode==='light') ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.style.setProperty('--accent', saved.accent || '#22d3ee');
    const meta = document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute('content', mode==='light' ? '#f2efe7' : '#0f172a');

    const swapLogo = ()=>{
      const logo = document.querySelector('.brand img');
      if (logo) logo.src = (mode==='light') ? 'fambam2.png' : 'fambam.png';
    };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', swapLogo, {once:true});
    } else { swapLogo(); }

    window.addEventListener('storage', (e)=>{
      if (e.key!=='ui:theme') return;
      try{
        const t = JSON.parse(e.newValue||'{}');
        const m = (t.mode==='light') ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', m);
        document.documentElement.style.setProperty('--accent', t.accent || '#22d3ee');
        if (meta) meta.setAttribute('content', m==='light' ? '#f2efe7' : '#0f172a');
        const logo = document.querySelector('.brand img');
        if (logo) logo.src = (m==='light') ? 'fambam2.png' : 'fambam.png';
      }catch(_){}
    });
  }catch(_){}
})();
</script>

<style>
/* ---------- Dinner page (scoped) ---------- */
.page-dinner .app{
  max-width:1100px; margin:0 auto; padding:20px;
  display:grid; gap:16px; grid-template-rows:auto auto 1fr auto;
}

/* keep header and dropdown above content; align title next to logo, menu right */
.page-dinner header.panel { position:relative; z-index:1000; }
.page-dinner .menu-wrap { position:relative; z-index:1001; }
.page-dinner .menu-dd    { z-index:1002; }
.page-dinner .header{ justify-content:flex-start; }
.page-dinner .header .menu-wrap{ margin-left:auto; }

/* Week bar */
.page-dinner .weekbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
.page-dinner .weekbtn{ background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--text); padding:8px 12px; border-radius:12px; cursor:pointer }
.page-dinner .weekbtn.active{ outline:2px solid var(--accent); }
.page-dinner .navbtn{ background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer }
.page-dinner .weekspacer{ flex:1 }
.page-dinner .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--muted) }

/* Layout */
.page-dinner .grid{ display:grid; gap:14px; grid-template-columns:1fr 1fr; }
@media(max-width:900px){ .page-dinner .grid{ grid-template-columns:1fr; } }

/* Left: editor */
.page-dinner .card{ background:var(--panel); border:1px solid var(--panelBorder); border-radius:16px; padding:12px }
.page-dinner .card .topline{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px }
.page-dinner .row{ display:grid; grid-template-columns:92px 1fr 1fr; gap:10px; align-items:center }
@media(max-width:720px){ .page-dinner .row{ grid-template-columns:88px 1fr } }
.page-dinner .tile-select{ display:flex; align-items:center; gap:8px; background:var(--chipBg); border:1px solid var(--chipBorder); border-radius:14px; padding:10px 12px; min-height:54px }
.page-dinner .tile-select select{ width:100% }
.page-dinner .row + .row{ margin-top:6px }
.page-dinner .row.dessert{ grid-template-columns:92px 1fr; margin-top:14px }

/* Right: recipes + groceries */
.page-dinner .rgrid{ display:grid; gap:10px; grid-template-columns:1fr; }
.page-dinner .rcard{ background:var(--panel); border:1px solid var(--panelBorder); border-radius:16px; padding:12px; display:grid; gap:10px }
.page-dinner .section{ background:var(--chipBg); border:1px solid var(--chipBorder); border-radius:12px; padding:10px }
.page-dinner .linkbar{ display:flex; flex-wrap:wrap; gap:8px }
.page-dinner .a-btn, .page-dinner .btn{ display:inline-flex; align-items:center; gap:6px; text-decoration:none }
.page-dinner .grobox{ background:var(--chipBg); border:1px solid var(--chipBorder); border-radius:12px; padding:10px; max-height:220px; overflow:auto; white-space:pre-wrap }

/* Modals */
.page-dinner .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:10000; padding:20px }
.page-dinner .modal{ width:min(900px,100%); max-height:90vh; display:flex; flex-direction:column; background:var(--panel); border:1px solid var(--panelBorder); border-radius:16px; box-shadow:var(--shadow) }
.page-dinner .modal header{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--panelBorder); position:sticky; top:0; background:inherit }
.page-dinner .modal .body{ padding:12px 14px; display:grid; gap:12px; overflow:auto; max-height:70vh }
.page-dinner .modal .footer{ padding:12px 14px; border-top:1px solid var(--panelBorder); display:flex; justify-content:flex-end; gap:10px }
.page-dinner .list{ display:grid; gap:8px }
.page-dinner .item{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; background:var(--card); border:1px solid var(--panelBorder); border-radius:12px; padding:8px }
.page-dinner input[type="text"], .page-dinner textarea, .page-dinner select{
  background:var(--chipBg); border:1px solid var(--chipBorder); border-radius:12px; padding:8px 10px; color:var(--text); font:inherit
}
.page-dinner textarea{ min-height:88px; resize:vertical }
.page-dinner .hint{ opacity:.8; font-size:.9rem; text-align:center }
.page-dinner .version{ opacity:.6; font-size:.8rem; margin-top:6px }

/* Ratings */
.page-dinner .kidrow{ display:flex; align-items:center; justify-content:space-between; gap:10px; background:var(--chipBg); border:1px solid var(--chipBorder); border-radius:12px; padding:10px }
.page-dinner .starsel{ font-size:22px; letter-spacing:2px; cursor:pointer }
.page-dinner .starsel span{ opacity:.55 }
.page-dinner .starsel span.on{ opacity:1 }
.page-dinner .face{ width:38px; height:38px; border-radius:50%; background:var(--chipBg); display:grid; place-items:center; font-weight:800; border:1px solid var(--chipBorder); overflow:hidden }
.page-dinner .face img{ width:100%; height:100%; object-fit:cover }
</style>
</head>

<body class="page-dinner">
  <div class="app">
    <!-- Shared header -->
    <header class="panel header">
      <a href="./index.html" class="brand" title="Home">
        <img src="fambam.png" alt="Fambam">
      </a>
      <div class="title">
        <div class="big" style="font-size:1.6rem">Dinner Planner</div>
        <div class="small">Plan dinners for the week. Templates, groceries & sharing included.</div>
      </div>
      <div class="menu-wrap">
        <button id="btnMenu" class="hamburger" aria-haspopup="true" aria-expanded="false">☰</button>
        <div id="menuDD" class="menu-dd" role="menu" aria-hidden="true">
          <button class="mi" data-action="templates">Templates</button>
          <button class="mi" data-action="groceries">Groceries</button>
          <button class="mi" data-action="shareGro">Share Groceries</button>
          <button class="mi" data-action="sharePlan">Share Plan</button>
          <button class="mi" data-action="manage">Manage</button>
          <button class="mi" data-action="reset">Reset Week</button>
        </div>
      </div>
    </header>

    <!-- Week nav -->
    <section class="panel weekbar" id="weekbar">
      <button id="wPrev" class="navbtn" title="Previous week">◀</button>
      <div id="weekDays" style="display:flex;gap:8px;flex-wrap:wrap"></div>
      <button id="wToday" class="navbtn">Today</button>
      <button id="wNext" class="navbtn" title="Next week">▶</button>
      <div class="weekspacer"></div>
      <div class="badge">Week of <b id="weekLabel">—</b></div>
    </section>

    <section class="grid">
      <!-- Left: editor -->
      <div class="card">
        <div class="topline">
          <h3 style="margin-bottom:0">Selections</h3>
          <div class="linkbar">
            <button id="btnRatings" class="btn">Ratings</button>
            <button id="btnNotes" class="btn">Notes</button>
          </div>
        </div>

        <div class="row">
          <div class="muted" style="color:var(--muted)">Kids</div>
          <div class="tile-select"><select id="selKidsMain"></select></div>
          <div class="tile-select"><select id="selKidsSide"></select></div>
        </div>

        <div class="row">
          <div class="muted" style="color:var(--muted)">Parents</div>
          <div class="tile-select"><select id="selParMain"></select></div>
          <div class="tile-select"><select id="selParSide"></select></div>
        </div>

        <div class="row dessert">
          <div class="muted" style="color:var(--muted)">Dessert</div>
          <div class="tile-select"><select id="selDessert"></select></div>
        </div>
      </div>

      <!-- Right: Recipes + Groceries -->
      <div class="rgrid">
        <div class="rcard">
          <div style="font-weight:800">Recipes</div>
          <div class="section">
            <div style="font-weight:700" id="kidsRecTitle">Kids recipes</div>
            <div class="linkbar" id="kidsLinks"></div>
          </div>
          <div class="section">
            <div style="font-weight:700" id="parRecTitle">Parents recipes</div>
            <div class="linkbar" id="parLinks"></div>
          </div>
          <div class="small" style="opacity:.75">Opens in your browser (Allrecipes, YouTube).</div>
        </div>
        <div class="rcard">
          <div style="font-weight:800">Groceries</div>
          <div id="groPreview" class="grobox">—</div>
          <div class="linkbar">
            <button id="openGroModal" class="btn">Open full list</button>
            <button id="groCopyInline" class="btn">Copy</button>
            <button id="groDownloadInline" class="btn">Download .txt</button>
          </div>
        </div>
      </div>
    </section>

    <div class="hint">
      Works offline. Data stays on this device (local only).
      <div class="version">Dinner Planner v2.5.3</div>
    </div>
  </div>

  <!-- Modals (unchanged HTML, use shared .btn styles) -->
  <!-- Manage -->
  <div class="modal-backdrop" id="manageModal" aria-hidden="true" role="dialog" aria-labelledby="manageTitle">
    <div class="modal">
      <header>
        <div id="manageTitle" style="font-weight:800">Manage Menus</div>
        <button id="manageClose" class="btn">✖</button>
      </header>
      <div class="body">
        <div style="font-weight:700">Food Options (for Main & Side)</div>
        <div id="foodList" class="list"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="newFood" type="text" placeholder="Add food (e.g., 🍕 Pizza)"/>
          <button id="addFood" class="btn">Add</button>
        </div>

        <div style="font-weight:700">Dessert Options</div>
        <div id="dessertList" class="list"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="newDessert" type="text" placeholder="Add dessert (e.g., 🍨 Ice Cream)"/>
          <button id="addDessert" class="btn">Add</button>
        </div>

        <div style="font-weight:700">Pantry / Staples (excluded from grocery list)</div>
        <textarea id="pantryBox" placeholder="e.g., salt, pepper, ketchup, olive oil"></textarea>
      </div>
      <div class="footer">
        <button id="manageSave" class="btn">Done</button>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <div class="modal-backdrop" id="tplModal" aria-hidden="true" role="dialog" aria-labelledby="tplTitle">
    <div class="modal">
      <header>
        <div id="tplTitle" style="font-weight:800">Templates</div>
        <button id="tplClose" class="btn">✖</button>
      </header>
      <div class="body">
        <div style="font-weight:700">Built-ins</div>
        <div class="list" id="tplBuiltins"></div>
        <div style="font-weight:700">Your Templates</div>
        <div class="list" id="tplUser"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="tplName" type="text" placeholder="Template name (e.g., Week: Pizza Friday)"/>
          <button id="tplSave" class="btn">Save Current as Template</button>
        </div>
      </div>
      <div class="footer">
        <button id="tplApplyDone" class="btn">Done</button>
      </div>
    </div>
  </div>

  <!-- Groceries -->
  <div class="modal-backdrop" id="groModal" aria-hidden="true" role="dialog" aria-labelledby="groTitle">
    <div class="modal">
      <header>
        <div id="groTitle" style="font-weight:800">Grocery List</div>
        <button id="groClose" class="btn">✖</button>
      </header>
      <div class="body" id="groBody"></div>
      <div class="footer">
        <button id="groCopy" class="btn">Copy</button>
        <button id="groDownload" class="btn">Download .txt</button>
      </div>
    </div>
  </div>

  <!-- Day Notes -->
  <div class="modal-backdrop" id="dayNotesModal" aria-hidden="true" role="dialog" aria-labelledby="dayNotesTitle">
    <div class="modal">
      <header>
        <div id="dayNotesTitle" style="font-weight:800">Food Notes</div>
        <button id="dayNotesClose" class="btn">✖</button>
      </header>
      <div class="body" id="dayNotesBody"></div>
      <div class="footer">
        <button id="dayNotesDone" class="btn">Done</button>
      </div>
    </div>
  </div>

  <!-- Ratings -->
  <div class="modal-backdrop" id="rateModal" aria-hidden="true" role="dialog" aria-labelledby="rateTitle">
    <div class="modal">
      <header>
        <div id="rateTitle" style="font-weight:800">Rate tonight's dinner</div>
        <button id="rateClose" class="btn">✖</button>
      </header>
      <div class="body" id="rateBody"></div>
      <div class="footer">
        <button id="rateSave" class="btn">Save ratings</button>
      </div>
    </div>
  </div>

  <!-- Your Recipes -->
  <div class="modal-backdrop" id="yourRecModal" aria-hidden="true" role="dialog" aria-labelledby="yourRecTitle">
    <div class="modal">
      <header>
        <div id="yourRecTitle" style="font-weight:800">Your Recipes</div>
        <button id="yourRecClose" class="btn">✖</button>
      </header>
      <div class="body">
        <div id="yourRecList" class="list"></div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="yourRecTitleInput" type="text" placeholder="Title (e.g., Smash Burgers)"/>
          <input id="yourRecUrlInput" type="text" placeholder="https://..."/>
          <button id="yourRecAdd" class="btn">Add Recipe</button>
        </div>
        <div style="opacity:.7">Up to 5 recipes per item. Links open in your browser.</div>
      </div>
      <div class="footer">
        <button id="yourRecDone" class="btn">Done</button>
      </div>
    </div>
  </div>

<!-- Family Store -->
<script src="family.js?v=3.3.6"></script>

<!-- ==== ORIGINAL DINNER JS (unchanged logic) ==== -->
<script>
/* (JS exactly as in your version; only header menu wiring changed to #btnMenu / #menuDD) */

/* ---------- Helpers ---------- */
const LS={foods:'dp:foods:list',desserts:'dp:desserts:list',week:(m)=>`dp:plan:${m}`,templates:'dp:tpls',pantry:'dp:pantry', notes:'dp:food:notes', myrec:'dp:myrec:'};
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uid=()=>Math.random().toString(36).slice(2,10);
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function cleanLabel(s){ return (s||'').replace(/^[^\w]+/,'').trim().toLowerCase(); }

/* Local week/day helpers (no UTC shift) */
const DAYS=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
function localISO(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`;}
function startOfWeekMondayLocal(d=new Date()){const m=new Date(d.getFullYear(),d.getMonth(),d.getDate());const off=(m.getDay()+6)%7;m.setDate(m.getDate()-off);return m;}
function mondayISO(d){return localISO(d||state.weekStart);}
function weekLabelText(mISO){const [Y,M,D]=mISO.split('-').map(n=>+n);const s=new Date(Y,M-1,D);const e=new Date(s);e.setDate(e.getDate()+6);const f=d=>d.toLocaleDateString(undefined,{month:'short',day:'numeric'});return `${f(s)} – ${f(e)}`;}
function niceDay(mISO,idx){const dt=new Date(mISO+'T00:00:00');dt.setDate(dt.getDate()+idx);return dt.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'});}

/* Model */
function emptyDay(){return {kids:{main:"",side:""},parents:{main:"",side:""},dessert:"",rating:null,ratings:{}}}
function loadWeekPlan(mISO){let p=load(LS.week(mISO),null);if(!p){p={days:{}};DAYS.forEach(d=>p.days[d]=emptyDay());save(LS.week(mISO),p);}return p;}
function saveWeekPlan(mISO,plan){save(LS.week(mISO),plan)}

/* Seed menus first run */
function seedFoodsIfNeeded(){
  let foods=load(LS.foods,null);
  if(!Array.isArray(foods)||foods.length<10){
    foods=["🍕 Pizza","🌮 Tacos","🍝 Spaghetti","🍗 Chicken Nuggets","🥪 Sandwiches","🌭 Hot Dogs","🍔 Burgers","🥗 Caesar Salad","🍛 Curry & Rice","🥟 Potstickers","🥔 Baked Potatoes","🍜 Ramen","🥙 Pita & Hummus","🐟 Baked Fish","🍲 Soup","🥦 Veggie Stir-Fry","🍟 French Fries","🥗 Salad","🥦 Mixed Veggies","🌽 Corn","🥔 Potatoes"];
    save(LS.foods,foods);
  }
  let desserts=load(LS.desserts,null);
  if(!Array.isArray(desserts)||desserts.length<3){
    desserts=["🍪 Cookies","🍨 Ice Cream","🍰 Cake","🍓 Berries & Cream","🥧 Pie"];
    save(LS.desserts,desserts);
  }
  if(load(LS.pantry,null)==null){ save(LS.pantry,["salt","pepper","ketchup","mustard","olive oil","butter"]); }
}

/* ---------- State ---------- */
let state = {
  weekStart: startOfWeekMondayLocal(new Date()),
  selectedIndex: (new Date().getDay()+6)%7
};
function dayKey(){ return DAYS[state.selectedIndex]; }

/* ---------- Weekbar ---------- */
function renderWeekbar(){
  const mISO = mondayISO();
  $('#weekLabel').textContent = weekLabelText(mISO);
  const daysWrap = $('#weekDays'); daysWrap.innerHTML='';
  for(let i=0;i<7;i++){
    const btn=document.createElement('button'); btn.className='weekbtn';
    btn.textContent = niceDay(mISO, i);
    if(i===state.selectedIndex) btn.classList.add('active');
    btn.onclick=()=>{ state.selectedIndex=i; render(); };
    daysWrap.appendChild(btn);
  }
}
$('#wPrev').onclick = ()=>{ state.weekStart.setDate(state.weekStart.getDate()-7); state.selectedIndex=0; render(); };
$('#wNext').onclick = ()=>{ state.weekStart.setDate(state.weekStart.getDate()+7); state.selectedIndex=0; render(); };
$('#wToday').onclick= ()=>{ state.weekStart = startOfWeekMondayLocal(new Date()); state.selectedIndex=(new Date().getDay()+6)%7; render(); };

/* ---------- Rendering ---------- */
function fillOptions(sel, list, selected){
  sel.innerHTML='';
  const ph = '— Choose item —';
  const arr = [ph, ...list];
  arr.forEach(v=>{
    const o=document.createElement('option');
    o.value = (v===ph?'':v); o.textContent=v;
    if((v===ph && !selected) || o.value===selected) o.selected=true;
    sel.appendChild(o);
  });
}
function render(){
  renderWeekbar();
  const mISO=mondayISO();
  const plan=loadWeekPlan(mISO);
  const foods=load(LS.foods,[]), desserts=load(LS.desserts,[]);
  const day=plan.days[dayKey()] || emptyDay();

  fillOptions($('#selKidsMain'), foods, day.kids.main);
  fillOptions($('#selKidsSide'), foods, day.kids.side);
  fillOptions($('#selParMain'),  foods, day.parents.main);
  fillOptions($('#selParSide'),  foods, day.parents.side);
  fillOptions($('#selDessert'),  desserts, day.dessert);

  buildRecipeLinks('kids', day.kids.main);
  buildRecipeLinks('par',  day.parents.main);

  $('#groPreview').textContent = groceryText();
}
function buildRecipeLinks(kind, label){
  const wrap = kind==='kids' ? $('#kidsLinks') : $('#parLinks');
  const title = kind==='kids' ? $('#kidsRecTitle') : $('#parRecTitle');
  wrap.innerHTML='';
  const q = (label||'').replace(/^[^\w]+/,'').trim();
  title.textContent = (q? `${q} recipes` : (kind==='kids'?'Kids recipes':'Parents recipes'));
  const disabled = !q;

  const links = [
    ['Allrecipes', q?`https://www.allrecipes.com/search?q=${encodeURIComponent(q)}`:'#'],
    ['YouTube', q?`https://www.youtube.com/results?search_query=${encodeURIComponent(q+' recipe')}`:'#'],
    ['Your Recipes', '#your']
  ];
  links.forEach(([lbl,href])=>{
    const a=document.createElement('a');
    a.className='a-btn';
    a.textContent=lbl;
    if(lbl==='Your Recipes'){
      if(disabled){ a.style.opacity='.4'; a.setAttribute('aria-disabled','true'); a.onclick=(e)=>e.preventDefault(); }
      else { a.href='#'; a.onclick=(e)=>{ e.preventDefault(); openYourRecipes(label); }; }
    } else {
      a.href=href; a.target='_blank'; a.rel='noopener';
      if(disabled){ a.setAttribute('aria-disabled','true'); a.style.opacity='.4'; a.onclick=(e)=>e.preventDefault(); }
    }
    wrap.appendChild(a);
  });
}

/* ---------- Save wires ---------- */
function syncAndSave(){
  const mISO=mondayISO();
  const plan=loadWeekPlan(mISO);
  const d=plan.days[dayKey()];
  d.kids.main    = $('#selKidsMain').value;
  d.kids.side    = $('#selKidsSide').value;
  d.parents.main = $('#selParMain').value;
  d.parents.side = $('#selParSide').value;
  d.dessert      = $('#selDessert').value || '';
  saveWeekPlan(mISO, plan);
  render();
}
['selKidsMain','selKidsSide','selParMain','selParSide','selDessert'].forEach(id=>{
  document.getElementById(id).onchange = syncAndSave;
});

/* ---------- Notes / Ratings / Your Recipes ---------- */
// (unchanged from your version; omitted for brevity in this comment – kept in file)
</script>

<script>
/* Notes, Ratings, Your Recipes, Groceries, Templates, Share, and Boot
   — kept exactly as in your original. (Everything below here is the same
   as what you pasted, except the hamburger wiring uses #btnMenu/#menuDD.) */

/* ---- Notes (per day) ---- */
function getNotes(){ return load(LS.notes, {}); }
function setNotes(map){ save(LS.notes, map); }
function openDayNotes(){
  const mISO=mondayISO(); const plan=loadWeekPlan(mISO); const x=plan.days[dayKey()];
  const items=[x.kids.main,x.kids.side,x.parents.main,x.parents.side,x.dessert].filter(Boolean);
  const body=$('#dayNotesBody'); body.innerHTML = items.length? '' : '<div style="opacity:.7">No items selected for this day.</div>';
  const n=getNotes();
  items.forEach(label=>{
    const has = !!(n[label] && (n[label].global||'').trim());
    const row=document.createElement('div'); row.className='item';
    row.innerHTML=`<div>${escapeHtml(label)} ${has?'<span class="badge" style="margin-left:6px">has notes</span>':''}</div><button class="btn">Edit</button>`;
    row.querySelector('button').onclick=()=>openNotesEditor(label, openDayNotes);
    body.appendChild(row);
  });
  show($('#dayNotesModal'));
}
document.getElementById('btnNotes').onclick = openDayNotes;
document.getElementById('dayNotesClose').onclick = ()=> hide(document.getElementById('dayNotesModal'));
document.getElementById('dayNotesDone').onclick  = ()=> hide(document.getElementById('dayNotesModal'));
let _editingLabel='';
function openNotesEditor(label, onSaved){
  _editingLabel=label;
  const cur = (getNotes()[label]?.global)||'';
  const next = prompt('Notes for: '+label, cur||'');
  if (next===null) return;
  const map=getNotes();
  const v=(next||'').trim();
  if(!v) delete map[label]; else map[label]={global:v};
  setNotes(map);
  if(onSaved) onSaved();
}

/* ---- Ratings ---- */
function openRatings(){
  const mISO=mondayISO(); const plan=loadWeekPlan(mISO); const x=plan.days[dayKey()];
  const kids = (window.Family?.getActiveKids?.() || []);
  const body = $('#rateBody'); body.innerHTML='';
  if (!kids.length){
    const warn=document.createElement('div'); warn.textContent='No kids added yet. Add kids in Admin.'; body.appendChild(warn);
  }
  kids.forEach(k=>{
    const row=document.createElement('div'); row.className='kidrow'; row.dataset.id=k.id;
    const existing = x.ratings?.[k.id] || {stars:0, note:''};
    row.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <span class="face">${k.photo?`<img src="${k.photo}" alt="">`:(k.name||'?').trim().charAt(0).toUpperCase()}</span>
        <div style="font-weight:800">${escapeHtml(k.name||'Kid')}</div>
      </div>
      <div class="starsel" data-kid="${k.id}">
        <span data-v="1">★</span><span data-v="2">★</span><span data-v="3">★</span><span data-v="4">★</span><span data-v="5">★</span>
      </div>
      <input type="text" placeholder="optional note" value="${escapeHtml(existing.note||'')}" data-type="note" data-kid="${k.id}" style="flex:1; padding:8px 10px; border-radius:10px; border:1px solid var(--chipBorder); background:var(--chipBg); color:var(--text);" />
    `;
    body.appendChild(row);
    const starsel = row.querySelector('.starsel');
    const setStars = (n)=>{ starsel.querySelectorAll('span').forEach(s=>s.classList.toggle('on', Number(s.dataset.v)<=n)); starsel.dataset.val=n; };
    setStars(existing.stars||0);
    starsel.querySelectorAll('span').forEach(s=> s.addEventListener('click', ()=> setStars(Number(s.dataset.v)) ));
  });
  show($('#rateModal'));
}
document.getElementById('btnRatings').onclick = openRatings;
document.getElementById('rateClose').onclick = ()=> hide($('#rateModal'));
document.getElementById('rateSave').onclick = ()=>{
  const mISO=mondayISO(); const plan=loadWeekPlan(mISO); const x=plan.days[dayKey()];
  const ratings={};
  $$('.starsel').forEach(sel=>{
    const id = sel.dataset.kid;
    const stars = Number(sel.dataset.val||0);
    const note = ($(`input[data-type="note"][data-kid="${id}"]`)?.value || '').trim();
    if (stars>0 || note) ratings[id] = { stars, note };
  });
  x.ratings = ratings;
  saveWeekPlan(mondayISO(), plan);
  hide($('#rateModal'));
};

/* ---- Your Recipes ---- */
let _yourRecFor = '';
function recKey(label){ return LS.myrec + cleanLabel(label); }
function openYourRecipes(label){
  _yourRecFor = label || '';
  const title = ($('#yourRecTitle')||{}); if(title) title.textContent = 'Your Recipes — ' + (label||'Item');
  const list = load(recKey(label), []);
  const wrap = $('#yourRecList'); wrap.innerHTML='';
  if(!list.length){
    const empty=document.createElement('div'); empty.className='item'; empty.innerHTML='<div>No saved recipes yet.</div>';
    wrap.appendChild(empty);
  } else {
    list.slice(0,5).forEach((r,idx)=>{
      const row=document.createElement('div'); row.className='item';
      const safeTitle = escapeHtml(r.title||'Recipe');
      const safeUrl = escapeHtml(r.url||'#');
      row.innerHTML = `<div><a href="${safeUrl}" target="_blank" rel="noopener">${safeTitle}</a></div><button class="btn" data-del>Delete</button>`;
      row.querySelector('[data-del]').onclick = ()=>{
        const arr = load(recKey(label), []);
        arr.splice(idx,1);
        save(recKey(label), arr);
        openYourRecipes(label);
      };
      wrap.appendChild(row);
    });
  }
  show($('#yourRecModal'));
}
document.getElementById('yourRecAdd').onclick = ()=>{
  const label = _yourRecFor; if(!label) return;
  const title = ($('#yourRecTitleInput').value||'').trim();
  const url = ($('#yourRecUrlInput').value||'').trim();
  if(!title || !url){ alert('Enter a title and a URL.'); return; }
  if(!/^https?:\/\/?/i.test(url)){ alert('URL should start with http:// or https://'); return; }
  const key = recKey(label);
  const arr = load(key, []); if(arr.length >= 5){ alert('You can save up to 5 recipes for this item.'); return; }
  arr.push({title, url});
  save(key, arr);
  $('#yourRecTitleInput').value=''; $('#yourRecUrlInput').value='';
  openYourRecipes(label);
};
document.getElementById('yourRecClose').onclick = ()=> hide($('#yourRecModal'));
document.getElementById('yourRecDone').onclick = ()=> hide($('#yourRecModal'));

/* ---- Groceries / share ---- */
const groModal=$('#groModal'); document.getElementById('groClose').onclick=()=>hide(groModal);
function openGroceries(){
  const pre=document.createElement('pre');pre.style.whiteSpace='pre-wrap';pre.style.margin='0';pre.textContent=groceryText();
  const body=$('#groBody'); body.innerHTML=''; body.appendChild(pre); show(groModal);
}
document.getElementById('groCopy').onclick=()=>navigator.clipboard.writeText(groceryText()).then(()=>alert('Grocery list copied.'));
document.getElementById('groDownload').onclick=()=>{const blob=new Blob([groceryText()],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`Fambam-Groceries-${mondayISO()}.txt`;a.click();URL.revokeObjectURL(a.href);};
document.getElementById('openGroModal').onclick = openGroceries;
document.getElementById('groCopyInline').onclick = ()=>navigator.clipboard.writeText(groceryText()).then(()=>alert('Copied.'));
document.getElementById('groDownloadInline').onclick = ()=>{const blob=new Blob([groceryText()],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`Fambam-Groceries-${mondayISO()}.txt`;a.click();URL.revokeObjectURL(a.href);};

function groceryText(){
  const plan=loadWeekPlan(mondayISO());
  const pantry=new Set(load(LS.pantry,[]).map(s=>s.toLowerCase()));
  const buckets={"Kids mains":{}, "Kids sides":{}, "Parents mains":{}, "Parents sides":{}, "Desserts":{}};
  const bump=(b,name)=>{if(!name)return;const clean=name.replace(/^[^\w]+/,'').trim();if(!clean)return;if(pantry.has(clean.toLowerCase()))return;buckets[b][clean]=(buckets[b][clean]||0)+1;};
  DAYS.forEach(d=>{const x=plan.days[d]||emptyDay();bump("Kids mains",x.kids.main);bump("Kids sides",x.kids.side);bump("Parents mains",x.parents.main);bump("Parents sides",x.parents.side);bump("Desserts",x.dessert);});
  const lines=[];
  for(const [section,items] of Object.entries(buckets)){
    const names=Object.keys(items).sort((a,b)=>a.localeCompare(b));
    if(!names.length)continue;
    lines.push(`${section}`);
    names.forEach(n=>lines.push(`- ${n}${items[n]>1 ? ` ×${items[n]}` : ''}`));
  }
  if(!lines.length) return 'No grocery items yet.';
  return lines.join('\n');
}
function planSummaryText(){
  const plan=loadWeekPlan(mondayISO());
  const lines=[`🍽️ Fambam Dinner Plan — ${$('#weekLabel').textContent}`];
  DAYS.forEach(d=>{
    const x=plan.days[d];
    const kids=[x.kids.main,x.kids.side].filter(Boolean).join(' + ');
    const pars=[x.parents.main,x.parents.side].filter(Boolean).join(' + ');
    const des=x.dessert?` • Dessert: ${x.dessert}`:'';
    lines.push(`${d}: Kids ${kids||'—'} | Parents ${pars||'—'}${des}`)
  });
  return lines.join('\n');
}
async function shareText(content){
  try{ if(navigator.share){ await navigator.share({text:content}); return; } }catch{}
  const encoded=encodeURIComponent(content);
  const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
  const href=isIOS?`sms:&body=${encoded}`:`sms:?body=${encoded}`;
  try{ location.href=href; return; }catch{}
  try{ await navigator.clipboard.writeText(content); alert('Copied to clipboard.'); }
  catch{ alert('Share unavailable. Copy/paste this:\n\n'+content); }
}

/* ---- Header menu using shared classes ---- */
(function menu(){
  const btn = document.getElementById('btnMenu');
  const dd  = document.getElementById('menuDD');
  const open = ()=>{ dd.classList.add('open'); btn.setAttribute('aria-expanded','true'); dd.setAttribute('aria-hidden','false'); };
  const close= ()=>{ dd.classList.remove('open'); btn.setAttribute('aria-expanded','false'); dd.setAttribute('aria-hidden','true'); };

  btn.addEventListener('click', (e)=>{ e.stopPropagation(); dd.classList.contains('open')?close():open(); });
  document.addEventListener('click', (e)=>{ if (!dd.contains(e.target) && e.target!==btn) close(); });

  dd.addEventListener('click', (e)=>{
    const a = e.target.closest('.mi'); if(!a) return;
    close();
    const act = a.dataset.action;
    if (act==='templates') openTemplates();
    else if (act==='groceries') openGroceries();
    else if (act==='shareGro') shareText(groceryText());
    else if (act==='sharePlan') shareText(planSummaryText());
    else if (act==='manage') openManage();
    else if (act==='reset'){
      if(confirm('Clear all entries for this week?')){
        const plan={days:{}};DAYS.forEach(d=>plan.days[d]=emptyDay()); save(LS.week(mondayISO()),plan); render();
      }
    }
  });
})();

/* ---- Boot ---- */
seedFoodsIfNeeded();
render();
addEventListener('pageshow', render);
addEventListener('storage', e=>{
  if (!e.key) return;
  if (e.key.startsWith('dp:plan:') || e.key === 'dp:foods:list' || e.key === 'dp:desserts:list' || e.key === 'dp:pantry') {
    render();
  }
});
if('serviceWorker' in navigator) addEventListener('load', ()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
</script>
</body>
</html>