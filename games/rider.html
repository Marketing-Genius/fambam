<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
<title>Fambam ‚Äî Rider</title>
<style>
  :root{
    --bg:#070b12;
    --road:#0f172a;
    --stripe:#3a4a6b;
    --glow:#22d3ee;
    --text:#e5e7eb;
    --panel:#0b1220cc;
    --panelBorder:#243244;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; overscroll-behavior:none;}
  /* Canvas sits at z=0 so overlays can sit above without issues */
  canvas{position:fixed;inset:0;display:block;touch-action:none; z-index:0}
  .hud{
    position:fixed; left:12px; right:12px; top:12px; z-index:20;
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    background:var(--panel); border:1px solid var(--panelBorder);
    padding:8px 10px; border-radius:12px; backdrop-filter:blur(6px);
  }
  .hud .grow{flex:1}
  .btn{
    appearance:none; font:inherit; color:var(--text);
    background:#1f2937; border:1px solid #334155;
    border-radius:10px; padding:8px 12px; cursor:pointer; user-select:none;
  }
  .score{font-weight:800; letter-spacing:.3px}
  .back{
    position:fixed; left:12px; bottom:12px; z-index:20;
    background:var(--panel); border:1px solid var(--panelBorder);
    padding:8px 12px; border-radius:10px; text-decoration:none; color:var(--text)
  }
  /* Full-screen overlay sits above everything and is explicitly click-through OFF */
  .overlay{
    position:fixed; inset:0; display:grid; place-items:center; z-index:30;
    padding:24px; pointer-events:auto;
  }
  .card{
    width:min(520px, 100%); background:var(--panel);
    border:1px solid var(--panelBorder); border-radius:16px;
    padding:18px; display:grid; gap:14px; text-align:center;
  }
  .title{font-weight:900; font-size:1.25rem}
  .muted{opacity:.85}
  .hidden{display:none!important}
</style>
</head>
<body>
  <div class="hud" id="hud">
    <div class="score" id="score">00.0 s</div>
    <div class="grow"></div>
    <button class="btn" id="btnPause" type="button">‚è∏Ô∏è Pause</button>
    <button class="btn" id="btnReset" type="button">‚Ü∫ Reset</button>
  </div>

  <a class="back" href="../games.html">‚Üê Games</a>
  <canvas id="view"></canvas>

  <div class="overlay" id="overlay" aria-modal="true" role="dialog">
    <div class="card" id="startCard">
      <div class="title">üèçÔ∏è Rider</div>
      <div class="muted">Drag up/down to steer. Dodge traffic. You‚Äôre blazing past the flow.</div>
      <div id="best" class="muted"></div>
      <button class="btn" id="btnStart" type="button" style="font-weight:800">Start</button>
    </div>
  </div>

<script>
/* Stop Safari pinch gestures from hijacking the app */
['gesturestart','gesturechange','gestureend'].forEach(evt=>{
  window.addEventListener(evt, e=>e.preventDefault(), {passive:false});
});

(function(){
  const cvs = document.getElementById('view');
  const ctx = cvs.getContext('2d');
  let W=innerWidth, H=innerHeight, DPR=window.devicePixelRatio||1;

  function resize(){
    W = innerWidth; H = innerHeight; DPR = devicePixelRatio||1;
    cvs.width  = Math.round(W*DPR);
    cvs.height = Math.round(H*DPR);
    cvs.style.width  = W+'px';
    cvs.style.height = H+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    layoutRoad();
  }
  addEventListener('resize', resize);
  resize();

  // ---------------- Road (horizontal lanes, scroll left) --------------------
  const road = { lanes:5, centers:[], top:0, bottom:0, h:0, stripeScroll:0 };
  function layoutRoad(){
    const shoulder = Math.max(48, Math.min(120, H*0.08));
    road.top     = shoulder;
    road.bottom  = H - shoulder;
    road.h       = road.bottom - road.top;
    road.centers = [];
    for (let i=0;i<road.lanes;i++){
      const t = (i+0.5)/road.lanes;
      road.centers.push(road.top + t*road.h);
    }
  }

  // ---------------- Bike (top-down, facing ‚Üí) --------------------------------
  const bike = { x:0,y:0,w:80,h:36, vx:0,vy:0, targetY:0, k:10.5, c:8.2, trail:[] };
  function resetBike(){
    bike.x = 120;
    bike.y = road.centers[Math.floor(road.lanes/2)] || H*0.5;
    bike.vx = 0; bike.vy = 0; bike.targetY = bike.y; bike.trail.length=0;
  }

  // ---------------- Traffic (moves left) -------------------------------------
  const cars = [];
  const types = [
    {w:90,  h:46, color:'#60a5fa', glow:'#93c5fd'},
    {w:120, h:52, color:'#34d399', glow:'#6ee7b7'},
    {w:150, h:58, color:'#fbbf24', glow:'#fde68a'},
    {w:200, h:62, color:'#f87171', glow:'#fecaca'},
    {w:260, h:68, color:'#a78bfa', glow:'#ddd6fe'}
  ];
  let vMin=140, vMax=360;

  function spawnCar(){
    const t = types[(Math.random()*types.length)|0];
    const lane = road.centers[(Math.random()*road.centers.length)|0] || H*0.5;
    const y = lane - t.h/2 + (Math.random()*10-5);
    const s = vMin + Math.random()*(vMax - vMin);
    cars.push({ x: W + 60 + Math.random()*120, y, w:t.w, h:t.h, speed:s, color:t.color, glow:t.glow });
  }
  function resetCars(){ cars.length=0; for (let i=0;i<7;i++) spawnCar(); }

  // ---------------- Game state / score ---------------------------------------
  let running=false, paused=false, dead=false;
  let timeAlive=0, best=Number(localStorage.getItem('rider:best')||0);

  function resetGame(){
    timeAlive=0; running=false; paused=false; dead=false;
    resetBike(); resetCars();
    updateScore(0); showOverlay(true, 'üèçÔ∏è Rider', 'Drag up/down to steer. Dodge traffic. You‚Äôre blazing past the flow.');
  }
  function updateScore(t){ document.getElementById('score').textContent = `${t.toFixed(1)} s`; }
  function showOverlay(on, title, msg){
    const ov=document.getElementById('overlay');
    ov.classList.toggle('hidden', !on);
    if (on){
      document.getElementById('best').textContent = best ? `Best: ${best.toFixed(1)} s` : '';
      const card=document.getElementById('startCard');
      card.querySelector('.title').textContent = title;
      card.querySelector('.muted').textContent = msg;
    }
  }

  // ---------------- Input / Buttons -----------------------------------------
  // Steering target (drag anywhere on canvas)
  cvs.addEventListener('pointerdown', e=>{ bike.targetY = e.clientY; });
  cvs.addEventListener('pointermove', e=>{ bike.targetY = e.clientY; });

  // Start handlers ‚Äî multiple ways so iPad never misses it
  function startGame(){
    showOverlay(false);
    running=true; paused=false; dead=false;
    document.getElementById('btnPause').textContent = '‚è∏Ô∏è Pause';
  }
  const btnStart = document.getElementById('btnStart');
  const overlay  = document.getElementById('overlay');
  const startCard= document.getElementById('startCard');

  // Click + pointerdown on button
  ['click','pointerdown'].forEach(evt=>{
    btnStart.addEventListener(evt, (e)=>{ e.preventDefault(); e.stopPropagation(); startGame(); }, {passive:false});
  });
  // Tap anywhere on the overlay/card to start (backup)
  ;['click','pointerdown'].forEach(evt=>{
    overlay.addEventListener(evt, (e)=>{
      if (overlay.classList.contains('hidden')) return;
      e.preventDefault(); startGame();
    }, {passive:false});
    startCard.addEventListener(evt, (e)=>{
      if (overlay.classList.contains('hidden')) return;
      e.preventDefault(); e.stopPropagation(); startGame();
    }, {passive:false});
  });
  // Absolute fallback: first tap on canvas when overlay is up
  cvs.addEventListener('pointerdown', ()=>{
    if (!running && !dead && !overlay.classList.contains('hidden')) startGame();
  });

  // Pause / Reset
  document.getElementById('btnPause').onclick = ()=>{
    if (!running) return;
    paused = !paused;
    document.getElementById('btnPause').textContent = paused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
  };
  document.getElementById('btnReset').onclick = resetGame;

  // ---------------- Physics ---------------------------------------------------
  function clamp(v,a,b){ return v<a?a:(v>b?b:v); }
  function step(dt){
    const ty = clamp(bike.targetY, road.top+12, road.bottom-12);
    const ay = bike.k * (ty - bike.y) - bike.c * bike.vy;
    bike.vy += ay * dt;
    bike.y  += bike.vy * dt;

    bike.trail.push({x:bike.x-16, y:bike.y});
    if (bike.trail.length>90) bike.trail.shift();

    if (cars.length<12 && Math.random() < 0.9*dt) spawnCar();
    for (let i=cars.length-1;i>=0;i--){
      const c=cars[i];
      c.x -= c.speed * dt;
      if (c.x + c.w < -80) cars.splice(i,1);
    }

    const bx = bike.x+6, by = bike.y - (bike.h*0.5) + 4, bw = bike.w-18, bh = bike.h-8;
    for (const c of cars){
      if (bx < c.x+c.w && bx+bw > c.x && by < c.y+c.h && by+bh > c.y){
        dead=true; running=false; break;
      }
    }

    timeAlive += dt;
    updateScore(timeAlive);
    road.stripeScroll = (road.stripeScroll + 420*dt) % 60;
  }

  // ---------------- Rendering -------------------------------------------------
  function draw(){
    ctx.fillStyle = getCss('--road','#0f172a');
    ctx.fillRect(0,0,W,H);

    // lane stripes (horizontal, scrolling left)
    const dash = 34, gap = 26, phase = road.stripeScroll;
    ctx.fillStyle = getCss('--stripe','#3a4a6b');
    for (const cy of road.centers){
      const y = cy-2; let x = -phase;
      while (x < W){ ctx.fillRect(x, y, dash, 4); x += dash + gap; }
    }

    for (const c of cars) drawCar(c);
    drawBike();
  }

  function drawCar(c){
    ctx.fillStyle='rgba(0,0,0,.35)';
    roundRect(c.x, c.y + c.h*0.25, c.w, c.h*0.85, 12, true, false);
    const g = ctx.createLinearGradient(c.x, c.y, c.x+c.w, c.y);
    g.addColorStop(0, shade(c.color, .08)); g.addColorStop(1, shade(c.color,-.08));
    ctx.fillStyle = g; roundRect(c.x, c.y, c.w, c.h, 10, true, false);
    ctx.fillStyle='rgba(255,255,255,.18)'; roundRect(c.x+10, c.y+8, c.w-20, c.h-16, 8, true, false);
    ctx.globalAlpha=.25; ctx.strokeStyle=c.glow; ctx.lineWidth=3;
    roundRect(c.x+1.5, c.y+1.5, c.w-3, c.h-3, 9, false, true); ctx.globalAlpha=1;
  }
  function drawBike(){
    for (let i=0;i<bike.trail.length;i++){
      const p = bike.trail[i], t = i/bike.trail.length;
      ctx.globalAlpha = 0.10 * t;
      ctx.fillStyle = '#fff';
      ctx.beginPath(); ctx.ellipse(p.x, p.y, 22*(1-t), 9*(1-t), 0, 0, Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;
    const x=bike.x, y=bike.y-bike.h/2, w=bike.w, h=bike.h;
    ctx.fillStyle='rgba(0,0,0,.35)'; roundRect(x+2, y+6, w, h, 14, true, false);
    const g = ctx.createLinearGradient(x, y, x+w, y);
    g.addColorStop(0, '#1f2937'); g.addColorStop(1, '#374151');
    ctx.fillStyle=g; roundRect(x, y, w, h, 14, true, false);
    ctx.fillStyle=getCss('--glow','#22d3ee'); ctx.globalAlpha=.9;
    roundRect(x+10, y+h/2-3, w-28, 6, 3, true, false); ctx.globalAlpha=1;
    ctx.fillStyle='#cbd5e1'; roundRect(x+w-16, y+6, 10, h-12, 4, true, false);
  }

  function roundRect(x,y,w,h,r,fill,stroke){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.lineTo(x+w-rr,y); ctx.quadraticCurveTo(x+w,y,x+w,y+rr);
    ctx.lineTo(x+w,y+h-rr); ctx.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);
    ctx.lineTo(x+rr,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-rr);
    ctx.lineTo(x,y+rr); ctx.quadraticCurveTo(x,y,x+rr,y);
    if (fill) ctx.fill(); if (stroke) ctx.stroke();
  }
  function shade(hex, amt){
    const c=parseInt(hex.slice(1),16);
    let r=(c>>16)&255, g=(c>>8)&255, b=c&255;
    r=Math.max(0,Math.min(255,r+255*amt));
    g=Math.max(0,Math.min(255,g+255*amt));
    b=Math.max(0,Math.min(255,b+255*amt));
    return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
  }
  function getCss(name, fallback){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || fallback; }

  // ---------------- Loop ------------------------------------------------------
  let last=0; function frame(t){
    requestAnimationFrame(frame);
    const dt=Math.min(0.033, (t-last)/1000 || 0.016); last=t;
    if (running && !paused && !dead) step(dt);
    draw();
    if (dead){
      if (timeAlive>best){ best=timeAlive; localStorage.setItem('rider:best', String(best)); }
      showOverlay(true, 'üí• Crash!', `You lasted ${timeAlive.toFixed(1)} s. Tap Start to try again.`);
    }
  }

  // Boot
  resetGame();
  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
