<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
<title>Fambam ‚Äî Rider</title>
<style>
  :root{
    --bg:#070b12;
    --road:#0f172a;
    --edge:#0b1220;
    --stripe:#3a4a6b;
    --glow:#22d3ee;
    --text:#e5e7eb;
    --panel:#0b1220cc;
    --panelBorder:#243244;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    overscroll-behavior:none;}
  canvas{position:fixed;inset:0;display:block;touch-action:none}
  .hud{
    position:fixed; left:12px; right:12px; top:12px; z-index:10;
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    background:var(--panel); border:1px solid var(--panelBorder);
    padding:8px 10px; border-radius:12px; backdrop-filter:blur(6px);
  }
  .hud .grow{flex:1}
  .btn{
    appearance:none; font:inherit; color:var(--text);
    background:#1f2937; border:1px solid #334155;
    border-radius:10px; padding:8px 12px; cursor:pointer; user-select:none;
  }
  .score{font-weight:800; letter-spacing:.3px}
  .back{
    position:fixed; left:12px; bottom:12px; z-index:10;
    background:var(--panel); border:1px solid var(--panelBorder);
    padding:8px 12px; border-radius:10px; text-decoration:none; color:var(--text)
  }
  .overlay{
    position:fixed; inset:0; display:grid; place-items:center; z-index:20;
    padding:24px;
  }
  .card{
    width:min(520px, 100%); background:var(--panel);
    border:1px solid var(--panelBorder); border-radius:16px;
    padding:18px; display:grid; gap:14px; text-align:center;
  }
  .title{font-weight:900; font-size:1.25rem}
  .muted{opacity:.8}
  .hidden{display:none!important}
</style>
</head>
<body>
  <div class="hud" id="hud">
    <div class="score" id="score">00.0 s</div>
    <div class="grow"></div>
    <button class="btn" id="btnPause">‚è∏Ô∏è Pause</button>
    <button class="btn" id="btnReset">‚Ü∫ Reset</button>
  </div>

  <a class="back" href="../games.html">‚Üê Games</a>
  <canvas id="view"></canvas>

  <div class="overlay" id="overlay">
    <div class="card">
      <div class="title">üèçÔ∏è Rider</div>
      <div class="muted">Drag up/down to steer. Dodge traffic. You‚Äôre blazing past the flow.</div>
      <div id="best" class="muted"></div>
      <button class="btn" id="btnStart" style="font-weight:800">Start</button>
    </div>
  </div>

<script>
/* Block Safari‚Äôs pinch gestures from stealing focus while playing */
['gesturestart','gesturechange','gestureend'].forEach(evt=>{
  window.addEventListener(evt, e=>e.preventDefault(), {passive:false});
});

(function(){
  const cvs = document.getElementById('view');
  const ctx = cvs.getContext('2d');
  let W=innerWidth, H=innerHeight, DPR=window.devicePixelRatio||1;

  function resize(){
    W = innerWidth; H = innerHeight; DPR = devicePixelRatio||1;
    cvs.width  = Math.round(W*DPR);
    cvs.height = Math.round(H*DPR);
    cvs.style.width  = W+'px';
    cvs.style.height = H+'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
    layoutRoad();
  }
  addEventListener('resize', resize);
  resize();

  // ---------------- Road / Lanes (horizontal lanes; scroll left) -------------
  const road = { x:0, y:0, w:0, h:0, top:0, bottom:0, marginY:0, lanes:5, centers:[], stripeScroll:0 };
  function layoutRoad(){
    road.marginY = Math.max(48, Math.min(120, H*0.08)); // shoulders
    road.top     = road.marginY;
    road.bottom  = H - road.marginY;
    road.h       = road.bottom - road.top;
    road.w       = W;
    road.centers = [];
    for (let i=0;i<road.lanes;i++){
      const t = (i+0.5)/road.lanes;
      road.centers.push(road.top + t*road.h);
    }
  }

  // ---------------- Bike (top-down, facing right) ----------------------------
  const bike = {
    x: 0, y: 0, w: 80, h: 36,
    vx: 0, vy: 0,
    targetY: 0,
    k: 10.5,   // spring stiffness to target
    c: 8.2,    // damping
    trail: []
  };
  function resetBike(){
    bike.x = 120;
    bike.y = road.centers[Math.floor(road.lanes/2)] || H*0.5;
    bike.vx = 0; bike.vy = 0; bike.targetY = bike.y; bike.trail.length=0;
  }

  // ---------------- Traffic (moving left) ------------------------------------
  const cars = [];
  const carTypes = [
    {w:90,  h:46, color:'#60a5fa', glow:'#93c5fd'},  // car
    {w:120, h:52, color:'#34d399', glow:'#6ee7b7'},  // sedan
    {w:150, h:58, color:'#fbbf24', glow:'#fde68a'},  // van
    {w:200, h:62, color:'#f87171', glow:'#fecaca'},  // truck
    {w:260, h:68, color:'#a78bfa', glow:'#ddd6fe'}   // semi
  ];
  let trafficMin = 140, trafficMax = 360; // px/s

  function spawnCar(){
    const t = carTypes[(Math.random()*carTypes.length)|0];
    // choose a lane center with a small random offset (so it feels ‚Äúalive‚Äù)
    const lane = road.centers[(Math.random()*road.centers.length)|0] || H*0.5;
    const y = lane - t.h/2 + (Math.random()*10-5);
    const s = trafficMin + Math.random()*(trafficMax - trafficMin);
    cars.push({ x: W + 60 + Math.random()*120, y, w:t.w, h:t.h, speed:s, color:t.color, glow:t.glow });
  }
  function resetCars(){
    cars.length = 0;
    for (let i=0;i<7;i++) spawnCar();
  }

  // ---------------- Game state / score ---------------------------------------
  let running=false, paused=false, dead=false;
  let timeAlive=0, best=Number(localStorage.getItem('rider:best')||0);

  function resetGame(){
    timeAlive=0; running=false; paused=false; dead=false;
    resetBike(); resetCars();
    updateScore(0); showOverlay(true);
  }
  function updateScore(t){ document.getElementById('score').textContent = `${t.toFixed(1)} s`; }
  function showOverlay(on){
    const bestEl=document.getElementById('best');
    bestEl.textContent = best ? `Best: ${best.toFixed(1)} s` : '';
    document.getElementById('overlay').classList.toggle('hidden', !on);
  }

  // ---------------- Input (drag up/down) -------------------------------------
  cvs.addEventListener('pointerdown', e=>{
    cvs.setPointerCapture(e.pointerId);
    bike.targetY = e.clientY;
  });
  cvs.addEventListener('pointermove', e=>{
    bike.targetY = e.clientY;
  });

  // Buttons
  document.getElementById('btnPause').onclick = ()=>{
    if (!running) return;
    paused = !paused;
    document.getElementById('btnPause').textContent = paused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
  };
  document.getElementById('btnReset').onclick = resetGame;
  document.getElementById('btnStart').onclick = ()=>{
    showOverlay(false);
    running=true; paused=false; dead=false;
    document.getElementById('btnPause').textContent = '‚è∏Ô∏è Pause';
  };

  // ---------------- Physics ---------------------------------------------------
  function clamp(v,a,b){ return v<a?a:(v>b?b:v); }

  function step(dt){
    // Bike spring to target (lag/overcorrect)
    const ty = clamp(bike.targetY, road.top+12, road.bottom-12);
    const ay = bike.k * (ty - bike.y) - bike.c * bike.vy;
    bike.vy += ay * dt;
    bike.y  += bike.vy * dt;

    // Trail (for motion streak)
    bike.trail.push({x:bike.x-16, y:bike.y});
    if (bike.trail.length>90) bike.trail.shift();

    // Traffic updates
    if (cars.length<12 && Math.random() < 0.9*dt) spawnCar();
    for (let i=cars.length-1;i>=0;i--){
      const c=cars[i];
      c.x -= c.speed * dt;
      if (c.x + c.w < -80) cars.splice(i,1);
    }

    // Collisions (AABB, slightly tightened bike hitbox)
    const bx = bike.x+6, by = bike.y - (bike.h*0.5) + 4, bw = bike.w-18, bh = bike.h-8;
    for (const c of cars){
      if (bx < c.x+c.w && bx+bw > c.x && by < c.y+c.h && by+bh > c.y){
        dead=true; running=false; break;
      }
    }

    // Score
    timeAlive += dt;
    updateScore(timeAlive);

    // Leftward ‚Äúroad stripes‚Äù scroll
    road.stripeScroll = (road.stripeScroll + 420*dt) % 60; // 60px dash cycle
  }

  // ---------------- Rendering -------------------------------------------------
  function draw(){
    // road base
    ctx.fillStyle = getCss('--road','#0f172a');
    ctx.fillRect(0,0,W,H);

    // side glows
    const gy1 = ctx.createLinearGradient(0, road.top, 0, 0);
    gy1.addColorStop(0,'rgba(34,211,238,0.10)');
    gy1.addColorStop(1,'rgba(34,211,238,0.00)');
    ctx.fillStyle=gy1; ctx.fillRect(0,0,W,road.top);

    const gy2 = ctx.createLinearGradient(0, H-road.top, 0, H);
    gy2.addColorStop(0,'rgba(34,211,238,0.10)');
    gy2.addColorStop(1,'rgba(34,211,238,0.00)');
    ctx.fillStyle=gy2; ctx.fillRect(0,H-road.top,W,road.top);

    // horizontal dashed stripes per lane center; scroll LEFT
    const dash = 34, gap = 26;
    const phase = road.stripeScroll;
    ctx.fillStyle = getCss('--stripe','#3a4a6b');

    for (let i=0;i<road.centers.length;i++){
      const y = road.centers[i]-2;
      // draw a row of dashes across width with leftward offset
      let x = -phase;
      while (x < W){
        ctx.fillRect(x, y, dash, 4);
        x += dash + gap;
      }
    }

    // cars
    for (let i=0;i<cars.length;i++) drawCar(cars[i]);

    // bike
    drawBike();
  }

  function drawCar(c){
    // shadow
    ctx.fillStyle='rgba(0,0,0,.35)';
    roundRect(c.x, c.y + c.h*0.25, c.w, c.h*0.85, 12, true, false);

    // body
    const g = ctx.createLinearGradient(c.x, c.y, c.x+c.w, c.y);
    g.addColorStop(0, shade(c.color, .08));
    g.addColorStop(1, shade(c.color,-.08));
    ctx.fillStyle = g;
    roundRect(c.x, c.y, c.w, c.h, 10, true, false);

    // windows band
    ctx.fillStyle='rgba(255,255,255,.18)';
    roundRect(c.x+10, c.y+8, c.w-20, c.h-16, 8, true, false);

    // glow line
    ctx.globalAlpha=.25; ctx.strokeStyle=c.glow; ctx.lineWidth=3;
    roundRect(c.x+1.5, c.y+1.5, c.w-3, c.h-3, 9, false, true);
    ctx.globalAlpha=1;
  }

  function drawBike(){
    // trail
    for (let i=0;i<bike.trail.length;i++){
      const p = bike.trail[i], t = i/bike.trail.length;
      ctx.globalAlpha = 0.10 * t;
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.ellipse(p.x, p.y, 22*(1-t), 9*(1-t), 0, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha=1;

    // main body (top-down, facing ‚Üí right)
    const x = bike.x, y = bike.y - bike.h/2, w=bike.w, h=bike.h;

    // under shadow
    ctx.fillStyle='rgba(0,0,0,.35)';
    roundRect(x+2, y+6, w, h, 14, true, false);

    // chassis
    const g = ctx.createLinearGradient(x, y, x+w, y);
    g.addColorStop(0, '#1f2937');
    g.addColorStop(1, '#374151');
    ctx.fillStyle = g;
    roundRect(x, y, w, h, 14, true, false);

    // neon stripe
    ctx.fillStyle=getCss('--glow','#22d3ee');
    ctx.globalAlpha=.9;
    roundRect(x+10, y+h/2-3, w-28, 6, 3, true, false);
    ctx.globalAlpha=1;

    // front cap / ‚Äúwheel‚Äù
    ctx.fillStyle='#cbd5e1';
    roundRect(x+w-16, y+6, 10, h-12, 4, true, false);
  }

  function roundRect(x,y,w,h,r,fill,stroke){
    const rr=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.lineTo(x+w-rr,y);
    ctx.quadraticCurveTo(x+w,y,x+w,y+rr);
    ctx.lineTo(x+w,y+h-rr);
    ctx.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);
    ctx.lineTo(x+rr,y+h);
    ctx.quadraticCurveTo(x,y+h,x,y+h-rr);
    ctx.lineTo(x,y+rr);
    ctx.quadraticCurveTo(x,y,x+rr,y);
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }
  function shade(hex, amt){
    const c=parseInt(hex.slice(1),16);
    let r=(c>>16)&255, g=(c>>8)&255, b=c&255;
    r=Math.max(0,Math.min(255,r+255*amt));
    g=Math.max(0,Math.min(255,g+255*amt));
    b=Math.max(0,Math.min(255,b+255*amt));
    return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
  }
  function getCss(name, fallback){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || fallback; }

  // ---------------- Main loop -----------------------------------------------
  let last=0;
  function frame(t){
    requestAnimationFrame(frame);
    const dt=Math.min(0.033, (t-last)/1000 || 0.016);
    last=t;

    if (running && !paused && !dead) step(dt);
    draw();

    if (dead){
      if (timeAlive>best){ best=timeAlive; localStorage.setItem('rider:best', String(best)); }
      const ov=document.getElementById('overlay');
      if (ov.classList.contains('hidden')){
        // show crash overlay and text once
        ov.classList.remove('hidden');
        ov.querySelector('.title').textContent='üí• Crash!';
        ov.querySelector('.muted').textContent=`You lasted ${timeAlive.toFixed(1)} s. Tap Start to try again.`;
      }
    }
  }

  // Boot
  layoutRoad();
  resetGame();
  requestAnimationFrame(frame);
})();
</script>
</body>
</html>
