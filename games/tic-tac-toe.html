<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tic-Tac-Toe</title>
<style>
  :root{
    --bg:#0b1224; --panel:#0e162c; --border:#27324a; --text:#e5e7eb; --muted:#93a2b1; --accent:#22d3ee;
  }
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
       display:grid;grid-template-rows:auto 1fr}
  header{display:flex;align-items:center;gap:10px; padding:10px}
  header .title{font-weight:800}
  header .right{margin-left:auto}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:transparent;color:var(--text);cursor:pointer}

  .wrap{margin:0 auto; width:min(92vmin,520px); display:grid; gap:12px; padding:10px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .cell{
    aspect-ratio:1/1; font-size:42px; font-weight:800; cursor:pointer;
    background:var(--panel); color:var(--text); border:2px solid var(--border); border-radius:16px;
  }
  .bar{display:flex;justify-content:space-between;align-items:center;gap:10px}

  /* Winner modal */
  .backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:20}
  .modal{width:min(560px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;position:relative;z-index:30}
  .modal h2{margin:0 0 8px;font-size:1.2rem}
  .modal .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer}
  .btn.primary{background:var(--accent);border:none;color:#001018;font-weight:800}

  /* confetti canvas sits under modal */
  #confetti{position:fixed;inset:0;pointer-events:none;z-index:25}
</style>

<body>
  <header>
    <div class="title">Tic-Tac-Toe</div>
    <div class="right"><button id="restart" class="pill">Restart</button></div>
  </header>

  <div class="wrap">
    <div class="bar"><div id="pNames">Waiting for playersâ€¦</div><div id="status" style="color:var(--muted)"></div></div>
    <div class="grid" id="board"></div>
  </div>

  <canvas id="confetti"></canvas>
  <div class="backdrop" id="winBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-labelledby="winTitle">
      <h2 id="winTitle">Winner!</h2>
      <div id="winSub" style="color:var(--muted)"></div>
      <div class="btns">
        <button class="btn primary" id="btnRematch">Rematch</button>
        <button class="btn" id="btnChange">Change players</button>
        <button class="btn" id="btnExit">Exit game</button>
      </div>
    </div>
  </div>

<script>
/* ----- messaging helpers ----- */
const post = (m)=>parent.postMessage(m,'*');

/* ----- game state ----- */
const board = document.getElementById('board');
const namesEl = document.getElementById('pNames');
const statusEl = document.getElementById('status');
const restartBtn = document.getElementById('restart');

let players = [];            // [{id,name},{id,name}]
let cells = Array(9).fill(null);
let turn = 0;
let finished = false;

/* build board UI */
for(let i=0;i<9;i++){
  const b=document.createElement('button');
  b.className='cell';
  b.onclick=()=>play(i);
  board.appendChild(b);
}

function paintNames(){
  if(players.length<2){ namesEl.textContent='Waiting for playersâ€¦'; return; }
  const display = players.map((p,idx)=> (idx===turn%2?'ðŸ‘‰ ':'') + p.name + (idx===0?' (X)':' (O)')).join(' vs ');
  namesEl.textContent = display;
  statusEl.textContent = finished ? '' : ( (turn%2===0?players[0].name:players[1].name) + ' to move');
}
function play(i){
  if(finished || cells[i]) return;
  const mark = (turn%2===0)?'X':'O';
  cells[i]=mark; board.children[i].textContent=mark;
  if(checkWin(mark)){ endGame(players[turn%2], false); return; }
  if(cells.every(Boolean)){ endGame(null, true); return; }
  turn++; paintNames();
}
function checkWin(m){
  const W=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  return W.some(([a,b,c])=>cells[a]===m && cells[b]===m && cells[c]===m);
}

/* restart */
restartBtn.onclick = ()=> rematch();
function rematch(){
  finished=false; cells=Array(9).fill(null); turn=0;
  [...board.children].forEach(b=>b.textContent='');
  hideWin(); paintNames();
}

/* ---- winner modal + confetti ---- */
const backdrop = document.getElementById('winBackdrop');
const winTitle = document.getElementById('winTitle');
const winSub   = document.getElementById('winSub');
document.getElementById('btnRematch').onclick = rematch;
document.getElementById('btnChange').onclick = ()=> post({type:'fambam:end', reason:'change-players'});
document.getElementById('btnExit').onclick   = ()=> post({type:'fambam:end', reason:'exit'});

function showWin(title, sub){ winTitle.textContent=title; winSub.textContent=sub||''; backdrop.style.display='flex'; backdrop.setAttribute('aria-hidden','false'); confettiBurst(); }
function hideWin(){ backdrop.style.display='none'; backdrop.setAttribute('aria-hidden','true'); }

function endGame(winner, draw){
  finished=true;
  // score payload: 3 for win, 1/1 for draw
  const scores = draw
    ? players.map(p=>({id:p.id,name:p.name,points:1}))
    : [{id:winner.id,name:winner.name,points:3},{id:players.find(p=>p!==winner).id,name:players.find(p=>p!==winner).name,points:0}];
  post({type:'fambam:score', gameId:'tictactoe', scores});
  if(draw){ showWin('Draw!','That was close â€” try again.'); }
  else    { showWin(`${winner.name} wins!`,'Well played!'); }
}

/* simple confetti (lightweight) */
function confettiBurst(){
  const c=document.getElementById('confetti'), ctx=c.getContext('2d');
  const DPR=window.devicePixelRatio||1; c.width=innerWidth*DPR; c.height=innerHeight*DPR; ctx.scale(DPR,DPR);
  const N=140, parts=[];
  for(let i=0;i<N;i++){
    parts.push({
      x: Math.random()*innerWidth, y: -20-Math.random()*innerHeight*0.3,
      vx: -2+Math.random()*4, vy: 2+Math.random()*3,
      size: 6+Math.random()*6, rot: Math.random()*Math.PI, vr: (-0.2+Math.random()*0.4),
      col: `hsl(${Math.floor(Math.random()*360)},85%,60%)`, life: 0
    });
  }
  let t0=null;
  function step(ts){
    if(!t0) t0=ts; const dt=(ts-t0)/1000; t0=ts; ctx.clearRect(0,0,innerWidth,innerHeight);
    let alive=false;
    for(const p of parts){
      p.vy+= 8*dt; p.x+=p.vx*60*dt; p.y+=p.vy*60*dt; p.rot+=p.vr; p.life+=dt;
      if(p.y<innerHeight+40){ alive=true; ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
        ctx.fillStyle=p.col; ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); ctx.restore(); }
    }
    if(alive) requestAnimationFrame(step); else ctx.clearRect(0,0,innerWidth,innerHeight);
  }
  requestAnimationFrame(step);
}

/* messaging */
window.addEventListener('message', (e)=>{
  const msg=e.data||{};
  if(msg.type==='fambam:players'){
    players = (msg.players||[]).slice(0,2);
    paintNames();
  }
});
post({type:'fambam:ready', gameId:'tictactoe'});
</script>
</body>
</html>