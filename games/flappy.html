<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Flappy (demo)</title>

<style>
  :root { --bg:#081228; --hud:#e5e7eb; --panel:#0f172a; --border:#27324a; --accent:#22d3ee; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--hud);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  canvas#game{display:block;width:100%;height:100%}

  /* HUD */
  .hud{position:fixed;top:10px;left:10px;display:flex;gap:10px;align-items:center}
  .hud .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0b162c}

  /* Win/End modal */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:5}
  .modal{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;min-width:min(90vw,460px)}
  .modal header{font-weight:800;margin-bottom:8px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0b162c;color:var(--hud);cursor:pointer}
  .btn.primary{background:var(--accent);border:none;color:#001018;font-weight:800}
  .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  /* Confetti canvas sits above game */
  canvas#fx{position:fixed;inset:0;pointer-events:none;z-index:4}
</style>

<canvas id="game"></canvas>
<canvas id="fx"></canvas>

<div class="hud">
  <div class="pill" id="title">Flappy (demo)</div>
  <div class="pill" id="playerHint">Waiting for playersâ€¦</div>
  <div class="pill" id="time">Time: 0.0s</div>
</div>

<!-- Winner / finish modal -->
<div class="backdrop" id="endBack">
  <div class="modal">
    <header id="endTitle">Nice!</header>
    <div id="endMsg" style="opacity:.9;margin-bottom:6px"></div>
    <div class="row">
      <button class="btn" id="btnChange">Change players</button>
      <button class="btn" id="btnExit">Exit</button>
      <button class="btn primary" id="btnRematch">Rematch</button>
    </div>
  </div>
</div>

<script>
/* ---------- postMessage protocol helpers ---------- */
const post = (m)=>parent.postMessage(m,'*');
let PLAYER = { id:'', name:'Player' };

window.addEventListener('message',(e)=>{
  if(e.data?.type==='fambam:players'){
    const p=e.data.players?.[0];
    if(p){ PLAYER=p; document.getElementById('playerHint').textContent = 'Player: '+PLAYER.name; start(); }
  }
});
post({type:'fambam:ready', gameId:'flappy'});

/* ---------- Tiny flappy-like demo (tap to flap; score = survival time*10) ---------- */
const cvs = document.getElementById('game'), ctx = cvs.getContext('2d', {alpha:false});
let w, h, t0=0, running=false, elapsed=0;
let y, vy, gravity=900, flap=-320;  // px/s/s and px/s impulse
let ground=0;

function resize(){ w= cvs.width  = innerWidth  * devicePixelRatio;
                   h= cvs.height = innerHeight * devicePixelRatio;
                   ground = h*0.85; }
addEventListener('resize', resize, {passive:true}); resize();

function start(){
  running=true; elapsed=0; t0=performance.now();
  y = h*0.5; vy=0;
  loop(t0);
}
function end(){
  if(!running) return;
  running=false;
  const points = Math.max(0, Math.round(elapsed*10));
  // score up to parent
  post({type:'fambam:score', gameId:'flappy', scores:[{id:PLAYER.id,name:PLAYER.name,points}]});
  showEnd(points);
}

addEventListener('pointerdown', ()=>{ if(!running) return; vy = flap; });

function loop(ts){
  if(!running) return;
  const dt = Math.min(0.033, (ts - t0)/1000); t0 = ts;
  elapsed += dt;
  document.getElementById('time').textContent = 'Time: ' + elapsed.toFixed(1) + 's';

  // physics
  vy += gravity*dt; y += vy*dt;
  if(y > ground){ y=ground; vy=0; end(); return; }
  if(y < 0){ y=0; vy=0; } // ceiling

  // draw
  ctx.fillStyle = '#081228'; ctx.fillRect(0,0,w,h);
  // bird
  const bx = w*0.3, r = Math.max(18, Math.min(36, w/50));
  ctx.save(); ctx.translate(bx, y); ctx.fillStyle='#e5e7eb';
  ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(r*0.25,-r*0.2,r*0.1,0,Math.PI*2); ctx.fill(); // eye
  ctx.restore();

  // simple horizon
  ctx.fillStyle='#0b1e3e'; ctx.fillRect(0, ground+r, w, h-ground);

  requestAnimationFrame(loop);
}
// auto-end after 12s so a round always finishes
setTimeout(()=>running && end(), 12000);

/* ---------- Winner modal + confetti ---------- */
const back = document.getElementById('endBack');
const fx = document.getElementById('fx'), fxc = fx.getContext('2d');
function showEnd(points){
  document.getElementById('endTitle').textContent = 'ðŸŽ‰ ' + PLAYER.name + ' scored ' + points + '!';
  document.getElementById('endMsg').textContent = 'Great flight! Choose what to do next.';
  back.style.display='flex';
  confetti(1000); // 1 second burst
}
document.getElementById('btnRematch').onclick = ()=>{ back.style.display='none'; start(); };
document.getElementById('btnExit').onclick    = ()=>{ back.style.display='none'; post({type:'fambam:end'}); };
document.getElementById('btnChange').onclick  = ()=>{ back.style.display='none'; post({type:'fambam:end'}); };

/* simple confetti */
function confetti(ms){
  fx.width=innerWidth*devicePixelRatio; fx.height=innerHeight*devicePixelRatio;
  const N = 180, parts = [];
  for(let i=0;i<N;i++){
    parts.push({
      x: Math.random()*fx.width, y: -20 - Math.random()*fx.height*0.3,
      vx: (Math.random()-0.5)*400, vy: 300+Math.random()*600,
      s: 4 + Math.random()*6, a: Math.random()*Math.PI*2,
      col: `hsl(${Math.random()*360},85%,60%)`
    });
  }
  const tEnd = performance.now()+ms;
  function step(ts){
    fxc.clearRect(0,0,fx.width,fx.height);
    const dt = 1/60;
    parts.forEach(p=>{
      p.vy += 800*dt; p.x += p.vx*dt; p.y += p.vy*dt; p.a += 6*dt;
      if(p.y>fx.height+20) { p.y=-10; p.vy=300+Math.random()*400; } // recycle
      fxc.save(); fxc.translate(p.x,p.y); fxc.rotate(p.a);
      fxc.fillStyle=p.col; fxc.fillRect(-p.s/2,-p.s/2,p.s,p.s);
      fxc.restore();
    });
    if(ts < tEnd) requestAnimationFrame(step); else fxc.clearRect(0,0,fx.width,fx.height);
  }
  requestAnimationFrame(step);
}
</script>