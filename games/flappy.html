<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Flappy (demo)</title>
<style>
  :root { --bg:#081228; --hud:#e5e7eb; --panel:#0f172a; --border:#27324a; --accent:#22d3ee; }
  *{ -webkit-tap-highlight-color:transparent }
  html,body,#game{height:100%;margin:0;background:var(--bg);touch-action:none;overscroll-behavior:none}
  canvas#game{display:block;width:100%;height:100%}
  .hud{position:fixed;top:10px;left:10px;color:var(--hud);font-family:system-ui}
  .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0b162c;margin-right:8px}
  .back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:5}
  .modal{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;min-width:min(90vw,460px)}
  .modal header{font-weight:800;margin-bottom:8px}
  .row{display:flex;gap:8px;justify-content:flex-end}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0b162c;color:var(--hud);cursor:pointer}
  .btn.primary{background:var(--accent);border:none;color:#001018;font-weight:800}
  canvas#fx{position:fixed;inset:0;pointer-events:none;z-index:4}
</style>

<canvas id="game"></canvas>
<canvas id="fx"></canvas>

<div class="hud">
  <span class="pill" id="pLbl">Waiting for playerâ€¦</span>
  <span class="pill" id="tLbl">Time: 0.0s</span>
</div>

<div class="back" id="endBack">
  <div class="modal">
    <header id="endTitle">Nice!</header>
    <div id="endMsg" style="opacity:.9;margin-bottom:6px"></div>
    <div class="row">
      <button class="btn" id="btnChange">Change players</button>
      <button class="btn" id="btnExit">Exit</button>
      <button class="btn primary" id="btnRematch">Rematch</button>
    </div>
  </div>
</div>

<script>
const post = (m)=>parent.postMessage(m,'*');
let PLAYER={id:'',name:'Player'};

window.addEventListener('message',(e)=>{
  if(e.data?.type==='fambam:players'){ const p=e.data.players?.[0]; if(p){ PLAYER=p; document.getElementById('pLbl').textContent='Player: '+PLAYER.name; start(); } }
});
post({type:'fambam:ready', gameId:'flappy'});

const cvs=document.getElementById('game'), ctx=cvs.getContext('2d',{alpha:false});
let w,h,tPrev=0,elapsed=0,running=false,y,vy,gravity=900,flap=-360,ground=0;

function size(){ const dpr=Math.max(1,devicePixelRatio||1); cvs.width=innerWidth*dpr; cvs.height=innerHeight*dpr; w=cvs.width; h=cvs.height; ground=h*0.85; }
addEventListener('resize', size, {passive:true}); size();

function start(){ running=true; elapsed=0; tPrev=performance.now(); y=h*0.45; vy=0; requestAnimationFrame(loop); }

function flapTap(ev){ if(ev&&ev.cancelable) ev.preventDefault(); if(running) vy = flap; }
addEventListener('pointerdown', flapTap, {passive:false});
addEventListener('mousedown',   flapTap, {passive:false});
addEventListener('touchstart',  flapTap, {passive:false});
addEventListener('keydown', (e)=>{ if(e.code==='Space') flapTap(e); });

function loop(ts){
  if(!running) return;
  const dt=Math.min(0.033,(ts-tPrev)/1000); tPrev=ts; elapsed+=dt;
  document.getElementById('tLbl').textContent='Time: '+elapsed.toFixed(1)+'s';

  vy += gravity*dt; y += vy*dt;
  if(y>ground){ y=ground; vy=0; return end(); }
  if(y<0){ y=0; vy=0; }

  ctx.fillStyle='#081228'; ctx.fillRect(0,0,w,h);
  const bx=w*0.3, rr=Math.max(18,Math.min(36,w/50));
  ctx.save(); ctx.translate(bx,y);
  ctx.fillStyle='#e5e7eb'; ctx.beginPath(); ctx.arc(0,0,rr,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(rr*0.25,-rr*0.2,rr*0.1,0,Math.PI*2); ctx.fill();
  ctx.restore();
  ctx.fillStyle='#0b1e3e'; ctx.fillRect(0,ground+rr,w,h-ground);
  requestAnimationFrame(loop);
}

// safety auto-end
setTimeout(()=>running && end(), 12000);

const back=document.getElementById('endBack'), fx=document.getElementById('fx'), fxc=fx.getContext('2d');
function end(){
  if(!running) return; running=false;
  const points=Math.max(0,Math.round(elapsed*10));
  post({type:'fambam:score', gameId:'flappy', scores:[{id:PLAYER.id,name:PLAYER.name,points}]});
  document.getElementById('endTitle').textContent='ðŸŽ‰ '+PLAYER.name+' scored '+points+'!';
  document.getElementById('endMsg').textContent='Great flight! Choose next action.';
  back.style.display='flex'; confetti(900);
}
document.getElementById('btnRematch').onclick=()=>{ back.style.display='none'; start(); };
document.getElementById('btnExit').onclick   =()=>{ back.style.display='none'; post({type:'fambam:end'}); };
document.getElementById('btnChange').onclick =()=>{ back.style.display='none'; post({type:'fambam:end'}); };

function confetti(ms){
  const dpr=Math.max(1,devicePixelRatio||1); fx.width=innerWidth*dpr; fx.height=innerHeight*dpr;
  const N=180, ps=[]; for(let i=0;i<N;i++) ps.push({x:Math.random()*fx.width,y:-20-Math.random()*200,vx:(Math.random()-.5)*400,vy:300+Math.random()*600,a:Math.random()*6,c:`hsl(${Math.random()*360},85%,60%)`,s:4+Math.random()*6});
  const tEnd=performance.now()+ms;
  (function step(ts){ fxc.clearRect(0,0,fx.width,fx.height);
    ps.forEach(p=>{ p.vy+=14; p.x+=p.vx/60; p.y+=p.vy/60; p.a+=.2; fxc.save(); fxc.translate(p.x,p.y); fxc.rotate(p.a); fxc.fillStyle=p.c; fxc.fillRect(-p.s/2,-p.s/2,p.s,p.s); fxc.restore(); });
    if(ts<tEnd) requestAnimationFrame(step); else fxc.clearRect(0,0,fx.width,fx.height);
  })(performance.now());
}
</script>