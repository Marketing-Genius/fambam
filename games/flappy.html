<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>Fambam · Flappy</title>

<!-- Basic theme boot (reads ui:theme from localStorage) -->
<script>
(function(){
  function apply(t){
    const mode=(t&&t.mode==='light')?'light':'dark';
    const accent=(t&&t.accent)||'#22d3ee';
    document.documentElement.setAttribute('data-theme',mode);
    document.documentElement.style.setProperty('--accent',accent);
    const meta=document.querySelector('meta[name="theme-color"]')||document.createElement('meta');
    meta.setAttribute('name','theme-color');
    meta.setAttribute('content', mode==='light' ? '#f2efe7' : '#0f172a');
    if(!meta.parentNode) document.head.appendChild(meta);
  }
  try{ apply(JSON.parse(localStorage.getItem('ui:theme')||'null')||{mode:'dark',accent:'#22d3ee'}); }catch{ apply({mode:'dark',accent:'#22d3ee'}); }
})();
</script>

<style>
:root{
  --panel:#111827; --text:#e5e7eb; --muted:#94a3b8;
  --chipBg:#0b1224; --chipBorder:#334155; --panelBorder:#0b1224;
}
html[data-theme="light"]{
  --panel:#f2efe7; --text:#0f1623; --muted:#556070;
  --chipBg:#fffdf7; --chipBorder:#e3ded4; --panelBorder:#e6e2da;
}
*{box-sizing:border-box}
html,body{height:100%; margin:0; overflow:hidden; background:#081228; color:var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
/* Header */
.topbar{
  position:fixed; inset:auto 0 0 0; top:0; height:48px; z-index:10;
  display:flex; align-items:center; gap:10px;
  background: color-mix(in oklab, var(--panel) 55%, transparent);
  backdrop-filter: blur(10px) saturate(1.1);
  -webkit-backdrop-filter: blur(10px) saturate(1.1);
  border-bottom:1px solid var(--panelBorder); padding:8px 10px;
}
.topbar .btn{ background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--text);
  border-radius:10px; padding:6px 10px; cursor:pointer; }
.topbar .title{ font-weight:800; margin-left:6px }
/* Canvas fills viewport underneath UI */
.stage{ position:fixed; inset:0; }
#c{ width:100%; height:100%; display:block; background:#081228; }
/* Center overlays */
.center{ position:fixed; inset:0; display:grid; place-items:center; z-index:20; }
.hidden{ display:none !important; }
/* Card */
.card{ width:min(560px,92vw); background:color-mix(in oklab, var(--panel) 60%, transparent);
  border:1px solid var(--panelBorder); border-radius:16px; padding:14px;
  backdrop-filter: blur(14px) saturate(1.1); -webkit-backdrop-filter: blur(14px) saturate(1.1); }
.card header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
.card .pill{ padding:6px 10px; border:1px solid var(--chipBorder); border-radius:999px; background:var(--chipBg); cursor:pointer; }
.card .pill[aria-pressed="true"]{ background:var(--accent); color:#001018; border-color:transparent; font-weight:800 }
.row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
.hr{ height:1px; background:var(--panelBorder); margin:8px 0 }
.small{ font-size:.9rem; color:var(--muted) }
/* Big on-screen hint */
.hint{ position:fixed; inset:auto 0 20% 0; text-align:center; z-index:5; opacity:.9; pointer-events:none; font-weight:700 }
/* Game over modal */
.actions .btn{ background:var(--chipBg); border:1px solid var(--chipBorder); color:var(--text);
  border-radius:10px; padding:8px 12px; cursor:pointer; }
.actions .btn.primary{ background:var(--accent); border:none; color:#001018; font-weight:800 }
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <button class="btn" id="btnBack">← Games</button>
  <div class="title">Flappy</div>
  <div class="small" id="who" style="margin-left:auto; opacity:.75">No player</div>
</div>

<!-- Game canvas -->
<div class="stage"><canvas id="c"></canvas></div>

<!-- Tap hint -->
<div class="hint small" id="tapHint">Tap / click / space to flap</div>

<!-- Player picker -->
<div class="center" id="picker">
  <div class="card">
    <header><div style="font-weight:800">Who’s playing?</div></header>
    <div id="kidPills" class="row"></div>
    <div class="row">
      <input id="nameInput" class="pill" placeholder="or type a name" style="flex:1;min-width:160px"/>
      <button id="startBtn" class="pill" style="font-weight:800">Start</button>
    </div>
    <div class="hr"></div>
    <div class="small">Tip: add kids in Family. This list reads <code>hub:family:kids</code> from this device.</div>
  </div>
</div>

<!-- Game over -->
<div class="center hidden" id="over">
  <div class="card">
    <header><div style="font-weight:800">Game Over</div><div class="small" id="overSub"></div></header>
    <div class="row actions">
      <button class="btn primary" id="btnAgain">Play again</button>
      <button class="btn" id="btnChange">Change player</button>
      <button class="btn" id="btnExit">Exit</button>
    </div>
  </div>
</div>

<script>
/* ---------------- Family + Storage helpers ---------------- */
const load=(k,f)=>{ try{ const v=JSON.parse(localStorage.getItem(k)); return v ?? f; }catch{ return f; } };
const save=(k,v)=>localStorage.setItem(k, JSON.stringify(v));
const uid = ()=>Math.random().toString(36).slice(2,10);
const LS_SCORES = 'gm:scores:flappy';
const Family = (()=>({
  getKids(){ return load('hub:family:kids',[])||[]; }
}))();

/* ---------------- UI wiring ---------------- */
const back = document.getElementById('btnBack');
back.onclick = ()=> location.href = '../games.html';

let player = { id:'', name:'' };

function paintPills(){
  const wrap = document.getElementById('kidPills'); wrap.innerHTML='';
  Family.getKids().filter(k=>k.enabled!==false).forEach(k=>{
    const b=document.createElement('button'); b.className='pill'; b.textContent=k.name;
    b.onclick=()=>{ player={id:k.id||k.name||uid(), name:k.name||'Player'}; selectDone(); };
    wrap.appendChild(b);
  });
}
function selectDone(){
  document.getElementById('picker').classList.add('hidden');
  document.getElementById('who').textContent = player.name;
  startGame();
}
document.getElementById('startBtn').onclick=()=>{
  const s=(document.getElementById('nameInput').value||'').trim();
  if(!s){ alert('Type a name or pick a kid.'); return; }
  player={id:uid(), name:s}; selectDone();
};

/* ---------------- Canvas + Game ---------------- */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let W=0,H=0, DPR=1;
function resize(){
  DPR = Math.min(window.devicePixelRatio||1, 2);
  W = canvas.clientWidth;
  H = canvas.clientHeight;
  canvas.width = Math.floor(W*DPR);
  canvas.height = Math.floor(H*DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener('resize', resize, {passive:true});

/* Prevent page scroll during game on iOS */
addEventListener('touchmove', e=>{ e.preventDefault(); }, {passive:false});
addEventListener('gesturestart', e=>{ e.preventDefault(); }, {passive:false});

/* Game state */
let running=false, started=false, t0=0, last=0, score=0, bird, pipes=[], spawnT=0;

function reset(){
  score=0; pipes=[]; spawnT=0;
  bird={ x: W*0.28, y: H*0.45, vy:0, r: 14 };
}
function startGame(){
  resize(); reset(); running=true; started=false; t0=performance.now(); last=t0;
  document.getElementById('tapHint').classList.remove('hidden');
  requestAnimationFrame(loop);
}
function flap(){
  started=true;
  bird.vy = -5.2; // flap strength
}
function loop(ts){
  if(!running) return;
  const dt = Math.min(0.03, (ts-last)/1000); last=ts;
  // physics
  if(started){
    bird.vy += 14 * dt;     // gravity
    bird.y  += bird.vy;
    spawnT += dt;
    if(spawnT > 1.2){ spawnPipe(); spawnT=0; }
    movePipes(dt);
  }
  // collisions
  if(collide()){
    return gameOver();
  }
  // draw
  draw();
  requestAnimationFrame(loop);
}

function spawnPipe(){
  const gap = Math.max(120, Math.min(220, H*0.28));
  const topMin = 60, topMax = H - gap - 60;
  const y = Math.floor(Math.random()*(topMax-topMin))+topMin;
  const w = 60, x = W+20, speed = Math.max(120, Math.min(220, W*0.25));
  pipes.push({x, w, top:y, bot:y+gap, speed, passed:false});
  // keep list small
  if(pipes.length>10) pipes.shift();
}
function movePipes(dt){
  for(const p of pipes){
    p.x -= p.speed * dt;
    if(!p.passed && p.x + p.w < bird.x - bird.r){
      p.passed=true; score++;
    }
  }
  // drop off-screen
  while(pipes.length && pipes[0].x + pipes[0].w < -40) pipes.shift();
}
function collide(){
  // ground / ceiling
  if(bird.y - bird.r < 0 || bird.y + bird.r > H) return true;
  // pipes
  for(const p of pipes){
    if(bird.x + bird.r > p.x && bird.x - bird.r < p.x + p.w){
      if(bird.y - bird.r < p.top || bird.y + bird.r > p.bot) return true;
    }
  }
  return false;
}
function draw(){
  // sky
  ctx.fillStyle = '#081228';
  ctx.fillRect(0,0,W,H);
  // subtle stars
  ctx.fillStyle = 'rgba(255,255,255,.08)';
  for(let i=0;i<40;i++){ const x=(i*97)%W, y=(i*57)%H; ctx.fillRect(x,y,1,1); }
  // pipes
  for(const p of pipes){
    ctx.fillStyle = '#0aa1b4';
    ctx.fillRect(p.x, 0, p.w, p.top);
    ctx.fillRect(p.x, p.bot, p.w, H-p.bot);
    // lips
    ctx.fillStyle = '#19c6db';
    ctx.fillRect(p.x-2, p.top-10, p.w+4, 6);
    ctx.fillRect(p.x-2, p.bot+4,  p.w+4, 6);
  }
  // bird
  ctx.fillStyle = '#ffd166';
  ctx.beginPath(); ctx.arc(bird.x, bird.y, bird.r, 0, Math.PI*2); ctx.fill();
  ctx.fillStyle = '#333';
  ctx.beginPath(); ctx.arc(bird.x+6, bird.y-4, 3, 0, Math.PI*2); ctx.fill();
  // score
  ctx.fillStyle = '#e5e7eb';
  ctx.font = '700 28px system-ui, sans-serif';
  ctx.textAlign='center';
  ctx.fillText(String(score), W/2, 42);
  if(!started){
    ctx.font = '600 16px system-ui, sans-serif';
    ctx.fillStyle='rgba(229,231,235,.8)';
    ctx.fillText('Tap to start', W/2, H/2 - 20);
  }
}

/* Input */
function onTap(e){ e&&e.preventDefault(); flap(); document.getElementById('tapHint').classList.add('hidden'); }
addEventListener('mousedown', onTap);
addEventListener('touchstart', onTap, {passive:false});
addEventListener('keydown', (e)=>{ if(e.code==='Space' || e.code==='ArrowUp') onTap(e); });

/* Game over */
function gameOver(){
  running=false;
  // persist score
  try{
    const arr = load(LS_SCORES, []);
    arr.unshift({
      id: uid(),
      ts: Date.now(),
      players: [{id: player.id, name: player.name}],
      scores: [{id: player.id, name: player.name, points: Number(score)}],
      meta: {}
    });
    save(LS_SCORES, arr);
  }catch{}
  document.getElementById('overSub').textContent = `${player.name} scored ${score}`;
  document.getElementById('over').classList.remove('hidden');
}

/* Over buttons */
document.getElementById('btnAgain').onclick = ()=>{ document.getElementById('over').classList.add('hidden'); startGame(); };
document.getElementById('btnChange').onclick= ()=>{ document.getElementById('over').classList.add('hidden'); document.getElementById('picker').classList.remove('hidden'); };
document.getElementById('btnExit').onclick  = ()=>{ location.href = '../games.html'; };

/* Boot */
paintPills();
document.getElementById('picker').classList.remove('hidden');
resize();
</script>
</body>
</html>