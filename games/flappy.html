<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Flappy (demo)</title>

<style>
  :root { --bg:#081228; --hud:#e5e7eb; --panel:#0f172a; --border:#27324a; --accent:#22d3ee; }
  * { -webkit-tap-highlight-color: transparent; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--hud);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  /* absolutely critical for iOS so taps donâ€™t scroll: */
  html,body,#game{ touch-action:none; overscroll-behavior:none; }

  canvas#game{display:block;width:100%;height:100%}
  .hud{position:fixed;top:10px;left:10px;display:flex;gap:10px;align-items:center}
  .hud .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0b162c}

  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:5}
  .modal{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;min-width:min(90vw,460px)}
  .modal header{font-weight:800;margin-bottom:8px}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#0b162c;color:var(--hud);cursor:pointer}
  .btn.primary{background:var(--accent);border:none;color:#001018;font-weight:800}
  .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

  canvas#fx{position:fixed;inset:0;pointer-events:none;z-index:4}
</style>

<canvas id="game"></canvas>
<canvas id="fx"></canvas>

<div class="hud">
  <div class="pill" id="title">Flappy (demo)</div>
  <div class="pill" id="playerHint">Waiting for playersâ€¦</div>
  <div class="pill" id="time">Time: 0.0s</div>
</div>

<div class="backdrop" id="endBack">
  <div class="modal">
    <header id="endTitle">Nice!</header>
    <div id="endMsg" style="opacity:.9;margin-bottom:6px"></div>
    <div class="row">
      <button class="btn" id="btnChange">Change players</button>
      <button class="btn" id="btnExit">Exit</button>
      <button class="btn primary" id="btnRematch">Rematch</button>
    </div>
  </div>
</div>

<script>
/* ---------- protocol ---------- */
const post = (m)=>parent.postMessage(m,'*');
let PLAYER = { id:'', name:'Player' };

window.addEventListener('message',(e)=>{
  if(e.data?.type==='fambam:players'){
    const p=e.data.players?.[0];
    if(p){ PLAYER=p; document.getElementById('playerHint').textContent='Player: '+PLAYER.name; start(); }
  }
});
post({type:'fambam:ready', gameId:'flappy'});

/* ---------- tiny flappy ---------- */
const cvs=document.getElementById('game'), ctx=cvs.getContext('2d',{alpha:false});
let w,h, tPrev=0, elapsed=0, running=false;
let y, vy, gravity=900, flap=-340, ground=0;

function size(){
  const dpr = Math.max(1, devicePixelRatio||1);
  cvs.width = innerWidth*dpr; cvs.height = innerHeight*dpr;
  w=cvs.width; h=cvs.height; ground = h*0.85;
  ctx.setTransform(1,0,0,1,0,0);
}
addEventListener('resize', size, {passive:true}); size();

function start(){
  running=true; elapsed=0; tPrev=performance.now();
  y = h*0.45; vy=0;
  requestAnimationFrame(loop);
}

function flapTap(ev){
  // stop the page from scrolling
  if(ev && ev.cancelable) ev.preventDefault();
  if(!running) return;
  vy = flap;
}
// accept mouse, touch, and pointer (iOS best practice)
addEventListener('pointerdown', flapTap, {passive:false});
addEventListener('mousedown',   flapTap, {passive:false});
addEventListener('touchstart',  flapTap, {passive:false});
addEventListener('keydown', (e)=>{ if(e.code==='Space') flapTap(e); });

function loop(t){
  if(!running) return;
  const dt = Math.min(0.033, (t - tPrev)/1000); tPrev = t;
  elapsed += dt;
  document.getElementById('time').textContent = 'Time: ' + elapsed.toFixed(1) + 's';

  vy += gravity*dt; y += vy*dt;
  if(y > ground){ y = ground; vy = 0; return end(); }
  if(y < 0){ y = 0; vy = 0; }

  // draw
  ctx.fillStyle='#081228'; ctx.fillRect(0,0,w,h);
  // bird
  const bx = w*0.3, r = Math.max(18, Math.min(36, w/50));
  ctx.save(); ctx.translate(bx, y);
  ctx.fillStyle='#e5e7eb'; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#000'; ctx.beginPath(); ctx.arc(r*0.25,-r*0.2,r*0.1,0,Math.PI*2); ctx.fill();
  ctx.restore();
  // ground
  ctx.fillStyle='#0b1e3e'; ctx.fillRect(0, ground+r, w, h-ground);

  requestAnimationFrame(loop);
}

// round auto-ends at 12s, too (guarantees a score)
setTimeout(()=>running && end(), 12000);

function end(){
  if(!running) return;
  running=false;
  const points = Math.max(0, Math.round(elapsed*10));
  post({type:'fambam:score', gameId:'flappy', scores:[{id:PLAYER.id,name:PLAYER.name,points}]});
  showEnd(points);
}

/* ---------- end modal + confetti ---------- */
const back = document.getElementById('endBack');
const fx = document.getElementById('fx'), fxc = fx.getContext('2d');

function showEnd(points){
  document.getElementById('endTitle').textContent = 'ðŸŽ‰ '+PLAYER.name+' scored '+points+'!';
  document.getElementById('endMsg').textContent = 'Great flight! Choose what to do next.';
  back.style.display='flex';
  confetti(1000);
}
document.getElementById('btnRematch').onclick=()=>{ back.style.display='none'; start(); };
document.getElementById('btnExit').onclick   =()=>{ back.style.display='none'; post({type:'fambam:end'}); };
document.getElementById('btnChange').onclick =()=>{ back.style.display='none'; post({type:'fambam:end'}); };

function confetti(ms){
  const dpr=Math.max(1,devicePixelRatio||1);
  fx.width=innerWidth*dpr; fx.height=innerHeight*dpr;
  const N=180, parts=[];
  for(let i=0;i<N;i++){
    parts.push({x:Math.random()*fx.width, y:-20-Math.random()*fx.height*0.3,
      vx:(Math.random()-0.5)*400, vy:300+Math.random()*600,
      s:4+Math.random()*6, a:Math.random()*Math.PI*2, col:`hsl(${Math.random()*360},85%,60%)`});
  }
  const tEnd=performance.now()+ms;
  (function step(ts){
    fxc.clearRect(0,0,fx.width,fx.height);
    parts.forEach(p=>{
      p.vy+=14; p.x+=p.vx/60; p.y+=p.vy/60; p.a+=0.2;
      if(p.y>fx.height+20) { p.y=-10; p.vy=300+Math.random()*400; }
      fxc.save(); fxc.translate(p.x,p.y); fxc.rotate(p.a);
      fxc.fillStyle=p.col; fxc.fillRect(-p.s/2,-p.s/2,p.s,p.s); fxc.restore();
    });
    if(ts<tEnd) requestAnimationFrame(step); else fxc.clearRect(0,0,fx.width,fx.height);
  })(performance.now());
}
</script>