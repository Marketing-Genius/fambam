<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam · Family</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Fambam">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<link rel="stylesheet" href="wallpaper.css">
<script src="wallpaper.js"></script>   <!-- no defer -->
<link rel="stylesheet" href="fambam.css">

<!-- Tiny page-scoped styles for the tree layout -->
<style>
  .family-tree .row{display:flex;justify-content:center;gap:14px;flex-wrap:wrap}
  .family-tree{ padding: 10px 0; }
  .family-tree .row + .row{ margin-top: 12px; } /* extra air between parents & kids rows */
  .family-tree .tree-connect{height:16px}
  .family-tree .card{
    display:flex;align-items:center;gap:10px;
    background:var(--card);border:1px solid var(--panelBorder);
    border-radius:16px;padding:12px;color:var(--text);text-decoration:none
  }
  .family-tree .face{
    width:64px;height:64px;border-radius:50%;overflow:hidden;
    display:grid;place-items:center;background:var(--chipBg);
    border:2px solid var(--chipBorder);font-weight:800;font-size:24px
  }
  .family-tree .face img{width:100%;height:100%;object-fit:cover}
  .family-tree .name{font-weight:800}
  .family-tree .badge{
    margin-left:auto;background:var(--previewBg);
    border:1px solid var(--previewBorder);border-radius:999px;
    padding:4px 8px;font-size:.85rem;color:var(--muted)
  }
</style>

<!-- Theme boot (kept) -->
<script>
(function () {
  var DARK_SRC='fambam.png', LIGHT_SRC='fambam2.png';
  function findLogo(){ return document.getElementById('logoImg')||document.querySelector('.brand img')||document.querySelector('img[alt="Fambam"]'); }
  function swap(mode){ var logo=findLogo(); if(!logo) return;
    var cur=logo.getAttribute('src')||'', next=/fambam2?\.png$/i.test(cur)
      ? cur.replace(/fambam2?\.png$/i, mode==='light'?'fambam2.png':'fambam.png')
      : (mode==='light'?LIGHT_SRC:DARK_SRC);
    logo.setAttribute('src', next);
    var a=logo.closest('a'); if(a && !a.getAttribute('href')) a.setAttribute('href','./index.html');
  }
  function apply(t){
    var mode=(t&&t.mode==='light')?'light':'dark', accent=(t&&t.accent)||'#22d3ee';
    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.style.setProperty('--accent', accent);
    var meta=document.querySelector('meta[name="theme-color"]');
    if(meta) meta.setAttribute('content', mode==='light' ? '#f2efe7' : '#0f172a');
    swap(mode); document.addEventListener('DOMContentLoaded', function(){ swap(mode); }, {once:true});
  }
  try{ apply(JSON.parse(localStorage.getItem('ui:theme')||'null')||{mode:'dark',accent:'#22d3ee'}); }catch{ apply({mode:'dark',accent:'#22d3ee'}); }
  window.addEventListener('storage', function(e){ if(e.key==='ui:theme'){ try{ apply(JSON.parse(e.newValue||'{}')); }catch{} }});
})();
</script>

<script>
/* HEADER FLOAT BOOT (reads ui:headerFloat) */
(function headerBoot(){
  function apply(){
    try{
      const on = JSON.parse(localStorage.getItem('ui:headerFloat') || 'false') ? true : false;
      document.body && document.body.classList.toggle('header-float', on);
    }catch(_){}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', apply, {once:true});
  } else {
    apply();
  }
  // live-sync if changed elsewhere (e.g., Admin on Home)
  window.addEventListener('storage', (e)=>{
    if (e.key === 'ui:headerFloat') apply();
  });
})();
</script>
</head>

<body class="page-family">
  <div class="app">
    <header class="panel header app-header">
      <a href="./index.html" class="brand" title="Home">
        <img src="fambam.png" alt="Fambam">
      </a>
      <div class="title">Family</div>
    </header>

    <!-- Family tree (parents row, connector, kids row) -->
    <section class="family-tree">
      <div style="font-weight:800; text-align:center">Family</div>
      <div id="treeParents" class="row"></div>
      <div class="tree-connect" aria-hidden="true"></div>
      <div id="treeKids" class="row"></div>
    </section>

    <footer>
      Works offline. Data stays on this device (local only).
      <div class="version">Family v1.2 — tree layout</div>
    </footer>
  </div>

<script src="family.js?v=3.3.6"></script>
<script>
/* Fallback Family store if family.js isn't present */
if(!window.Family){
  (function(){
    const K={kids:'hub:family:kids',parents:'hub:family:parents'};
    const load=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{ return f}};
    window.Family={ getKids(){return load(K.kids,[])}, getParents(){return load(K.parents,[])} };
  })();
}

/* Helpers */
const $=(s,e=document)=>e.querySelector(s);
const Prof={ key:(id)=>`prof:${id}`, load(id){ try{return JSON.parse(localStorage.getItem(this.key(id)))||{}}catch{return{}} } };
function initials(n){const p=(n||'').trim();return p? p[0].toUpperCase():'?';}

function ageFor(person){
  // Prefer birthday stored on the Family record; fall back to profile blob
  const src = (person?.birthday || Prof.load(person?.id||'').birthday || '').trim();
  if (!src) return null;

  let y, m, d;
  if (/^\d{4}-\d{2}-\d{2}$/.test(src)) {
    [y,m,d] = src.split('-').map(Number);
  } else {
    const m1 = src.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})/);
    if (!m1) return null;
    m = +m1[1]; d = +m1[2];
    const yy = m1[3];
    y = (yy.length === 2) ? +(yy > '50' ? `19${yy}` : `20${yy}`) : +yy;
  }

  const now = new Date();
  const b = new Date(y, m-1, d);
  if (isNaN(b)) return null;

  let age = now.getFullYear() - y;
  if (now.getMonth() < b.getMonth() || (now.getMonth() === b.getMonth() && now.getDate() < b.getDate())) age--;
  return (age >= 0 && age < 140) ? age : null;
}

function cardHTML(person, roleLabel){
  const prof   = Prof.load(person.id||'');
  const accent = prof.accent || '';
  const pid    = person.id || '';
  const age    = ageFor(person);
  const badge  = roleLabel + (age != null ? ` • ${age}` : '');
  const face   = person.photo
      ? `<img src="${person.photo}" alt="${(person.name||'Member').replace(/"/g,'&quot;')}">`
      : `<span aria-hidden="true">${initials(person.name)}</span>`;

  return `
  <a class="card"
     href="${pid ? ('./profile.html#' + encodeURIComponent(pid)) : '#'}"${pid ? '' : ' aria-disabled="true"'}>
    <div class="face" style="${accent ? `border-color:${accent}` : ''}">${face}</div>
    <div class="name">${person.name || 'Member'}</div>
    <div class="badge">${badge}</div>
  </a>
`;
}

function renderFamilyTree(){
  const parents = (Family.getParents?.()||[]);
  const kids    = (Family.getKids?.()||[]).filter(k=>k.enabled!==false);

  const pWrap = document.getElementById('treeParents');
  const kWrap = document.getElementById('treeKids');
  if(!pWrap || !kWrap) return;

  pWrap.innerHTML = parents.length
    ? parents.map(p=>cardHTML(p,'Parent')).join('')
    : `<div class="small" style="opacity:.7">No parents yet.</div>`;

  kWrap.innerHTML = kids.length
    ? kids.map(k=>cardHTML(k,'Kid')).join('')
    : `<div class="small" style="opacity:.7">No kids yet. Add them in Admin.</div>`;
}

document.addEventListener('DOMContentLoaded', renderFamilyTree);

window.addEventListener('storage', (e)=>{
  if (/^hub:family:(parents|kids)$/.test(e.key||'') || /^prof:/.test(e.key||'')) {
    renderFamilyTree();
  }
});

/* SW */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
</script>
</body>
</html>
