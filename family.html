<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam · Family</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Fambam">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<link rel="stylesheet" href="wallpaper.css">
<script src="wallpaper.js" defer></script>

<!-- Shared styles -->
<link rel="stylesheet" href="fambam.css">

<script>
/* Wallpaper boot: read saved image + overlay/shift and apply CSS vars */
(function bootWallpaper(){
  try{
    // 1) Image (data URL persisted by the picker)
    const dataUrl = localStorage.getItem('hub:wallpaper:dataurl');
    if (dataUrl) {
      document.documentElement.style.setProperty('--wallpaper-image', `url("${dataUrl}")`);
    }

    // 2) Overlay + shift (ui:wallpaper object)
    const cfg = JSON.parse(localStorage.getItem('ui:wallpaper') || '{}');
    if (cfg.shift) {
      document.documentElement.style.setProperty('--wallpaper-shift', String(cfg.shift));
    }
    const ov = cfg.overlay;
    if (ov) {
      if (ov.type === 'solid' && ov.color) {
        document.documentElement.style.setProperty('--wp-overlay', ov.color);
      } else if (ov.type === 'gradient' && ov.start && ov.end) {
        const angle = Number(ov.angle ?? 180);
        document.documentElement.style.setProperty('--wp-overlay', `linear-gradient(${angle}deg, ${ov.start}, ${ov.end})`);
      }
      if (typeof ov.opacity === 'number') {
        document.documentElement.style.setProperty('--wp-overlay-opacity', String(ov.opacity));
      }
    }

    // 3) React live when Home changes settings
    window.addEventListener('storage', (e)=>{
      if (e.key === 'hub:wallpaper:dataurl' && e.newValue) {
        document.documentElement.style.setProperty('--wallpaper-image', `url("${e.newValue}")`);
      }
      if (e.key === 'ui:wallpaper') {
        try{
          const next = JSON.parse(e.newValue || '{}');
          if (next.shift) {
            document.documentElement.style.setProperty('--wallpaper-shift', String(next.shift));
          }
          const o = next.overlay || {};
          if (o.type === 'solid' && o.color) {
            document.documentElement.style.setProperty('--wp-overlay', o.color);
          } else if (o.type === 'gradient' && o.start && o.end) {
            const ang = Number(o.angle ?? 180);
            document.documentElement.style.setProperty('--wp-overlay', `linear-gradient(${ang}deg, ${o.start}, ${o.end})`);
          }
          if (typeof o.opacity === 'number') {
            document.documentElement.style.setProperty('--wp-overlay-opacity', String(o.opacity));
          }
        }catch(_){}
      }
    });
  }catch(_){}
})();
</script>

<!-- Theme boot (kept) -->
<script>
(function () {
  var DARK_SRC='fambam.png', LIGHT_SRC='fambam2.png';
  function findLogo(){ return document.getElementById('logoImg')||document.querySelector('.brand img')||document.querySelector('img[alt="Fambam"]'); }
  function swap(mode){ var logo=findLogo(); if(!logo) return;
    var cur=logo.getAttribute('src')||'', next=/fambam2?\.png$/i.test(cur)
      ? cur.replace(/fambam2?\.png$/i, mode==='light'?'fambam2.png':'fambam.png')
      : (mode==='light'?LIGHT_SRC:DARK_SRC);
    logo.setAttribute('src', next);
    var a=logo.closest('a'); if(a && !a.getAttribute('href')) a.setAttribute('href','./index.html');
  }
  function apply(t){
    var mode=(t&&t.mode==='light')?'light':'dark', accent=(t&&t.accent)||'#22d3ee';
    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.style.setProperty('--accent', accent);
    var meta=document.querySelector('meta[name="theme-color"]');
    if(meta) meta.setAttribute('content', mode==='light' ? '#f2efe7' : '#0f172a');
    swap(mode); document.addEventListener('DOMContentLoaded', function(){ swap(mode); }, {once:true});
  }
  try{ apply(JSON.parse(localStorage.getItem('ui:theme')||'null')||{mode:'dark',accent:'#22d3ee'}); }catch{ apply({mode:'dark',accent:'#22d3ee'}); }
  window.addEventListener('storage', function(e){ if(e.key==='ui:theme'){ try{ apply(JSON.parse(e.newValue||'{}')); }catch{} }});
})();
</script>
  
</head>
<body class="page-family">
  <div class="app">
    <header class="panel">
      <a href="./index.html" class="brand" title="Home">
        <img src="fambam.png" alt="Fambam">
      </a>
      <div class="title">Family</div>
    </header>

    <section id="grid" class="grid"></section>

    <footer>
      Works offline. Data stays on this device (local only).
      <div class="version">Family v1.1 — theme-ready</div>
    </footer>
  </div>

<script src="family.js?v=3.3.6"></script>
<script>
if(!window.Family){
  (function(){
    const K={kids:'hub:family:kids',parents:'hub:family:parents'};
    const load=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))??f}catch{ return f}};
    window.Family={ getKids(){return load(K.kids,[])}, getParents(){return load(K.parents,[])} };
  })();
}

const $=(s,e=document)=>e.querySelector(s);
const Prof={ key:(id)=>`prof:${id}`, load(id){ try{return JSON.parse(localStorage.getItem(this.key(id)))||{}}catch{return{}} } };
function initials(n){const p=(n||'').trim();return p? p[0].toUpperCase():'?';}

function render(){
  const grid = $('#grid'); grid.innerHTML='';
  const parents = (Family.getParents?.()||[]).slice().sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  const kids = (Family.getKids?.()||[]).filter(k=>k.enabled!==false).slice().sort((a,b)=>(a.name||'').localeCompare(b.name||''));
  const people = [
    ...parents.map(p=>({...p, kind:'parent'})),
    ...kids.map(k=>({...k, kind:'kid'}))
  ];

  if (!people.length){
    grid.innerHTML = `<div class="panel" style="grid-column:1/-1; text-align:center; opacity:.8">
      No family members yet. Open <b>Admin Settings → Parents/Kids</b> to add some.
    </div>`;
    return;
  }

  people.forEach(p=>{
    const prof = Prof.load(p.id||'');
    const accent = prof.accent || '';
    const pid = p.id || '';
    const a = document.createElement('a');
    a.href = pid ? `./profile.html#${encodeURIComponent(pid)}` : 'javascript:void(0)';
    a.className='card';
    a.innerHTML = `
      <div class="face" style="${accent ? `border-color:${accent}` : ''}">
        ${p.photo
          ? `<img src="${p.photo}" alt="${(p.name||'Member').replace(/"/g,'&quot;')}">`
          : `<span aria-hidden="true">${initials(p.name)}</span>`}
      </div>
      <div class="name">${p.name||'Member'}</div>
      <div class="badge" aria-label="${p.kind==='kid'?'Kid':'Parent'}">${p.kind==='kid'?'Kid':'Parent'}</div>
    `;
    a.setAttribute('aria-disabled', pid ? 'false' : 'true');
    grid.appendChild(a);
  });
}

render();

/* SW */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
</script>
</body>
</html>
