<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Fambam ¬∑ Store</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.webmanifest">

<!-- Shared wallpaper + app styles -->
<link rel="stylesheet" href="wallpaper.css">
<link rel="stylesheet" href="fambam.css">
<script src="wallpaper.js" defer></script>

<!-- THEME BOOT (mode + accent + auto logo swap) -->
<script>
(function () {
  var DARK_SRC='fambam.png', LIGHT_SRC='fambam2.png';
  function findLogo(){
    return document.getElementById('logoImg')
        || document.querySelector('.brand img')
        || document.querySelector('img[alt="Fambam"]')
        || null;
  }
  function applyTheme(t){
    var mode=(t&&t.mode==='light')?'light':'dark';
    var accent=(t&&t.accent)||'#22d3ee';
    document.documentElement.setAttribute('data-theme', mode);
    document.documentElement.style.setProperty('--accent', accent);
    var meta=document.querySelector('meta[name="theme-color"]');
    if(meta) meta.setAttribute('content', mode==='light'?'#f2efe7':'#0f172a');
    var logo=findLogo();
    if(logo){
      var url=new URL(logo.src, location.href);
      var base=url.pathname.replace(/[^/]+$/,'');
      logo.src = (mode==='light') ? (base+LIGHT_SRC) : (base+DARK_SRC);
      var a=logo.closest('a'); if(a && !a.getAttribute('href')) a.setAttribute('href','./index.html');
    }
  }
  try{ applyTheme(JSON.parse(localStorage.getItem('ui:theme')||'{}')); }
  catch{ applyTheme({mode:'dark',accent:'#22d3ee'}); }
  addEventListener('storage', e=>{ if(e.key==='ui:theme') try{applyTheme(JSON.parse(e.newValue||'{}'))}catch{}; });
})();
</script>

<style>
/* ---------- Store page (scoped) ---------- */
.page-store .app{
  max-width:1100px; margin:0 auto; padding:20px;
  display:grid; gap:16px; grid-template-rows:auto auto 1fr auto;
}

/* Top bar */
.page-store .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.page-store .kidpick{display:flex;align-items:center;gap:10px}

/* Layout */
.page-store .grid{display:grid;gap:14px;grid-template-columns:1fr 360px}
@media(max-width:960px){.page-store .grid{grid-template-columns:1fr}}
.page-store .section-title{font-weight:800;margin-bottom:8px}

/* Store grid */
.page-store .store{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(max-width:700px){.page-store .store{grid-template-columns:1fr}}
.page-store .item{display:grid;gap:8px;background:var(--card);border:1px solid var(--panelBorder);border-radius:14px;padding:12px}
.page-store .item .hd{display:flex;align-items:center;justify-content:space-between;gap:8px}
.page-store .item .name{font-weight:800}
.page-store .item .cost{font-weight:700}

/* Sidebar */
.page-store .side{display:grid;gap:10px}
.page-store .card{background:var(--panel);border:1px solid var(--panelBorder);border-radius:14px;padding:12px}
.page-store .row{display:flex;align-items:center;justify-content:space-between}

/* Modal */
.page-store .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000;padding:20px}
.page-store .modal{width:min(900px,100%);max-height:90vh;display:flex;flex-direction:column;background:var(--panel);border:1px solid var(--panelBorder);border-radius:16px;box-shadow:var(--shadow)}
.page-store .modal header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--panelBorder);position:sticky;top:0;background:inherit}
.page-store .modal .body{padding:12px 14px;display:grid;gap:12px;overflow:auto;max-height:70vh}
.page-store .modal .footer{padding:12px 14px;border-top:1px solid var(--panelBorder);display:flex;justify-content:space-between;gap:10px}
.page-store .input{background:var(--card);border:1px solid var(--panelBorder);border-radius:12px;padding:8px 10px;color:var(--text);font:inherit}
.page-store .list{display:grid;gap:8px}
.page-store .rowx{display:grid;grid-template-columns:1fr 120px auto;gap:8px;align-items:center;background:var(--card);border:1px solid var(--panelBorder);border-radius:12px;padding:8px}

/* Pending list */
.page-store .pending{display:grid;gap:10px}
.page-store .pending-item{display:grid;gap:8px;background:var(--card);border:1px solid var(--panelBorder);border-radius:12px;padding:10px}

/* Keep header/menu above panels */
.page-store header.panel{position:relative;z-index:1000}
.page-store .menu-wrap{position:relative;z-index:1001}
.page-store .menu-dd{z-index:1002}
</style>

<script>
/* HEADER FLOAT BOOT (reads ui:headerFloat) */
(function headerBoot(){
  function apply(){
    try{
      const on = JSON.parse(localStorage.getItem('ui:headerFloat') || 'false') ? true : false;
      document.body && document.body.classList.toggle('header-float', on);
    }catch(_){}
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', apply, {once:true});
  } else {
    apply();
  }
  // live-sync if changed elsewhere (e.g., Admin on Home)
  window.addEventListener('storage', (e)=>{
    if (e.key === 'ui:headerFloat') apply();
  });
})();
</script>
  
</head>

<body class="page-store">
  <div class="app">
    <!-- Shared header -->
    <header class="panel header app-header">
      <a href="./index.html" class="brand" title="Home">
        <img id="logoImg" src="fambam.png" alt="Fambam">
      </a>
      <div class="title">
        <div class="big">Store</div>
        <div class="small">Redeem points for rewards. Parents approve redemptions.</div>
      </div>
      <div class="menu-wrap">
        <button id="btnMenu" class="hamburger" aria-haspopup="true" aria-expanded="false">‚ò∞</button>
        <div id="menuDD" class="menu-dd" role="menu" aria-hidden="true">
          <button class="mi" data-action="admin">Admin Settings</button>
          <button class="mi" data-action="pending">Pending Redemptions</button>
          <button class="mi" data-action="seed">Load Default Items</button>
          <button class="mi" data-action="about">About</button>
        </div>
      </div>
    </header>

    <!-- Kid selector / status -->
    <section class="panel topbar">
      <div class="kidpick">
        <label for="kidSel" class="small">Child</label>
        <select id="kidSel" class="select"></select>
      </div>
      <div class="row" style="gap:10px">
        <div id="ptsBadge" class="badge">‚Äî pts</div>
        <div id="lvlBadge" class="badge">Lv ‚Äî</div>
        <div id="infoBadge" class="badge">Monthly season</div>
      </div>
    </section>

    <section class="grid">
      <!-- Storefront -->
      <div class="panel">
        <div class="section-title">Rewards</div>
        <div id="store" class="store"></div>
        <div class="small" style="margin-top:6px">Tap ‚ÄúRedeem‚Äù to request an item. A parent will approve it.</div>
      </div>

      <!-- Sidebar -->
      <aside class="side">
        <div class="card">
          <div class="section-title">Your Activity</div>
          <div class="row"><div class="small">Pending requests</div><div id="cntPending" class="small">0</div></div>
          <div class="row"><div class="small">Approved this month</div><div id="cntApproved" class="small">0</div></div>
        </div>
        <div class="card">
          <div class="section-title">Pending (yours)</div>
          <div id="myPending" class="pending"></div>
        </div>
      </aside>
    </section>

    <div class="small" style="opacity:.8;text-align:center">
      Works offline. Data stays on this device (local only).
    </div>
  </div>

  <!-- Admin Settings -->
  <div class="modal-backdrop" id="adminModal" aria-hidden="true" role="dialog" aria-labelledby="adminTitle">
    <div class="modal">
      <header>
        <div id="adminTitle" style="font-weight:800">Admin Settings</div>
        <button id="adminClose" class="btn">‚úñ</button>
      </header>
      <div class="body">
        <div style="font-weight:700">Store Items</div>
        <div id="itemList" class="list"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="newEmoji" class="input" placeholder="üòÄ" style="width:84px">
          <input id="newName" class="input" placeholder="Item name (e.g., Extra Screen Time)">
          <input id="newCost" class="input" placeholder="Cost" type="number" min="1" style="width:140px">
          <button id="addItem" class="btn-primary">Add</button>
        </div>
        <div class="small">Tip: Use emoji to make items fun. Edit costs inline.</div>
      </div>
      <div class="footer">
        <div><button id="seedDefaults" class="btn">Seed Defaults</button></div>
        <div><button id="adminDone" class="btn">Done</button></div>
      </div>
    </div>
  </div>

  <!-- Pending Modal (all kids) -->
  <div class="modal-backdrop" id="pendingModal" aria-hidden="true" role="dialog" aria-labelledby="pendingTitle">
    <div class="modal">
      <header>
        <div id="pendingTitle" style="font-weight:800">Pending Redemptions</div>
        <button id="pendingClose" class="btn">‚úñ</button>
      </header>
      <div class="body" id="pendingBody"></div>
      <div class="footer">
        <div class="small">Approve to deduct points (monthly & all-time).</div>
        <div><button id="pendingDone" class="btn">Done</button></div>
      </div>
    </div>
  </div>

  <!-- Family store -->
  <script src="family.js?v=3.3.6"></script>
  <script>
  if(!window.Family){
    (function(){
      const K={kids:'hub:family:kids'};
      const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
      window.Family={ getKids(){ return load(K.kids,[]); }, getActiveKids(){ return this.getKids().filter(k=>k.enabled!==false);} };
    })();
  }
  </script>

<script>
/* ---------- Storage keys ---------- */
const STORE_ITEMS='store:items';    // [{id,emoji,name,cost}]
const STORE_ORDERS='store:orders';  // [{id,kidId,itemId,label,cost,ts,status}]

/* Points system keys (reusing from points) */
const PTS_BAL='pts:balances';
const PTS_LED='pts:ledger';
const PTS_MBAL = (m)=>`pts:balances:${m}`;

/* Utilities */
const $=(s,e=document)=>e.querySelector(s), $$=(s,e=document)=>[...e.querySelectorAll(s)];
const load=(k,f)=>{try{const v=JSON.parse(localStorage.getItem(k));return v??f;}catch{return f}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uid=()=>Math.random().toString(36).slice(2,10);
function monthId(d=new Date()){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
const CURRENT_MONTH = monthId();
const LEVEL_STRIDE = 50;
function levelFor(points){ return Math.floor((+points||0)/LEVEL_STRIDE); }
const initials=n=>((n||'?').trim()[0]||'?').toUpperCase();

/* Profiles (future use) */
const Prof = { key:id=>`prof:${id}`, load(id){ try{return JSON.parse(localStorage.getItem(this.key(id)))||{}}catch{return{}} } };

/* Data access */
function kids(){ try{ return (Family.getActiveKids&&Family.getActiveKids())||[]; }catch{ return []; } }

function allTimeBalances(){ return load(PTS_BAL, {}); }
function setAllTimeBalances(b){ save(PTS_BAL,b); }

function monthBalances(mid=CURRENT_MONTH){ return load(PTS_MBAL(mid), {}); }
function setMonthBalances(b, mid=CURRENT_MONTH){ save(PTS_MBAL(mid), b); }

function ledger(){ return load(PTS_LED, []); }
function setLedger(a){ save(PTS_LED,a); }

function items(){ return load(STORE_ITEMS, []); }
function setItems(a){ save(STORE_ITEMS, a); }

function orders(){ return load(STORE_ORDERS, []); }
function setOrders(a){ save(STORE_ORDERS, a); }

/* Seed defaults */
function seedDefaults(){
  if(items().length) return;
  setItems([
    {id:uid(), emoji:'üïπÔ∏è', name:'Extra screen time (1 hr)', cost:500},
    {id:uid(), emoji:'üíé', name:'Robux (500)', cost:1000},
    {id:uid(), emoji:'üçï', name:'Choose Friday family meal', cost:600},
    {id:uid(), emoji:'üç∞', name:'Choose dessert (any dinner)', cost:400},
    {id:uid(), emoji:'üé¨', name:'Go to the movies', cost:2000},
    {id:uid(), emoji:'üéÆ', name:'New game night pick', cost:800}
  ]);
}

/* Apply delta (deduct on approval) */
function applyDelta(kidId, delta, reason, source='store'){
  delta = Number(delta)||0; if(!delta) return;
  const all = allTimeBalances(); all[kidId]=(all[kidId]||0)+delta; setAllTimeBalances(all);
  const mb  = monthBalances();   mb[kidId]=(mb[kidId]||0)+delta;  setMonthBalances(mb);
  const a   = ledger();          a.push({id:uid(), kidId, delta, reason:reason||'', ts:Date.now(), source}); setLedger(a);
}

/* State */
let currentKidId=null;

/* Render: top bar */
function renderTop(){
  const sel=$('#kidSel'); sel.innerHTML='';
  const list=kids();
  list.forEach(k=>{ const o=document.createElement('option'); o.value=k.id; o.textContent=k.name; sel.appendChild(o); });
  if(currentKidId) sel.value=currentKidId;
  if(!sel.value && list[0]) sel.value=list[0].id;
  currentKidId = sel.value || null;

  const mb=monthBalances(); const pts=+(mb[currentKidId]||0);
  $('#ptsBadge').textContent = `${pts} pts`;
  $('#lvlBadge').textContent = `Lv ${levelFor(pts)}`;

  renderStore();
  renderMyPending();
  renderSidebarCounts();
}

/* Render: store grid */
function renderStore(){
  const wrap=$('#store'); wrap.innerHTML='';
  const list=items();
  const mb=monthBalances(); const pts=+(mb[currentKidId]||0);

  if(!list.length){
    wrap.innerHTML='<div class="small">No items yet. Parents can add items in Admin Settings.</div>';
    return;
  }

  list.forEach(it=>{
    const can = pts>=it.cost;
    const div=document.createElement('div'); div.className='item';
    div.innerHTML=`
      <div class="hd">
        <div class="name">${it.emoji||'üéÅ'} ${it.name}</div>
        <div class="cost">${it.cost} pts</div>
      </div>
      <div class="small">Requires approval</div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn-primary" ${can?'':'disabled'} data-redeem="${it.id}">Redeem</button>
      </div>
    `;
    div.querySelector('[data-redeem]')?.addEventListener('click', ()=>{
      if(!currentKidId) return alert('Choose a child first.');
      const order={ id:uid(), kidId:currentKidId, itemId:it.id, label:it.name, cost:it.cost, ts:Date.now(), status:'pending' };
      setOrders( orders().concat([order]) );
      renderMyPending(); renderSidebarCounts();
      alert('Redemption request sent for approval.');
    });
    wrap.appendChild(div);
  });
}

/* Render: my pending list */
function renderMyPending(){
  const wrap=$('#myPending'); wrap.innerHTML='';
  if(!currentKidId){ wrap.innerHTML='<div class="small">Choose a child.</div>'; return; }
  const mine=orders().filter(o=>o.kidId===currentKidId && o.status==='pending').sort((a,b)=>b.ts-a.ts);
  if(!mine.length){ wrap.innerHTML='<div class="small">No pending requests.</div>'; return; }
  mine.forEach(o=>{
    const div=document.createElement('div'); div.className='pending-item';
    const when=new Date(o.ts).toLocaleString();
    div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
      <div><b>${o.label}</b><div class="small">${when}</div></div>
      <div class="badge">${o.cost} pts</div>
    </div>`;
    wrap.appendChild(div);
  });
}

/* Sidebar counts */
function renderSidebarCounts(){
  const mineAll = orders().filter(o=>o.kidId===currentKidId);
  $('#cntPending').textContent  = mineAll.filter(o=>o.status==='pending').length;
  const midStart = new Date(CURRENT_MONTH + '-01T00:00:00');
  const approveThisMonth = mineAll.filter(o=>o.status==='approved' && o.ts>=midStart.getTime()).length;
  $('#cntApproved').textContent = approveThisMonth;
}

/* ---------- Admin: items ---------- */
const adminModal=$('#adminModal');
function show(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
function hide(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
$('#adminClose').onclick=()=>hide(adminModal);
$('#adminDone').onclick =()=>hide(adminModal);
$('#seedDefaults').onclick=()=>{ seedDefaults(); buildAdminList(); renderStore(); };

function openAdmin(){ buildAdminList(); show(adminModal); }

function buildAdminList(){
  const wrap=$('#itemList'); wrap.innerHTML='';
  const list=items();
  if(!list.length){ wrap.innerHTML='<div class="small">No items yet ‚Äî add some below or ‚ÄúSeed Defaults‚Äù.</div>'; }
  list.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='rowx';
    row.innerHTML=`
      <input class="input" value="${it.emoji||''}" style="width:84px">
      <input class="input" value="${it.name}">
      <div style="display:flex;gap:8px;align-items:center">
        <input class="input" value="${it.cost}" type="number" min="1" style="width:120px">
        <button class="btn" data-del>Remove</button>
      </div>
    `;
    const [emEl, nmEl] = row.querySelectorAll('input');
    const costEl = row.querySelectorAll('input')[2];

    emEl.oninput = ()=>{ const a=items(); a[idx].emoji=emEl.value; setItems(a); renderStore(); };
    nmEl.oninput = ()=>{ const a=items(); a[idx].name =nmEl.value; setItems(a); renderStore(); };
    costEl.onchange=()=>{ const a=items(); a[idx].cost = Math.max(1, parseInt(costEl.value||'1',10)); setItems(a); renderStore(); };

    row.querySelector('[data-del]').onclick=()=>{ const a=items(); a.splice(idx,1); setItems(a); buildAdminList(); renderStore(); };

    wrap.appendChild(row);
  });

  $('#addItem').onclick=()=>{
    const emoji = ($('#newEmoji').value||'').trim() || 'üéÅ';
    const name  = ($('#newName').value||'').trim();
    const cost  = Math.max(1, parseInt(($('#newCost').value||'0'),10));
    if(!name) return alert('Enter a name.');
    const a=items(); a.push({id:uid(), emoji, name, cost}); setItems(a);
    $('#newEmoji').value=''; $('#newName').value=''; $('#newCost').value='';
    buildAdminList(); renderStore();
  };
}

/* ---------- Pending modal (all kids) ---------- */
const pendingModal=$('#pendingModal');
$('#pendingClose').onclick=()=>hide(pendingModal);
$('#pendingDone').onclick =()=>hide(pendingModal);

function openPending(){
  const body=$('#pendingBody'); body.innerHTML='';
  const list=orders().filter(o=>o.status==='pending').sort((a,b)=>a.ts-b.ts);
  if(!list.length){ body.innerHTML='<div class="small">No pending redemptions.</div>'; show(pendingModal); return; }

  const kmap=new Map(kids().map(k=>[k.id,k]));
  list.forEach(o=>{
    const kid=kmap.get(o.kidId);
    const div=document.createElement('div'); div.className='pending-item';
    const when=new Date(o.ts).toLocaleString();
    div.innerHTML=`
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:34px;height:34px;border-radius:50%;background:var(--card);border:1px solid var(--panelBorder);display:grid;place-items:center;overflow:hidden">
            ${kid?.photo?`<img src="${kid.photo}" style="width:100%;height:100%;object-fit:cover">`:`<span style="font-weight:800">${initials(kid?.name)}</span>`}
          </div>
          <div><b>${kid?.name||'Unknown'}</b><div class="small">${when}</div></div>
        </div>
        <div class="badge">${o.cost} pts</div>
      </div>
      <div class="small">${o.label}</div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn-primary" data-approve>Approve</button>
        <button class="btn" data-reject>Reject</button>
      </div>
    `;
    div.querySelector('[data-approve]').onclick=()=>{
      const mb=monthBalances(); const pts=+(mb[o.kidId]||0);
      if(pts < o.cost){ alert('Not enough points to approve.'); return; }
      applyDelta(o.kidId, -o.cost, `Redeemed: ${o.label}`, 'store');
      const arr=orders(); const idx=arr.findIndex(x=>x.id===o.id); if(idx>=0){ arr[idx].status='approved'; setOrders(arr); }
      openPending(); renderTop();
    };
    div.querySelector('[data-reject]').onclick=()=>{
      const arr=orders(); const idx=arr.findIndex(x=>x.id===o.id); if(idx>=0){ arr[idx].status='rejected'; setOrders(arr); }
      openPending(); renderTop();
    };
    body.appendChild(div);
  });
  show(pendingModal);
}

/* ---------- Hamburger (shared classes) ---------- */
(function menu(){
  const btn=document.getElementById('btnMenu'), dd=document.getElementById('menuDD');
  const open=()=>{dd.classList.add('open');btn.setAttribute('aria-expanded','true');dd.setAttribute('aria-hidden','false');};
  const close=()=>{dd.classList.remove('open');btn.setAttribute('aria-expanded','false');dd.setAttribute('aria-hidden','true');};
  btn.addEventListener('click',e=>{e.stopPropagation(); dd.classList.contains('open')?close():open();});
  document.addEventListener('click',e=>{ if(!dd.contains(e.target)&&e.target!==btn) close(); });
  dd.addEventListener('click',e=>{
    const a=e.target.closest('.mi'); if(!a) return; close();
    const act=a.dataset.action;
    if(act==='admin') openAdmin();
    else if(act==='pending') openPending();
    else if(act==='seed'){ seedDefaults(); renderStore(); alert('Defaults loaded.'); }
    else if(act==='about'){ alert('Kids can request items; parents approve in Pending. On approval, points are deducted from monthly and all-time, and the ledger records the redemption. Items & requests are stored locally.'); }
  });
})();

/* ---------- Wires ---------- */
document.getElementById('kidSel').onchange = ()=>{ currentKidId = document.getElementById('kidSel').value || null; renderTop(); };

/* ---------- Boot ---------- */
(function init(){
  const all=allTimeBalances(); const mb=monthBalances();
  kids().forEach(k=>{ if(typeof all[k.id]!=='number') all[k.id]=0; if(typeof mb[k.id]!=='number') mb[k.id]=0; });
  setAllTimeBalances(all); setMonthBalances(mb);
  renderTop();
})();
</script>
</body>
</html>
